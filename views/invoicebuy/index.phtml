<script type="text/javascript" src="https://cdn.datatables.net/1.10.15/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.10.15/js/dataTables.bootstrap.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.15/css/dataTables.bootstrap.min.css">

<?php
$url_order = 'ASC';
if ($order_by == 'invoice_buy_id')
    $url_order = $order == 'ASC' ? 'DESC' : 'ASC';
elseif ($order_by == 'invoice_buy_number')
    $url_order = $order == 'ASC' ? 'DESC' : 'ASC';
elseif ($order_by == 'invoice_buy_date')
    $url_order = $order == 'ASC' ? 'DESC' : 'ASC';

    $i = $sonews*$page-($sonews-1);

?>

<div id="loading"></div>
<div id="winpopup"></div>
<section class="content-header">
    <h1>MUA HÀNG NHẬP KHO</h1>
  <ol class="breadcrumb">
    <li><a href="<?php echo $this->url('admin') ?>"><i class="fa fa-dashboard"></i> Home</a></li>
    <li class="active"><a href="<?php echo $this->url('invoicebuy') ?>">Hàng nhập kho</a></li>
  </ol>
</section>
<div id="content" style="padding:5px;">

    <div class="search-box">
        
        <input type="search" id="search-input" name="s" value="<?php echo isset($keyword)?$keyword:null; ?>" placeholder="Tìm kiếm">
        <input type="button" name="" id="search-submit" class="button-search" value="Tìm kiếm" onclick="searchall('<?php echo $page ?>','<?php echo $order_by ?>','<?php echo $order ?>');">
        <?php if(!isset($disable_control)){ ?>
        <div class="add-box"><a class="add_button" id="btnExport" ><i class="fa fa-download"></i> Xuất</a></div>
        <div class="add-box"><a class="add_button" id="import_excel" href="<?= $this->url('invoicebuy/import')?>"><i class="fa fa-upload"></i> Nhập</a></div>
        <div class="add-box"><a class="add_button" onClick="add_click();"><i class="fa fa-plus"></i> Thêm mới</a></div>
        <?php } ?>
    </div>
    <div class="tablenav top">
        <?php if(!isset($disable_control)){ ?>
        <div class="alignleft actions">
            <select name="action" id="action">
                <option value="-1" selected="selected">Chọn</option>
                
                <option value="delete">Xóa</option>
            </select>
            <input type="button" name="" id="doaction" class="button action" value="Áp dụng" onclick="action();">
        </div>
        <?php } ?>
        <div class="alignleft actions">
        <select name="m" id="chonloc">
          <option  value="18446744073709">Hiển thị tất cả</option>
          <option value="50">Hiển thị 50 giá trị</option>
                <option value="100">Hiển thị 100 giá trị</option>
                <option value="150">Hiển thị 150 giá trị</option>
                <option selected="selected" value="200">Hiển thị 200 giá trị</option>
        </select>
        <input type="button" name="" id="post-query-submit" class="button" value="Chọn lọc" onclick="searchall('<?php echo $page ?>','<?php echo $order_by ?>','<?php echo $order ?>');">                               
        </div>

      </div>

</div>


<table class="table_data" id="tblExport">
<thead>
    <tr>
        <th class="fix"><input type="checkbox" onclick="checkall('checkbox', this)" name="checkall"/></th>
        <th  class="fix" >
            <a class="sort <?php echo $order ?>" onclick="sapxep('<?php echo $page ?>','invoice_buy_id','<?php echo $url_order ?>')">STT <?php if ($order_by == 'invoice_buy_id'): ?><i class="icon-chevron-<?php echo $url_order == 'ASC' ? 'down' : 'up' ?>"></i><?php endif; ?></a>
        </th>
        <th  class="fix">
            <a class="sort <?php echo $order ?>" onclick="sapxep('<?php echo $page ?>','invoice_buy_document_number','<?php echo $url_order ?>')">Số CT <?php if ($order_by == 'invoice_buy_document_number'): ?><i class="icon-chevron-<?php echo $url_order == 'ASC' ? 'down' : 'up' ?>"></i><?php endif; ?></a>
        </th>
        <th  class="fix">
            <a class="sort <?php echo $order ?>" onclick="sapxep('<?php echo $page ?>','invoice_buy_document_date','<?php echo $url_order ?>')">Ngày CT <?php if ($order_by == 'invoice_buy_document_date'): ?><i class="icon-chevron-<?php echo $url_order == 'ASC' ? 'down' : 'up' ?>"></i><?php endif; ?></a>
        </th>
        <th  class="fix">
            <a class="sort <?php echo $order ?>" onclick="sapxep('<?php echo $page ?>','invoice_buy_number','<?php echo $url_order ?>')">Số HĐ <?php if ($order_by == 'invoice_buy_number'): ?><i class="icon-chevron-<?php echo $url_order == 'ASC' ? 'down' : 'up' ?>"></i><?php endif; ?></a>
        </th>
        <th  class="fix">
            <a class="sort <?php echo $order ?>" onclick="sapxep('<?php echo $page ?>','invoice_buy_date','<?php echo $url_order ?>')">Ngày HĐ <?php if ($order_by == 'invoice_buy_date'): ?><i class="icon-chevron-<?php echo $url_order == 'ASC' ? 'down' : 'up' ?>"></i><?php endif; ?></a>
        </th>
        <th  class="fix">
            <a class="sort <?php echo $order ?>" onclick="sapxep('<?php echo $page ?>','invoice_buy_comment','<?php echo $url_order ?>')">Nội dung <?php if ($order_by == 'invoice_buy_comment'): ?><i class="icon-chevron-<?php echo $url_order == 'ASC' ? 'down' : 'up' ?>"></i><?php endif; ?></a>
        </th>
        <th  class="fix">
            <a class="sort <?php echo $order ?>" onclick="sapxep('<?php echo $page ?>','customer_name','<?php echo $url_order ?>')">NCC <?php if ($order_by == 'customer_name'): ?><i class="icon-chevron-<?php echo $url_order == 'ASC' ? 'down' : 'up' ?>"></i><?php endif; ?></a>
        </th>
        <th  class="fix">
            <a class="sort <?php echo $order ?>" onclick="sapxep('<?php echo $page ?>','invoice_buy_number_total','<?php echo $url_order ?>')">Số lượng <?php if ($order_by == 'invoice_buy_number_total'): ?><i class="icon-chevron-<?php echo $url_order == 'ASC' ? 'down' : 'up' ?>"></i><?php endif; ?></a>
        </th>
        <th  class="fix">
            <a class="sort <?php echo $order ?>" onclick="sapxep('<?php echo $page ?>','invoice_buy_money','<?php echo $url_order ?>')">Tiền hàng <?php if ($order_by == 'invoice_buy_money'): ?><i class="icon-chevron-<?php echo $url_order == 'ASC' ? 'down' : 'up' ?>"></i><?php endif; ?></a>
        </th>
        <th  class="fix">
            <a class="sort <?php echo $order ?>" onclick="sapxep('<?php echo $page ?>','invoice_buy_discount','<?php echo $url_order ?>')">Chiết khấu <?php if ($order_by == 'invoice_buy_discount'): ?><i class="icon-chevron-<?php echo $url_order == 'ASC' ? 'down' : 'up' ?>"></i><?php endif; ?></a>
        </th>
        <th  class="fix">
            <a class="sort <?php echo $order ?>" onclick="sapxep('<?php echo $page ?>','invoice_buy_tax_vat','<?php echo $url_order ?>')">Thuế GTGT <?php if ($order_by == 'invoice_buy_tax_vat'): ?><i class="icon-chevron-<?php echo $url_order == 'ASC' ? 'down' : 'up' ?>"></i><?php endif; ?></a>
        </th>
        <th  class="fix">
            <a class="sort <?php echo $order ?>" onclick="sapxep('<?php echo $page ?>','invoice_buy_tax_import','<?php echo $url_order ?>')">Thuế NK <?php if ($order_by == 'invoice_buy_tax_import'): ?><i class="icon-chevron-<?php echo $url_order == 'ASC' ? 'down' : 'up' ?>"></i><?php endif; ?></a>
        </th>
        <th  class="fix">
            <a class="sort <?php echo $order ?>" onclick="sapxep('<?php echo $page ?>','invoice_buy_custom_cost','<?php echo $url_order ?>')">Phí trước HQ <?php if ($order_by == 'invoice_buy_custom_cost'): ?><i class="icon-chevron-<?php echo $url_order == 'ASC' ? 'down' : 'up' ?>"></i><?php endif; ?></a>
        </th>
        <th  class="fix">
            <a class="sort <?php echo $order ?>" onclick="sapxep('<?php echo $page ?>','invoice_buy_other_cost','<?php echo $url_order ?>')">Phí về kho <?php if ($order_by == 'invoice_buy_other_cost'): ?><i class="icon-chevron-<?php echo $url_order == 'ASC' ? 'down' : 'up' ?>"></i><?php endif; ?></a>
        </th>
        <th  class="fix">
            <a class="sort <?php echo $order ?>" onclick="sapxep('<?php echo $page ?>','invoice_buy_money','<?php echo $url_order ?>')">Tổng cộng <?php if ($order_by == 'invoice_buy_money'): ?><i class="icon-chevron-<?php echo $url_order == 'ASC' ? 'down' : 'up' ?>"></i><?php endif; ?></a>
        </th>
        <?php if(!isset($disable_control)){ ?>
        <th class="fix"></th>
        <?php } ?>
    </tr>
    
   </thead>
   <tbody>
    <?php $tong=0; $tongtien=0; $tongck=0; $tongvat=0; $tongnk=0; $tongcp=0; $tongcpkhac=0;$tongsl=0;
    foreach ($invoice_buys as $invoice_buy) : 
      $tien = $invoice_buy->invoice_buy_money-$invoice_buy->invoice_buy_discount+$invoice_buy->invoice_buy_tax_import+$invoice_buy->invoice_buy_other_cost+$invoice_buy->invoice_buy_custom_cost;
      $tongtien += $invoice_buy->invoice_buy_money;
      $tongck += $invoice_buy->invoice_buy_discount;
      $tongvat += $invoice_buy->invoice_buy_tax_vat;
      $tongnk += $invoice_buy->invoice_buy_tax_import;
      $tongcp += $invoice_buy->invoice_buy_custom_cost;
      $tongcpkhac += $invoice_buy->invoice_buy_other_cost;
      $tong += $tien;
      $tongsl += $invoice_buy->invoice_buy_number_total;
    ?>
        <tr onClick="HighLightTR(this,'#4d90fe','cc3333');" id="<?php echo $invoice_buy->invoice_buy_id ?>" class="edit_tr" >
            
            <td>
                <input name="check[]" type="checkbox" class="checkbox" value="<?php echo $invoice_buy->invoice_buy_id ?>">
            </td>
            
            <td  class="fix"><?php echo $i++; ?></td>
            <td class="fix" id="invoice_buy_document_number_<?php echo $invoice_buy->invoice_buy_id; ?>"><?php echo $invoice_buy->invoice_buy_document_number; ?></td>
            <td class="fix" id="invoice_buy_document_date_<?php echo $invoice_buy->invoice_buy_id; ?>"><?php echo $lib->hien_thi_ngay_thang($invoice_buy->invoice_buy_document_date); ?></td>
            <td class="fix" id="invoice_buy_number_<?php echo $invoice_buy->invoice_buy_id; ?>"><?php echo $invoice_buy->invoice_buy_number; ?></td>
            <td class="fix" id="invoice_buy_date_<?php echo $invoice_buy->invoice_buy_id; ?>"><?php echo $lib->hien_thi_ngay_thang($invoice_buy->invoice_buy_date); ?></td>
            <td class="fix" id="invoice_buy_comment_<?php echo $invoice_buy->invoice_buy_id; ?>"><?php echo $invoice_buy->invoice_buy_comment; ?></td>
            <td class="fix" data="<?php echo $invoice_buy->invoice_buy_customer; ?>" id="invoice_buy_customer_<?php echo $invoice_buy->invoice_buy_id; ?>"><?php echo $invoice_buy->customer_name; ?></td>
            <td class="fix text-right" id="invoice_buy_number_total_<?php echo $invoice_buy->invoice_buy_id; ?>"><?php echo $lib->formatMoney($invoice_buy->invoice_buy_number_total); ?></td>
            <td class="fix text-right" id="invoice_buy_money_<?php echo $invoice_buy->invoice_buy_id; ?>"><?php echo $lib->formatMoney($invoice_buy->invoice_buy_money); ?></td>
            <td class="fix text-right" id="invoice_buy_discount_<?php echo $invoice_buy->invoice_buy_id; ?>"><?php echo $lib->formatMoney($invoice_buy->invoice_buy_discount); ?></td>
            <td class="fix text-right" id="invoice_buy_tax_vat_<?php echo $invoice_buy->invoice_buy_id; ?>"><?php echo $lib->formatMoney($invoice_buy->invoice_buy_tax_vat); ?></td>
            <td class="fix text-right" id="invoice_buy_tax_import_<?php echo $invoice_buy->invoice_buy_id; ?>"><?php echo $lib->formatMoney($invoice_buy->invoice_buy_tax_import); ?></td>
            <td class="fix text-right" id="invoice_buy_custom_cost_<?php echo $invoice_buy->invoice_buy_id; ?>"><?php echo $lib->formatMoney($invoice_buy->invoice_buy_custom_cost); ?></td>
            <td class="fix text-right" id="invoice_buy_other_cost_<?php echo $invoice_buy->invoice_buy_id; ?>"><?php echo $lib->formatMoney($invoice_buy->invoice_buy_other_cost); ?></td>
            <td class="fix text-right" id="invoice_buy_total_<?php echo $invoice_buy->invoice_buy_id; ?>"><?php echo $lib->formatMoney($tien); ?></td>
            <td style="display:none" class="fix" id="customer_company_<?php echo $invoice_buy->invoice_buy_id; ?>"><?php echo $invoice_buy->customer_company; ?></td>
            <td style="display:none" class="fix" id="customer_mst_<?php echo $invoice_buy->invoice_buy_id; ?>"><?php echo $invoice_buy->customer_mst; ?></td>
            <td style="display:none" class="fix" id="customer_address_<?php echo $invoice_buy->invoice_buy_id; ?>"><?php echo $invoice_buy->customer_address; ?></td>
            
            <td style="display:none" class="fix" id="invoice_buy_additional_date_<?php echo $invoice_buy->invoice_buy_id; ?>"><?php echo date('d/m/Y',$invoice_buy->invoice_buy_additional_date); ?></td>
            <td style="display:none" class="fix" id="invoice_buy_bill_number_<?php echo $invoice_buy->invoice_buy_id; ?>"><?php echo $invoice_buy->invoice_buy_bill_number; ?></td>
            <td style="display:none" class="fix" id="invoice_buy_contract_number_<?php echo $invoice_buy->invoice_buy_id; ?>"><?php echo $invoice_buy->invoice_buy_contract_number; ?></td>
            <td style="display:none" class="fix" id="invoice_buy_origin_doc_<?php echo $invoice_buy->invoice_buy_id; ?>"><?php echo $invoice_buy->invoice_buy_origin_doc; ?></td>
            <td style="display:none" class="fix" id="invoice_buy_money_type_<?php echo $invoice_buy->invoice_buy_id; ?>"><?php echo $invoice_buy->invoice_buy_money_type; ?></td>
            <td style="display:none" class="fix" id="invoice_buy_money_rate_<?php echo $invoice_buy->invoice_buy_id; ?>"><?php echo $invoice_buy->invoice_buy_money_rate; ?></td>
            <td style="display:none" class="fix" id="invoice_buy_symbol_<?php echo $invoice_buy->invoice_buy_id; ?>"><?php echo $invoice_buy->invoice_buy_symbol; ?></td>
            <td style="display:none" class="fix" id="invoice_buy_allocation_<?php echo $invoice_buy->invoice_buy_id; ?>"><?php echo $invoice_buy->invoice_buy_allocation; ?></td>
            <td style="display:none" class="fix" id="invoice_buy_allocation2_<?php echo $invoice_buy->invoice_buy_id; ?>"><?php echo $invoice_buy->invoice_buy_allocation2; ?></td>
            <td style="display:none" class="fix" id="invoice_buy_money_foreign_<?php echo $invoice_buy->invoice_buy_id; ?>"><?php echo $lib->formatMoney($invoice_buy->invoice_buy_money_foreign,true); ?></td>
            
            <?php if(!isset($disable_control)){ ?>
            <td class="fix text-right">
                <i class="fa fa-edit edit_invoice" title="Sửa" data="<?php echo $invoice_buy->invoice_buy_id ?>"></i>
                <i class="fa fa-trash" onclick="del(<?php echo $invoice_buy->invoice_buy_id ?>)"></i>
            </td>
            <?php } ?>
        </tr>


    <?php endforeach; ?>
        <tr style="font-weight:bold">
          <td colspan="8" class="fix">Tổng cộng</td>
          <td  class="fix text-right"><?php echo $lib->formatMoney($tongsl); ?></td>
          <td  class="fix text-right"><?php echo $lib->formatMoney($tongtien); ?></td>
          <td  class="fix text-right"><?php echo $lib->formatMoney($tongck); ?></td>
          <td  class="fix text-right"><?php echo $lib->formatMoney($tongvat); ?></td>
          <td  class="fix text-right"><?php echo $lib->formatMoney($tongnk); ?></td>
          <td  class="fix text-right"><?php echo $lib->formatMoney($tongcp); ?></td>
          <td  class="fix text-right"><?php echo $lib->formatMoney($tongcpkhac); ?></td>
          <td  class="fix text-right"><?php echo $lib->formatMoney($tong); ?></td>
          <td  class="fix text-right"></td>
        </tr>
     
   </tbody>
</table>
<?php
$this->helper('slidePaginator');
?>
<div id="add_new_item">
  <table>
    <tr>
      <td>Danh mục</td>
      <td>
        <select id="items_type"  name="items_type" >
          <option value="1">Vật tư hàng hóa</option>
        </select>
      </td>
    </tr>
    <tr>
      <td>Mã vật tư</td>
      <td><input  type="text" id="items_code"  name="items_code"></td>
    </tr>
    <tr>
      <td>Tên vật tư</td>
      <td><input  type="text" id="items_name"  name="items_name"></td>
    </tr>
    <tr>
      <td>Đơn vị tính</td>
      <td><input   type="text" id="items_unit"  name="items_unit"></td>
    </tr>
    <tr>
      <td>Thuế suất</td>
      <td><input   type="text" id="items_tax"  name="items_tax"></td>
    </tr>
    <tr>
      <td>Hệ số <i class="fa fa-question-circle" title="Hệ số được áp dụng khi phân bổ chi phí, doanh thu.."></i></td>
      <td><input   type="text" id="items_stuff"  name="items_stuff"></td>
    </tr>
  </table>
  <input type="hidden" id="rowIndex_item">
</div>
<div id="show_item"></div>
<div id="show_service_buy"></div>
<div id="show_service_buy2"></div>
<div class="add-field">
      <div class="row">
        <!-- left column -->
        <div class="col-md-12">
          <!-- general form elements -->
          <div class="box box-primary">
            <!-- /.box-header -->
            <!-- form start -->
            <form id="add_invoice_buy" role="form" method="post" action="" enctype="multipart/form-data">
              <div class="row">
                <div class="col-md-8 col-xs-6">
                  <fieldset class="groupbox">
                    <legend class="nopadding"><span><h6>Thông tin chung</h3></span></legend>
                    <div class="box-body nopadding">
                      <div class="form-group col-xs-3 nopadding">
                        <label for="invoice_buy_bill_number">Đơn hàng số</label>
                        <button type="button" style="margin-top: -10px;" class="btn" id="get_bill_number"><i class="fa fa-search"></i></button>
                        <input style="width:100px" type="text" id="invoice_buy_bill_number"  name="invoice_buy_bill_number" tabindex="1" autocomplete="off" autofocus >
                        
                      </div>
                      <div class="form-group col-xs-3 nopadding">
                        <label for="invoice_buy_contract_number">Hợp đồng số</label>
                        <button type="button" style="margin-top: -10px;" class="btn" id="get_contract_number"><i class="fa fa-search"></i></button>
                        <input style="width:100px" type="text" id="invoice_buy_contract_number"  name="invoice_buy_contract_number" tabindex="2" autocomplete="off" >
                        
                      </div>
                    </div>
                    <div class="box-body nopadding">
                      <div class="form-group nopadding">
                        <label for="invoice_buy_customer">Nhà cung cấp </label>
                        <button type="button" style="margin-top: -10px;" class="btn" id="get_customer" onClick="javascript:window.open('<?php echo $this->url('supplier') ?>','_blank','location=yes,height=600,width=750,scrollbars=yes,status=yes')"><i class="fa fa-search"></i></button>
                        <input style="width:20%" type="text" id="invoice_buy_customer"  name="invoice_buy_customer" tabindex="3"  required="required" placeholder="Mã NCC" autocomplete="off" >
                        <ul id="customer_list_id"></ul>
                        <input style="width:65%" type="text" id="customer_company"  name="customer_company" tabindex="4"  required="required" placeholder="Tên NCC" autocomplete="off" >
                      </div>
                    </div>
                    <div class="box-body nopadding">
                      <div class="form-group col-xs-3 nopadding">
                        <label for="customer_mst">Mã số thuế </label>
                        <input style="width:90%" type="text" id="customer_mst"  name="customer_mst" tabindex="5" autocomplete="off" >
                      </div>
                      <div class="form-group col-xs-9 nopadding">
                        <label for="customer_address">Địa chỉ </label>
                        <input style="width:90%" type="text" id="customer_address"  name="customer_address" tabindex="6" autocomplete="off" >
                      </div>
                    </div>
                    <div class="box-body nopadding">
                      <div class="form-group nopadding">
                        <label for="invoice_buy_comment">Diễn giải </label>
                        <input style="width:93%" type="text" id="invoice_buy_comment"  name="invoice_buy_comment" tabindex="7"  required="required" autocomplete="off" >
                      </div>
                    </div>
                    <div class="box-body nopadding">
                      <div class="form-group nopadding">
                        <label for="invoice_buy_comment">Kèm theo </label>
                        <input style="width:70%" type="text" id="invoice_buy_origin_doc"  name="invoice_buy_origin_doc" tabindex="8"autocomplete="off" > chứng từ gốc
                      </div>
                    </div>
                  </fieldset>
                  
                  <!-- /.box-body -->
                  
                </div>
                <div class="col-md-4 col-xs-6">
                  <fieldset class="groupbox">
                    <legend class="nopadding"><span><h6>Chứng từ</h3></span></legend>
                    <div class="box-body nopadding">
                      <div class="form-group col-xs-4 nopadding">
                        <label for="invoice_buy_document_date">Ngày chứng từ </label>
                      </div>
                      <div class="form-group col-xs-8 nopadding">
                        <input type="text" class="date_mask" data-inputmask="'alias': 'dd/mm/yyyy'" data-mask id="invoice_buy_document_date"  name="invoice_buy_document_date" tabindex="9" required="required" autocomplete="off" >
                      </div>
                    </div>
                    <div class="box-body nopadding">
                      <div class="form-group col-xs-4 nopadding">
                        <label for="invoice_buy_additional_date">Ngày hạch toán </label>
                      </div>
                      <div class="form-group col-xs-8 nopadding">
                        <input type="text" class="date_mask" data-inputmask="'alias': 'dd/mm/yyyy'" data-mask id="invoice_buy_additional_date"  name="invoice_buy_additional_date" tabindex="10" required="required" autocomplete="off" >
                      </div>
                    </div>
                    <div class="box-body nopadding">
                      <div class="form-group col-xs-4 nopadding">
                        <label for="invoice_buy_document_number">Số chứng từ </label>
                      </div>
                      <div class="form-group col-xs-8 nopadding">
                        <input type="text" id="invoice_buy_document_number"  name="invoice_buy_document_number" tabindex="11" required="required" autocomplete="off" >
                      </div>
                    </div>
                    <div class="box-body nopadding">
                      <div class="form-group col-xs-4 nopadding">
                        <label for="invoice_buy_date">Ngày hóa đơn </label>
                      </div>
                      <div class="form-group col-xs-8 nopadding">
                        <input type="text" class="date_mask" data-inputmask="'alias': 'dd/mm/yyyy'" data-mask id="invoice_buy_date"  name="invoice_buy_date" tabindex="12" autocomplete="off" >
                      </div>
                    </div>
                    <div class="box-body nopadding">
                      <div class="form-group col-xs-4 nopadding">
                        <label for="invoice_buy_symbol">Ký hiệu HĐ </label>
                      </div>
                      <div class="form-group col-xs-8 nopadding">
                        <input type="text" id="invoice_buy_symbol"  name="invoice_buy_symbol" tabindex="13" autocomplete="off" >
                      </div>
                    </div>
                    <div class="box-body nopadding">
                      <div class="form-group col-xs-4 nopadding">
                        <label for="invoice_buy_number">Số hóa đơn </label>
                      </div>
                      <div class="form-group col-xs-8 nopadding">
                        <input type="text" id="invoice_buy_number"  name="invoice_buy_number" tabindex="14" autocomplete="off" >
                      </div>
                    </div>
                  </fieldset>
                  <!-- /.box-body -->
                  <div class="col-md-12">
                    <div class="box-body col-md-6">
                    </div>
                    <div class="box-body col-md-6 nopadding">
                      <div class="form-group col-xs-6 nopadding">
                        <label for="invoice_buy_money_type">Loại tiền </label>
                        <select id="invoice_buy_money_type" name="invoice_buy_money_type">
                          <option value="1">VNĐ</option>
                          <option value="2">USD</option>
                        </select>
                      </div>
                      <div class="form-group col-xs-6 nopadding">
                        <label for="invoice_buy_money_rate">Tỷ giá </label>
                        <input style="width:100%" type="text" class="numbers" id="invoice_buy_money_rate"  name="invoice_buy_money_rate" tabindex="15" required="required" autocomplete="off" >
                      </div>
                    </div>
                  </div>
                </div>
                
              </div>
              <div class="col-md-12">
                <!-- Nav tabs -->
                <ul class="nav nav-tabs" role="tablist">
                  <li class="nav-item active">
                    <a class="nav-link active" data-toggle="tab" href="#item" role="tab">1. Hàng hóa</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#tax" role="tab">2. Thuế</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#custom" role="tab">3. Phí trước HQ</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#other" role="tab">4. Phí hàng về kho</a>
                  </li>
                </ul>

                <!-- Tab panes -->
                <div class="tab-content">
                  <div class="tab-pane active" id="item" role="tabpanel">
                    <div class="table-container">
                      <table id="dataTable0" class="dataTable">
                        <thead>
                          <tr>
                            <th class="width-3">STT</th>
                            <th class="width-10">Mã hàng</th>
                            <th>Tên hàng</th>
                            <th class="width-5">Mã kho</th>
                            <th class="width-5">TK</th>
                            <th class="width-7">TK đối ứng</th>
                            <th class="width-5">ĐVT</th>
                            <th class="width-5">Số lượng</th>
                            <th class="width-7">Đơn giá</th>
                            <th class="width-10">Thành tiền</th>
                            <th class="width-5">Trước HQ</th>
                            <th class="width-7">Phí trước HQ</th>
                            <th class="width-7">Phí về kho</th>
                            <th class="width-10">Giá trị nhập kho</th>
                            <th style="width:2px"></th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr>
                            <td class="width-3">1</td>
                            <td class="width-10">
                              <input type="text" name="invoice_buy_item[]" class="invoice_buy_item left" required="required" placeholder="Nhập mã hoặc tên" autocomplete="off">
                              <button type="button" class="find_item right" title="Danh mục"><i class="fa fa-search"></i></button>
                            </td>
                            <td>
                              <input type="text" name="invoice_buy_item_name[]" class="invoice_buy_item_name" required="required" autocomplete="off">
                              <ul class="name_list_id"></ul>
                            </td>
                            <td class="width-5">
                              <input type="text" name="invoice_buy_item_house[]" class="invoice_buy_item_house keep-val" required="required" autocomplete="off">
                              <ul class="name_list_id_4"></ul>
                            </td>
                            <td class="width-5">
                              <input type="text" name="invoice_buy_item_debit[]" class="invoice_buy_item_debit keep-val" required="required" autocomplete="off" value="156">
                              <ul class="name_list_id_2"></ul>
                            </td>
                            <td class="width-7">
                              <input type="text" name="invoice_buy_item_credit[]" class="invoice_buy_item_credit keep-val" required="required" autocomplete="off" value="331">
                              <ul class="name_list_id_3"></ul>
                            </td>
                            <td class="width-5"><input type="text" name="invoice_buy_item_unit[]" class="invoice_buy_item_unit" required="required" autocomplete="off"></td>
                            <td class="width-5"><input type="text" name="invoice_buy_item_number[]" class="invoice_buy_item_number text-right" required="required" autocomplete="off"></td>
                            <td class="width-7"><input type="text" name="invoice_buy_item_price[]" class="invoice_buy_item_price numbers text-right" required="required" autocomplete="off"></td>
                            <td class="width-10"><input type="text" name="invoice_buy_item_money[]" class="invoice_buy_item_money numbers text-right" required="required" autocomplete="off"></td>
                            <td class="width-5"><input type="text" name="invoice_buy_item_custom_cost[]" class="invoice_buy_item_custom_cost text-right" required="required" autocomplete="off"></td>
                            <td class="width-7"><input type="text" name="invoice_buy_item_custom_cost_money[]" class="invoice_buy_item_custom_cost_money numbers text-right" required="required" autocomplete="off"></td>
                            <td class="width-7"><input type="text" name="invoice_buy_item_other_cost[]" class="invoice_buy_item_other_cost numbers text-right" required="required" autocomplete="off"></td>
                            <td class="width-10"><input disabled type="text" name="invoice_buy_item_total[]" class="invoice_buy_item_total numbers text-right" required="required" autocomplete="off"></td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                    <i class="fa fa-plus" title="Thêm dòng mới"></i> F2: Thêm dòng
                    <i class="fa fa-minus" title="Xóa dòng cuối cùng"></i> F3: Xóa dòng
                    
                  </div>
                  <div class="tab-pane" id="tax" role="tabpanel">
                    <div class="table-container">
                      <table id="dataTable1" class="dataTable">
                        <thead>
                          <tr>
                            <th class="width-3">STT</th>
                            <th class="width-10">Mã hàng</th>
                            <th>Tên hàng</th>
                            <th class="width-7">Tỷ giá HQ</th>
                            <th class="width-7">Thuế NK</th>
                            <th class="width-10">Tiền thuế NK</th>
                            <th class="width-7">TK thuế NK</th>
                            <th class="width-7">Thuế GTGT</th>
                            <th class="width-10">Tiền thuế GTGT</th>
                            <th class="width-10">TK thuế GTGT</th>
                            <th class="width-7">TK đối ứng</th>
                            <th>Tổng cộng</th>
                            <th style="width:5px"></th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr>
                            <td class="width-3">1</td>
                            <td class="width-10"><input type="text" name="invoice_buy_item2[]" class="invoice_buy_item2" disabled required="required"></td>
                            <td><input type="text" name="invoice_buy_item_name2[]" class="invoice_buy_item_name2" disabled required="required"></td>
                            <td class="width-7"><input type="text" name="invoice_buy_item_custom_rate[]" class="invoice_buy_item_custom_rate numbers keep-val text-right" required="required" autocomplete="off"></td>
                            <td class="width-7"><input type="text" name="invoice_buy_item_tax_import_percent[]" class="invoice_buy_item_tax_import_percent keep-val text-right" required="required" autocomplete="off"></td>
                            <td class="width-10"><input type="text" name="invoice_buy_item_tax_import[]" class="invoice_buy_item_tax_import numbers text-right" required="required" autocomplete="off"></td>
                            <td class="width-7">
                              <input type="text" name="invoice_buy_item_tax_import_debit[]" class="invoice_buy_item_tax_import_debit keep-val" required="required" autocomplete="off" value="3333">
                              <ul class="name_list_id_5"></ul>
                            </td>
                            <td class="width-7"><input type="text" name="invoice_buy_item_tax_vat_percent[]" class="invoice_buy_item_tax_vat_percent keep-val text-right" required="required" autocomplete="off"></td>
                            <td class="width-10"><input type="text" name="invoice_buy_item_tax_vat[]" class="invoice_buy_item_tax_vat numbers text-right" required="required" autocomplete="off"></td>
                            <td class="width-10">
                              <input type="text" name="invoice_buy_item_tax_vat_debit[]" class="invoice_buy_item_tax_vat_debit keep-val" required="required" autocomplete="off" value="33312">
                              <ul class="name_list_id_6"></ul>
                            </td>
                            <td class="width-7">
                              <input type="text" name="invoice_buy_item_tax_vat_credit[]" class="invoice_buy_item_tax_vat_credit keep-val" required="required" autocomplete="off" value="33312">
                              <ul class="name_list_id_7"></ul>
                            </td>
                            <td><input type="text" name="invoice_buy_item_tax_total[]" class="invoice_buy_item_tax_total numbers text-right" disabled required="required" autocomplete="off"></td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                    <i class="fa fa-plus" title="Thêm dòng mới"></i> F2: Thêm dòng
                    <i class="fa fa-minus" title="Xóa dòng cuối cùng"></i> F3: Xóa dòng
                  </div>
                  <div class="tab-pane" id="custom" role="tabpanel">
                    <div class="table-container">
                      <table id="dataTable3" class="dataTable3">
                        <thead>
                          <tr>
                            <th class="width-3">STT</th>
                            <th class="width-10">Số chứng từ</th>
                            <th class="width-10">Số tiền</th>
                            <th>Nội dung</th>
                            <th style="width:5px"></th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr>
                            <td class="width-3">1</td>
                            <td class="width-10"><input type="text" name="service_buy2[]" class="service_buy2" required="required"></td>
                            <td class="width-10"><input type="text" name="service_buy_total2[]" class="service_buy_total2 numbers text-right" required="required" autocomplete="off"></td>
                            <td><input type="text" name="service_buy_comment2[]" class="service_buy_comment2" required="required"></td>
                            
                          </tr>
                        </tbody>
                      </table>
                    </div>
                    <button type="button" class="btn btn-xs" id="find_service_buy2">Chọn...</button>
                    <input type="radio" name="invoice_buy_allocation2" value="1"> Phân bổ theo hệ số
                    <input type="radio" name="invoice_buy_allocation2" value="2"> Phân bổ theo số lượng
                  </div>
                  <div class="tab-pane" id="other" role="tabpanel">
                    <div class="table-container">
                      <table id="dataTable2" class="dataTable2">
                        <thead>
                          <tr>
                            <th class="width-3">STT</th>
                            <th class="width-10">Số chứng từ</th>
                            <th class="width-10">Số tiền</th>
                            <th>Nội dung</th>
                            <th style="width:5px"></th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr>
                            <td class="width-3">1</td>
                            <td class="width-10"><input type="text" name="service_buy[]" class="service_buy" required="required"></td>
                            <td class="width-10"><input type="text" name="service_buy_total[]" class="service_buy_total numbers text-right" required="required" autocomplete="off"></td>
                            <td><input type="text" name="service_buy_comment[]" class="service_buy_comment" required="required"></td>
                            
                          </tr>
                        </tbody>
                      </table>
                    </div>
                    <button type="button" class="btn btn-xs" id="find_service_buy">Chọn...</button>
                    <input type="radio" name="invoice_buy_allocation" value="1"> Phân bổ theo hệ số
                    <input type="radio" name="invoice_buy_allocation" value="2"> Phân bổ theo số lượng
                  </div>
                </div>
              </div>
              <div class="col-md-12">
                <div class="right">
                  <table class="table_data">
                    <tr>
                      <td>Tiền hàng NT</td>
                      <th class="text-right"><span id="price">0</span></th>
                      <td>Tổng tiền hàng</td>
                      <th class="text-right"><span id="money">0</span></th>
                      <td>Tiền thuế NK</td>
                      <th class="text-right"><span id="import">0</span></th>
                      <td>Tiền thuế GTGT</td>
                      <th class="text-right"><span id="vat">0</span></th>
                    </tr>
                    <tr>
                      <td>Phí trước HQ</td>
                      <th class="text-right"><span id="cost_custom">0</span></th>
                      <td>Phí về kho</td>
                      <th class="text-right"><span id="cost_other">0</span></th>
                      <td>Giá trị nhập kho</td>
                      <th class="text-right"><span id="total">0</span></th>
                    </tr>
                  </table>
                </div>
              </div>
              <?php if(!isset($disable_control)){ ?>
              <div class="row">
                <div class="col-md-12">
                    <div class="box-footer">
                    <input type="hidden" readonly id="yes" name="yes" required="required" >
                    <button type="submit" class="btn btn-primary" tabindex="4"><i class="fa fa-save"></i> Hoàn thành</button>
                    <button type="reset" class="btn" tabindex="5"><i class="fa fa-undo"></i>  Nhập lại</button>
                  </div>
                  <div class="box-footer">
                    <div id="error" class="error"><?php echo isset($error) ? $error : null; ?></div>
                  </div>
                </div>
              </div>
              <?php } ?>
            </form>
          </div>
          <!-- /.box -->

        </div>
        <!--/.col (left) -->
        
      </div>
      <!-- /.row -->
       
</div>

<div style="display:none" id="lasted"></div>

<script type="text/javascript">
$('.add-field').hide();
$(".date_mask").inputmask("dd/mm/yyyy", {"placeholder": "dd/mm/yyyy"});  

$('html').click(function(e) {
  $('.name_list_id').slideUp(200);
  $('.name_list_id_2').slideUp(200);
  $('.name_list_id_3').slideUp(200);
  $('.name_list_id_4').slideUp(200);
  $('.name_list_id_5').slideUp(200);
  $('.name_list_id_6').slideUp(200);
  $('.name_list_id_7').slideUp(200);
  $('.name_list_id_8').slideUp(200);
  $('#customer_list_id').slideUp(200);

  $('.invoice_buy_item').each(function(){
      if ($(this).attr('data')=="" || $(this).attr('data')==undefined) {
          $(this).val("");
          $('.invoice_buy_item2:eq('+$(this).closest('tr').index()+')').val("");
          $('.invoice_buy_item_number:eq('+$(this).closest('tr').index()+')').attr("alt","");
      }
  });

});

$('.edit_invoice').click(function(e){
    var id = $(this).attr('data');

    $('.add-field input[name!="invoice_buy_allocation"][name!="invoice_buy_allocation2"]').each(function(){
      var name = $(this).attr('id');
      $(this).val($('#'+name+'_'+id).text());
      $(this).attr('data',$('#'+name+'_'+id).attr('data'));
    });

    $('.add-field select').each(function(){
      var name = $(this).attr('id');
      var sl = $('#'+name+'_'+id).text();
      $("#"+name+" option[value=" + sl + "]").attr('selected', 'selected');
    });

    var invoice_buy_allocation = $('#invoice_buy_allocation_'+id).text();
    $('input[name="invoice_buy_allocation"][value='+invoice_buy_allocation+']').attr('checked',true);
    var invoice_buy_allocation2 = $('#invoice_buy_allocation2_'+id).text();
    $('input[name="invoice_buy_allocation2"][value='+invoice_buy_allocation2+']').attr('checked',true);

    $('#price').html($('#invoice_buy_money_foreign_'+id).text());
    $('#money').html($('#invoice_buy_money_'+id).text());
    $('#vat').html($('#invoice_buy_tax_vat_'+id).text());
    $('#import').html($('#invoice_buy_tax_import_'+id).text());
    $('#cost_custom').html($('#invoice_buy_custom_cost_'+id).text());
    $('#cost_other').html($('#invoice_buy_other_cost_'+id).text());
    $('#total').html($('#invoice_buy_total_'+id).text());
    //alert(cost_code);
    $('#yes').val(id);

    $('#dataTable0 tbody tr').remove();
    $('#dataTable1 tbody tr').remove();
    $('#dataTable2 tbody tr').remove();
    $('#dataTable3 tbody tr').remove();
    $.ajax({
      url: '<?php echo BASE_URL ?>/invoicebuy/getserviceadd',
      type: 'POST',
      data: {invoice_buy:id},
      success:function(answer){
        $('#dataTable2 tbody').append(answer);

        $('.delcost').click(function(){
          var invoice_buy = $(this).attr('data');
          var service_buy = $(this).attr('id');
          $.ajax({
            url: '<?php echo BASE_URL ?>/invoicebuy/deleteservice',
            type: 'POST',
            data: {invoice_buy:invoice_buy,service_buy:service_buy},
            success:function(answer){
              $('tr#'+service_buy+invoice_buy).remove();
              var invoice_buy_allocation = $('input[name="invoice_buy_allocation"]:checked').val();
              if (invoice_buy_allocation==1) {
                var money=0;
                $('.service_buy_total').each(function(){
                  money += parseFloat(get_number(this)) || 0;
                });

                var percent=0;
                $('.invoice_buy_item_number').each(function(){
                  var s = parseFloat($(this).val()) || 0;
                  var st = parseFloat($(this).attr('alt')) || 0;
                  percent += s/st;
                });

                $('.invoice_buy_item_number').each(function(){
                  var rowIndex=$(this).closest('tr').index();
                  var val = parseFloat($(this).val()) || 0;
                  var stuff = parseFloat($(this).attr('alt')) || 0;
                  if (val > 0) {
                    var cost = roundDecimal(money/(stuff*percent),2);
                    $('.invoice_buy_item_other_cost:eq('+rowIndex+')').val(cost);

                    var price = parseFloat(get_number('.invoice_buy_item_price:eq('+rowIndex+')')) || 0;
                    var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
                    var vat = parseFloat(get_number('.invoice_buy_item_tax_vat_percent:eq('+rowIndex+')')) || 0;
                    var imp = parseFloat(get_number('.invoice_buy_item_tax_import_percent:eq('+rowIndex+')')) || 0;
                    var custom = parseFloat(get_number('.invoice_buy_item_custom_cost:eq('+rowIndex+')')) || 0;
                    var custom_money = parseFloat(get_number('.invoice_buy_item_custom_cost_money:eq('+rowIndex+')')) || 0;
                    var custom_rate = parseFloat(get_number('.invoice_buy_item_custom_rate:eq('+rowIndex+')')) || 0;
                    var rate = parseFloat(get_number('#invoice_buy_money_rate')) || 0;
                    
                    var nk = roundDecimal((price+custom)*custom_rate*sl*imp/100,0);
                    var gtgt = roundDecimal((custom_rate*sl*(price+custom)+nk)*vat/100,0);

                    var gt = sl*(roundDecimal(rate*price,2)+cost+custom_money)+nk;
                    
                    $('.invoice_buy_item_tax_import:eq('+rowIndex+')').val(nk);
                    $('.invoice_buy_item_tax_vat:eq('+rowIndex+')').val(gtgt);
                    $('.invoice_buy_item_tax_total:eq('+rowIndex+')').val(nk+gtgt);

                    $('.invoice_buy_item_total:eq('+rowIndex+')').val(roundDecimal(gt/sl,2));

                    var tongtienhang = 0;
                    $('.invoice_buy_item_money').each(function(){
                      tongtienhang += parseFloat(get_number(this)) || 0;
                    });

                    var tongtienthuenhap = 0;
                    $('.invoice_buy_item_tax_import').each(function(){
                      tongtienthuenhap += parseFloat(get_number(this)) || 0;
                    });

                    var tongtienthuevat = 0;
                    $('.invoice_buy_item_tax_vat').each(function(){
                      tongtienthuevat += parseFloat(get_number(this)) || 0;
                    });

                    var tongchiphi = 0;
                    var tongchiphi2 = 0;
                    $('.invoice_buy_item_other_cost').each(function(){
                      var rowIndex=$(this).closest('tr').index();
                      var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
                      tongchiphi2 += parseFloat(get_number(this))*sl || 0;
                    });
                    $('.invoice_buy_item_custom_cost_money').each(function(){
                      var rowIndex=$(this).closest('tr').index();
                      var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
                      tongchiphi += roundDecimal((parseFloat(get_number(this)) || 0)*sl,2);
                    });

                    $('#import').html(tongtienthuenhap);
                    $('#vat').html(tongtienthuevat);
                    $('#cost_custom').html(tongchiphi);
                    $('#cost_other').html(tongchiphi2);
                    $('#money').html(tongtienhang);
                    
                    $('#total').html(tongtienthuenhap+tongtienhang+tongchiphi+tongchiphi2);

                    $('#total').html(function(index, value) {
                      return value
                        .replace(/[^0-9-.]/g, "")
                        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                      ;
                    });

                    $('#money').html(function(index, value) {
                      return value
                        .replace(/[^0-9-.]/g, "")
                        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                      ;
                    });
                    
                    $('#import').html(function(index, value) {
                      return value
                        .replace(/[^0-9-.]/g, "")
                        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                      ;
                    });

                    $('#vat').html(function(index, value) {
                      return value
                        .replace(/[^0-9-.]/g, "")
                        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                      ;
                    });

                    $('#cost_custom').html(function(index, value) {
                      return value
                        .replace(/[^0-9-.]/g, "")
                        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                      ;
                    });
                    $('#cost_other').html(function(index, value) {
                      return value
                        .replace(/[^0-9-.]/g, "")
                        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                      ;
                    });

                    $('.numbers').val(function(index, value) {
                      return value
                        .replace(/[^0-9-.]/g, "")
                        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                      ;
                    });
                  }
                });
              }
              else{
                var money=0;
                $('.service_buy_total').each(function(){
                  money += parseFloat(get_number(this)) || 0;
                });
                var num=0;
                $('.invoice_buy_item_number').each(function(){
                  num += parseFloat($(this).val()) || 0;
                });
                $('.invoice_buy_item_number').each(function(){
                  var rowIndex=$(this).closest('tr').index();
                  var val = parseFloat($(this).val()) || 0;
                  if (val > 0) {
                    var cost = roundDecimal(money/num,2);
                    $('.invoice_buy_item_other_cost:eq('+rowIndex+')').val(cost);

                    var price = parseFloat(get_number('.invoice_buy_item_price:eq('+rowIndex+')')) || 0;
                    var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
                    var vat = parseFloat(get_number('.invoice_buy_item_tax_vat_percent:eq('+rowIndex+')')) || 0;
                    var imp = parseFloat(get_number('.invoice_buy_item_tax_import_percent:eq('+rowIndex+')')) || 0;
                    var custom = parseFloat(get_number('.invoice_buy_item_custom_cost:eq('+rowIndex+')')) || 0;
                    var custom_money = parseFloat(get_number('.invoice_buy_item_custom_cost_money:eq('+rowIndex+')')) || 0;
                    var custom_rate = parseFloat(get_number('.invoice_buy_item_custom_rate:eq('+rowIndex+')')) || 0;
                    var rate = parseFloat(get_number('#invoice_buy_money_rate')) || 0;
                    
                    var nk = roundDecimal((price+custom)*custom_rate*sl*imp/100,0);
                    var gtgt = roundDecimal((custom_rate*sl*(price+custom)+nk)*vat/100,0);

                    var gt = sl*(roundDecimal(rate*price,2)+cost+custom_money)+nk;
                    
                    $('.invoice_buy_item_tax_import:eq('+rowIndex+')').val(nk);
                    $('.invoice_buy_item_tax_vat:eq('+rowIndex+')').val(gtgt);
                    $('.invoice_buy_item_tax_total:eq('+rowIndex+')').val(nk+gtgt);

                    $('.invoice_buy_item_total:eq('+rowIndex+')').val(roundDecimal(gt/sl,2));

                    var tongtienhang = 0;
                    $('.invoice_buy_item_money').each(function(){
                      tongtienhang += parseFloat(get_number(this)) || 0;
                    });

                    var tongtienthuenhap = 0;
                    $('.invoice_buy_item_tax_import').each(function(){
                      tongtienthuenhap += parseFloat(get_number(this)) || 0;
                    });

                    var tongtienthuevat = 0;
                    $('.invoice_buy_item_tax_vat').each(function(){
                      tongtienthuevat += parseFloat(get_number(this)) || 0;
                    });

                    var tongchiphi = 0;
                    var tongchiphi2 = 0;
                    $('.invoice_buy_item_other_cost').each(function(){
                      var rowIndex=$(this).closest('tr').index();
                      var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
                      tongchiphi2 += parseFloat(get_number(this))*sl || 0;
                    });
                    $('.invoice_buy_item_custom_cost_money').each(function(){
                      var rowIndex=$(this).closest('tr').index();
                      var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
                      tongchiphi += roundDecimal((parseFloat(get_number(this)) || 0)*sl,2);
                    });

                    $('#import').html(tongtienthuenhap);
                    $('#vat').html(tongtienthuevat);
                    $('#cost_custom').html(tongchiphi);
                    $('#cost_other').html(tongchiphi2);
                    $('#money').html(tongtienhang);
                    
                    $('#total').html(tongtienthuenhap+tongtienhang+tongchiphi+tongchiphi2);

                    $('#total').html(function(index, value) {
                      return value
                        .replace(/[^0-9-.]/g, "")
                        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                      ;
                    });

                    $('#money').html(function(index, value) {
                      return value
                        .replace(/[^0-9-.]/g, "")
                        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                      ;
                    });
                    
                    $('#import').html(function(index, value) {
                      return value
                        .replace(/[^0-9-.]/g, "")
                        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                      ;
                    });

                    $('#vat').html(function(index, value) {
                      return value
                        .replace(/[^0-9-.]/g, "")
                        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                      ;
                    });

                    $('#cost_custom').html(function(index, value) {
                      return value
                        .replace(/[^0-9-.]/g, "")
                        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                      ;
                    });
                    $('#cost_other').html(function(index, value) {
                      return value
                        .replace(/[^0-9-.]/g, "")
                        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                      ;
                    });

                    $('.numbers').val(function(index, value) {
                      return value
                        .replace(/[^0-9-.]/g, "")
                        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                      ;
                    });
                  }
                });
              }
            }
          });
        });
      }
    });

    $.ajax({
      url: '<?php echo BASE_URL ?>/invoicebuy/getserviceadd2',
      type: 'POST',
      data: {invoice_buy:id},
      success:function(answer){
        $('#dataTable3 tbody').append(answer);

        $('.delcost2').click(function(){
          var invoice_buy = $(this).attr('data');
          var service_buy = $(this).attr('id');
          $.ajax({
            url: '<?php echo BASE_URL ?>/invoicebuy/deleteservice2',
            type: 'POST',
            data: {invoice_buy:invoice_buy,service_buy:service_buy},
            success:function(answer){
              $('tr#'+service_buy+invoice_buy).remove();
              var invoice_buy_allocation2 = $('input[name="invoice_buy_allocation2"]:checked').val();
              if (invoice_buy_allocation2==1) {
                var money=0;
                var money_foreign=0;
                $('.service_buy_total2').each(function(){
                  money += parseFloat(get_number(this)) || 0;
                  money_foreign += parseFloat($(this).attr('data').replace(/\,/g,'')) || 0;
                });

                var percent=0;
                $('.invoice_buy_item_number').each(function(){
                  var s = parseFloat($(this).val()) || 0;
                  var st = parseFloat($(this).attr('alt')) || 0;
                  percent += s/st;
                });

                $('.invoice_buy_item_number').each(function(){
                  var rowIndex=$(this).closest('tr').index();
                  var val = parseFloat($(this).val()) || 0;
                  var stuff = parseFloat($(this).attr('alt')) || 0;
                  if (val > 0) {
                    var cost = roundDecimal(money/(stuff*percent),2);
                    var cost_foreign = roundDecimal(money_foreign/(stuff*percent),6);
                    $('.invoice_buy_item_custom_cost:eq('+rowIndex+')').val(cost_foreign);
                    $('.invoice_buy_item_custom_cost_money:eq('+rowIndex+')').val(cost);

                    var price = parseFloat(get_number('.invoice_buy_item_price:eq('+rowIndex+')')) || 0;
                    var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
                    var vat = parseFloat(get_number('.invoice_buy_item_tax_vat_percent:eq('+rowIndex+')')) || 0;
                    var imp = parseFloat(get_number('.invoice_buy_item_tax_import_percent:eq('+rowIndex+')')) || 0;
                    var custom = parseFloat(get_number('.invoice_buy_item_custom_cost:eq('+rowIndex+')')) || 0;
                    var custom_money = parseFloat(get_number('.invoice_buy_item_custom_cost_money:eq('+rowIndex+')')) || 0;
                    var custom_rate = parseFloat(get_number('.invoice_buy_item_custom_rate:eq('+rowIndex+')')) || 0;
                    var rate = parseFloat(get_number('#invoice_buy_money_rate')) || 0;
                    
                    var nk = roundDecimal((price+custom)*custom_rate*sl*imp/100,0);
                    var gtgt = roundDecimal((custom_rate*sl*(price+custom)+nk)*vat/100,0);

                    var gt = sl*(roundDecimal(rate*price,2)+cost+custom_money)+nk;
                    
                    $('.invoice_buy_item_tax_import:eq('+rowIndex+')').val(nk);
                    $('.invoice_buy_item_tax_vat:eq('+rowIndex+')').val(gtgt);
                    $('.invoice_buy_item_tax_total:eq('+rowIndex+')').val(nk+gtgt);

                    $('.invoice_buy_item_total:eq('+rowIndex+')').val(roundDecimal(gt/sl,2));

                    var tongtienhang = 0;
                    $('.invoice_buy_item_money').each(function(){
                      tongtienhang += parseFloat(get_number(this)) || 0;
                    });

                    var tongtienthuenhap = 0;
                    $('.invoice_buy_item_tax_import').each(function(){
                      tongtienthuenhap += parseFloat(get_number(this)) || 0;
                    });

                    var tongtienthuevat = 0;
                    $('.invoice_buy_item_tax_vat').each(function(){
                      tongtienthuevat += parseFloat(get_number(this)) || 0;
                    });

                    var tongchiphi = 0;
                    var tongchiphi2 = 0;
                    $('.invoice_buy_item_other_cost').each(function(){
                      var rowIndex=$(this).closest('tr').index();
                      var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
                      tongchiphi2 += parseFloat(get_number(this))*sl || 0;
                    });
                    $('.invoice_buy_item_custom_cost_money').each(function(){
                      var rowIndex=$(this).closest('tr').index();
                      var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
                      tongchiphi += roundDecimal((parseFloat(get_number(this)) || 0)*sl,2);
                    });

                    $('#import').html(tongtienthuenhap);
                    $('#vat').html(tongtienthuevat);
                    $('#cost_custom').html(tongchiphi);
                    $('#cost_other').html(tongchiphi2);
                    $('#money').html(tongtienhang);
                    
                    $('#total').html(tongtienthuenhap+tongtienhang+tongchiphi+tongchiphi2);

                    $('#total').html(function(index, value) {
                      return value
                        .replace(/[^0-9-.]/g, "")
                        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                      ;
                    });

                    $('#money').html(function(index, value) {
                      return value
                        .replace(/[^0-9-.]/g, "")
                        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                      ;
                    });
                    
                    $('#import').html(function(index, value) {
                      return value
                        .replace(/[^0-9-.]/g, "")
                        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                      ;
                    });

                    $('#vat').html(function(index, value) {
                      return value
                        .replace(/[^0-9-.]/g, "")
                        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                      ;
                    });

                    $('#cost_custom').html(function(index, value) {
                      return value
                        .replace(/[^0-9-.]/g, "")
                        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                      ;
                    });
                    $('#cost_other').html(function(index, value) {
                      return value
                        .replace(/[^0-9-.]/g, "")
                        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                      ;
                    });

                    $('.numbers').val(function(index, value) {
                      return value
                        .replace(/[^0-9-.]/g, "")
                        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                      ;
                    });
                  }
                });
              }
              else{
                var money=0;
                var money_foreign=0;
                $('.service_buy_total2').each(function(){
                  money += parseFloat(get_number(this)) || 0;
                  money_foreign += parseFloat($(this).attr('data').replace(/\,/g,'')) || 0;
                });
                var num=0;
                $('.invoice_buy_item_number').each(function(){
                  num += parseFloat($(this).val()) || 0;
                });
                $('.invoice_buy_item_number').each(function(){
                  var rowIndex=$(this).closest('tr').index();
                  var val = parseFloat($(this).val()) || 0;
                  if (val > 0) {
                    var cost = roundDecimal(money/num,2);
                    var cost_foreign = roundDecimal(money_foreign/num,6);
                    $('.invoice_buy_item_custom_cost:eq('+rowIndex+')').val(cost_foreign);
                    $('.invoice_buy_item_custom_cost_money:eq('+rowIndex+')').val(cost);

                    var price = parseFloat(get_number('.invoice_buy_item_price:eq('+rowIndex+')')) || 0;
                    var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
                    var vat = parseFloat(get_number('.invoice_buy_item_tax_vat_percent:eq('+rowIndex+')')) || 0;
                    var imp = parseFloat(get_number('.invoice_buy_item_tax_import_percent:eq('+rowIndex+')')) || 0;
                    var custom = parseFloat(get_number('.invoice_buy_item_custom_cost:eq('+rowIndex+')')) || 0;
                    var custom_money = parseFloat(get_number('.invoice_buy_item_custom_cost_money:eq('+rowIndex+')')) || 0;
                    var custom_rate = parseFloat(get_number('.invoice_buy_item_custom_rate:eq('+rowIndex+')')) || 0;
                    var rate = parseFloat(get_number('#invoice_buy_money_rate')) || 0;
                    
                    var nk = roundDecimal((price+custom)*custom_rate*sl*imp/100,0);
                    var gtgt = roundDecimal((custom_rate*sl*(price+custom)+nk)*vat/100,0);

                    var gt = sl*(roundDecimal(rate*price,2)+cost+custom_money)+nk;
                    
                    $('.invoice_buy_item_tax_import:eq('+rowIndex+')').val(nk);
                    $('.invoice_buy_item_tax_vat:eq('+rowIndex+')').val(gtgt);
                    $('.invoice_buy_item_tax_total:eq('+rowIndex+')').val(nk+gtgt);

                    $('.invoice_buy_item_total:eq('+rowIndex+')').val(roundDecimal(gt/sl,2));

                    var tongtienhang = 0;
                    $('.invoice_buy_item_money').each(function(){
                      tongtienhang += parseFloat(get_number(this)) || 0;
                    });

                    var tongtienthuenhap = 0;
                    $('.invoice_buy_item_tax_import').each(function(){
                      tongtienthuenhap += parseFloat(get_number(this)) || 0;
                    });

                    var tongtienthuevat = 0;
                    $('.invoice_buy_item_tax_vat').each(function(){
                      tongtienthuevat += parseFloat(get_number(this)) || 0;
                    });

                    var tongchiphi = 0;
                    var tongchiphi2 = 0;
                    $('.invoice_buy_item_other_cost').each(function(){
                      var rowIndex=$(this).closest('tr').index();
                      var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
                      tongchiphi2 += parseFloat(get_number(this))*sl || 0;
                    });
                    $('.invoice_buy_item_custom_cost_money').each(function(){
                      var rowIndex=$(this).closest('tr').index();
                      var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
                      tongchiphi += roundDecimal((parseFloat(get_number(this)) || 0)*sl,2);
                    });

                    $('#import').html(tongtienthuenhap);
                    $('#vat').html(tongtienthuevat);
                    $('#cost_custom').html(tongchiphi);
                    $('#cost_other').html(tongchiphi2);
                    $('#money').html(tongtienhang);
                    
                    $('#total').html(tongtienthuenhap+tongtienhang+tongchiphi+tongchiphi2);

                    $('#total').html(function(index, value) {
                      return value
                        .replace(/[^0-9-.]/g, "")
                        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                      ;
                    });

                    $('#money').html(function(index, value) {
                      return value
                        .replace(/[^0-9-.]/g, "")
                        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                      ;
                    });
                    
                    $('#import').html(function(index, value) {
                      return value
                        .replace(/[^0-9-.]/g, "")
                        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                      ;
                    });

                    $('#vat').html(function(index, value) {
                      return value
                        .replace(/[^0-9-.]/g, "")
                        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                      ;
                    });

                    $('#cost_custom').html(function(index, value) {
                      return value
                        .replace(/[^0-9-.]/g, "")
                        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                      ;
                    });
                    $('#cost_other').html(function(index, value) {
                      return value
                        .replace(/[^0-9-.]/g, "")
                        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                      ;
                    });

                    $('.numbers').val(function(index, value) {
                      return value
                        .replace(/[^0-9-.]/g, "")
                        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                      ;
                    });
                  }
                });
              }
            }
          });
        });
      }
    });

    $.ajax({
      url: '<?php echo BASE_URL ?>/invoicebuy/getitemadd',
      type: 'POST',
      data: {invoice_buy:id},
      success:function(answer){
          //alert(data);
          var data = JSON.parse(answer);
          $('#dataTable0 tbody').append(data.hang);
          $('#dataTable1 tbody').append(data.thue);

          $('input').keyup(function (e) {
              if (e.which == 39) { // right arrow
                $(this).closest('td').next().find('input').focus();

              } else if (e.which == 37) { // left arrow
                $(this).closest('td').prev().find('input').focus();

              } else if (e.which == 40) { // down arrow
                $(this).closest('tr').next().find('td:eq(' + $(this).closest('td').index() + ')').find('input').focus();

              } else if (e.which == 38) { // up arrow
                $(this).closest('tr').prev().find('td:eq(' + $(this).closest('td').index() + ')').find('input').focus();
              }
            });
          $('#dataTable0 tbody tr td:nth-child(2) input').keyup(function(){
            var val = $(this).val();
            var trIndex = $(this).closest('tr').index();
            $('#dataTable1 tbody tr:eq('+trIndex+') td:nth-child(2) input').val(val);
          });
          $('#dataTable0 tbody tr td:nth-child(3) input').keyup(function(){
            var val = $(this).val();
            var trIndex = $(this).closest('tr').index();
            $('#dataTable1 tbody tr:eq('+trIndex+') td:nth-child(3) input').val(val);
          });

          $('.numbers').keyup(function(event) {
              // skip for arrow keys
            if(event.which >= 37 && event.which <= 40) return;
            // format number
            $(this).val(function(index, value) {
              return value
                .replace(/[^0-9-.]/g, "")
                .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
              ;
            });
          });

          

        $(".invoice_buy_item_custom_cost").keyup(function(){
          var rowIndex=$(this).closest('tr').index();
          var price = parseFloat(get_number('.invoice_buy_item_price:eq('+rowIndex+')')) || 0;
          var custom = parseFloat(get_number(this)) || 0;
          var custom_money = parseFloat(get_number('.invoice_buy_item_custom_cost_money:eq('+rowIndex+')')) || 0;
          var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
          var vat = parseFloat(get_number('.invoice_buy_item_tax_vat_percent:eq('+rowIndex+')')) || 0;
          var imp = parseFloat(get_number('.invoice_buy_item_tax_import_percent:eq('+rowIndex+')')) || 0;
          var cost = parseFloat(get_number('.invoice_buy_item_other_cost:eq('+rowIndex+')')) || 0;
          var custom_rate = parseFloat(get_number('.invoice_buy_item_custom_rate:eq('+rowIndex+')')) || 0;
          var rate = parseFloat(get_number('#invoice_buy_money_rate')) || 0;
          
          var nk = roundDecimal((price+custom)*custom_rate*sl*imp/100,0);
          var gtgt = roundDecimal((custom_rate*sl*(price+custom)+nk)*vat/100,0);
          var custom_money = roundDecimal(custom*custom_rate*sl,2);

          var gt = sl*(roundDecimal(rate*price,2)+cost+custom_money)+nk;
          
          $('.invoice_buy_item_tax_import:eq('+rowIndex+')').val(nk);
          $('.invoice_buy_item_tax_vat:eq('+rowIndex+')').val(gtgt);
          $('.invoice_buy_item_tax_total:eq('+rowIndex+')').val(nk+gtgt);

          $('.invoice_buy_item_total:eq('+rowIndex+')').val(roundDecimal(gt/sl,2));

          var tongtienhang = 0;
          $('.invoice_buy_item_money').each(function(){
            tongtienhang += parseFloat(get_number(this)) || 0;
          });

          var tongtienthuenhap = 0;
          $('.invoice_buy_item_tax_import').each(function(){
            tongtienthuenhap += parseFloat(get_number(this)) || 0;
          });

          var tongtienthuevat = 0;
          $('.invoice_buy_item_tax_vat').each(function(){
            tongtienthuevat += parseFloat(get_number(this)) || 0;
          });

          var tongchiphi = 0;
          var tongchiphi2 = 0;
          $('.invoice_buy_item_other_cost').each(function(){
            var rowIndex=$(this).closest('tr').index();
            var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
            tongchiphi2 += parseFloat(get_number(this))*sl || 0;
          });
          $('.invoice_buy_item_custom_cost_money').each(function(){
            var rowIndex=$(this).closest('tr').index();
            var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
            tongchiphi += roundDecimal((parseFloat(get_number(this)) || 0)*sl,2);
          });

          $('#import').html(tongtienthuenhap);
          $('#vat').html(tongtienthuevat);
          $('#cost_custom').html(tongchiphi);
          $('#cost_other').html(tongchiphi2);
          $('#money').html(tongtienhang);
          
          $('#total').html(tongtienthuenhap+tongtienhang+tongchiphi+tongchiphi2);

          $('#total').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });

          $('#money').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });
          
          $('#import').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });

          $('#vat').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });

          $('#cost_custom').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });

          $('#cost_other').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });

          $('.numbers').val(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });
        });
        $(".invoice_buy_item_custom_cost_money").keyup(function(){
          var rowIndex=$(this).closest('tr').index();
          var price = parseFloat(get_number('.invoice_buy_item_price:eq('+rowIndex+')')) || 0;
          var custom_money = parseFloat(get_number(this)) || 0;
          var custom = parseFloat(get_number('.invoice_buy_item_custom_cost:eq('+rowIndex+')')) || 0;
          var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
          var vat = parseFloat(get_number('.invoice_buy_item_tax_vat_percent:eq('+rowIndex+')')) || 0;
          var imp = parseFloat(get_number('.invoice_buy_item_tax_import_percent:eq('+rowIndex+')')) || 0;
          var cost = parseFloat(get_number('.invoice_buy_item_other_cost:eq('+rowIndex+')')) || 0;
          var custom_rate = parseFloat(get_number('.invoice_buy_item_custom_rate:eq('+rowIndex+')')) || 0;
          var rate = parseFloat(get_number('#invoice_buy_money_rate')) || 0;
          
          var nk = roundDecimal((price+custom)*custom_rate*sl*imp/100,0);
          var gtgt = roundDecimal((custom_rate*sl*(price+custom)+nk)*vat/100,0);

          var gt = sl*(roundDecimal(rate*price,2)+cost+custom_money)+nk;
          
          $('.invoice_buy_item_tax_import:eq('+rowIndex+')').val(nk);
          $('.invoice_buy_item_tax_vat:eq('+rowIndex+')').val(gtgt);
          $('.invoice_buy_item_tax_total:eq('+rowIndex+')').val(nk+gtgt);

          $('.invoice_buy_item_total:eq('+rowIndex+')').val(roundDecimal(gt/sl,2));

          var tongtienhang = 0;
          $('.invoice_buy_item_money').each(function(){
            tongtienhang += parseFloat(get_number(this)) || 0;
          });

          var tongtienthuenhap = 0;
          $('.invoice_buy_item_tax_import').each(function(){
            tongtienthuenhap += parseFloat(get_number(this)) || 0;
          });

          var tongtienthuevat = 0;
          $('.invoice_buy_item_tax_vat').each(function(){
            tongtienthuevat += parseFloat(get_number(this)) || 0;
          });

          var tongchiphi = 0;
          var tongchiphi2 = 0;
          $('.invoice_buy_item_other_cost').each(function(){
            var rowIndex=$(this).closest('tr').index();
            var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
            tongchiphi2 += parseFloat(get_number(this))*sl || 0;
          });
          $('.invoice_buy_item_custom_cost_money').each(function(){
            var rowIndex=$(this).closest('tr').index();
            var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
            tongchiphi += roundDecimal((parseFloat(get_number(this)) || 0)*sl,2);
          });

          $('#import').html(tongtienthuenhap);
          $('#vat').html(tongtienthuevat);
          $('#cost_custom').html(tongchiphi);
          $('#cost_other').html(tongchiphi2);
          $('#money').html(tongtienhang);
          
          $('#total').html(tongtienthuenhap+tongtienhang+tongchiphi+tongchiphi2);

          $('#total').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });

          $('#money').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });
          
          $('#import').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });

          $('#vat').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });

          $('#cost_custom').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });
          $('#cost_other').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });

          $('.numbers').val(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });
        });

        $(".invoice_buy_item_other_cost").keyup(function(){
          var rowIndex=$(this).closest('tr').index();
          var price = parseFloat(get_number('.invoice_buy_item_price:eq('+rowIndex+')')) || 0;
          var cost = parseFloat(get_number(this)) || 0;
          var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
          var vat = parseFloat(get_number('.invoice_buy_item_tax_vat_percent:eq('+rowIndex+')')) || 0;
          var imp = parseFloat(get_number('.invoice_buy_item_tax_import_percent:eq('+rowIndex+')')) || 0;
          var custom = parseFloat(get_number('.invoice_buy_item_custom_cost:eq('+rowIndex+')')) || 0;
          var custom_money = parseFloat(get_number('.invoice_buy_item_custom_cost_money:eq('+rowIndex+')')) || 0;
          var custom_rate = parseFloat(get_number('.invoice_buy_item_custom_rate:eq('+rowIndex+')')) || 0;
          var rate = parseFloat(get_number('#invoice_buy_money_rate')) || 0;
          
          var nk = roundDecimal((price+custom)*custom_rate*sl*imp/100,0);
          var gtgt = roundDecimal((custom_rate*sl*(price+custom)+nk)*vat/100,0);

          var gt = sl*(roundDecimal(rate*price,2)+cost+custom_money)+nk;
          
          $('.invoice_buy_item_tax_import:eq('+rowIndex+')').val(nk);
          $('.invoice_buy_item_tax_vat:eq('+rowIndex+')').val(gtgt);
          $('.invoice_buy_item_tax_total:eq('+rowIndex+')').val(nk+gtgt);

          $('.invoice_buy_item_total:eq('+rowIndex+')').val(roundDecimal(gt/sl,2));

          var tongtienhang = 0;
          $('.invoice_buy_item_money').each(function(){
            tongtienhang += parseFloat(get_number(this)) || 0;
          });

          var tongtienthuenhap = 0;
          $('.invoice_buy_item_tax_import').each(function(){
            tongtienthuenhap += parseFloat(get_number(this)) || 0;
          });

          var tongtienthuevat = 0;
          $('.invoice_buy_item_tax_vat').each(function(){
            tongtienthuevat += parseFloat(get_number(this)) || 0;
          });

          var tongchiphi = 0;
          var tongchiphi2 = 0;
          $('.invoice_buy_item_other_cost').each(function(){
            var rowIndex=$(this).closest('tr').index();
            var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
            tongchiphi2 += parseFloat(get_number(this))*sl || 0;
          });
          $('.invoice_buy_item_custom_cost_money').each(function(){
            var rowIndex=$(this).closest('tr').index();
            var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
            tongchiphi += roundDecimal((parseFloat(get_number(this)) || 0)*sl,2);
          });

          $('#import').html(tongtienthuenhap);
          $('#vat').html(tongtienthuevat);
          $('#cost_custom').html(tongchiphi);
          $('#cost_other').html(tongchiphi2);
          $('#money').html(tongtienhang);
          
          $('#total').html(tongtienthuenhap+tongtienhang+tongchiphi+tongchiphi2);

          $('#total').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });

          $('#money').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });
          
          $('#import').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });

          $('#vat').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });

          $('#cost_custom').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });

          $('#cost_other').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });

          $('.numbers').val(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });
        });

        $(".invoice_buy_item_number").keyup(function(){
          var rowIndex=$(this).closest('tr').index();
          var price = parseFloat(get_number('.invoice_buy_item_price:eq('+rowIndex+')')) || 0;
          var sl = parseFloat(get_number(this)) || 0;
          var custom = parseFloat(get_number('.invoice_buy_item_custom_cost:eq('+rowIndex+')')) || 0;
          var custom_money = parseFloat(get_number('.invoice_buy_item_custom_cost_money:eq('+rowIndex+')')) || 0;
          var vat = parseFloat(get_number('.invoice_buy_item_tax_vat_percent:eq('+rowIndex+')')) || 0;
          var imp = parseFloat(get_number('.invoice_buy_item_tax_import_percent:eq('+rowIndex+')')) || 0;
          var cost = parseFloat(get_number('.invoice_buy_item_other_cost:eq('+rowIndex+')')) || 0;
          var custom_rate = parseFloat(get_number('.invoice_buy_item_custom_rate:eq('+rowIndex+')')) || 0;
          var rate = parseFloat(get_number('#invoice_buy_money_rate')) || 0;
          
          var tien = roundDecimal(sl*price*rate,2);
          var nk = roundDecimal((price+custom)*custom_rate*sl*imp/100,0);
          var gtgt = roundDecimal((custom_rate*sl*(price+custom)+nk)*vat/100,0);

          var gt = sl*(roundDecimal(rate*price,2)+cost+custom_money)+nk;
          
          $('.invoice_buy_item_money:eq('+rowIndex+')').val(tien);
          $('.invoice_buy_item_tax_import:eq('+rowIndex+')').val(nk);
          $('.invoice_buy_item_tax_vat:eq('+rowIndex+')').val(gtgt);
          $('.invoice_buy_item_tax_total:eq('+rowIndex+')').val(nk+gtgt);

          $('.invoice_buy_item_total:eq('+rowIndex+')').val(roundDecimal(gt/sl,2));

          var tongtienhangnt = 0;
          $('.invoice_buy_item_price').each(function(){
            var rowIndex=$(this).closest('tr').index();
            var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
            tongtienhangnt += roundDecimal(parseFloat(get_number(this))*sl,2) || 0;
          });

          var tongtienhang = 0;
          $('.invoice_buy_item_money').each(function(){
            tongtienhang += parseFloat(get_number(this)) || 0;
          });

          var tongtienthuenhap = 0;
          $('.invoice_buy_item_tax_import').each(function(){
            tongtienthuenhap += parseFloat(get_number(this)) || 0;
          });

          var tongtienthuevat = 0;
          $('.invoice_buy_item_tax_vat').each(function(){
            tongtienthuevat += parseFloat(get_number(this)) || 0;
          });

          var tongchiphi = 0;
          var tongchiphi2 = 0;
          $('.invoice_buy_item_other_cost').each(function(){
            var rowIndex=$(this).closest('tr').index();
            var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
            tongchiphi2 += parseFloat(get_number(this))*sl || 0;
          });
          $('.invoice_buy_item_custom_cost_money').each(function(){
            var rowIndex=$(this).closest('tr').index();
            var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
            tongchiphi += roundDecimal((parseFloat(get_number(this)) || 0)*sl,2);
          });

          $('#import').html(tongtienthuenhap);
          $('#vat').html(tongtienthuevat);
          $('#cost_custom').html(tongchiphi);
          $('#cost_other').html(tongchiphi2);
          $('#money').html(tongtienhang);
          
          $('#total').html(tongtienthuenhap+tongtienhang+tongchiphi+tongchiphi2);

          $('#price').html(tongtienhangnt);

          $('#price').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });
          $('#total').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });

          $('#money').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });
          
          $('#import').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });

          $('#vat').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });

          $('#cost_custom').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });
          $('#cost_other').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });

          $('.numbers').val(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });
        });
        $(".invoice_buy_item_price").keyup(function(){
          var rowIndex=$(this).closest('tr').index();
          var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
          var price = parseFloat(get_number(this)) || 0;
          var custom = parseFloat(get_number('.invoice_buy_item_custom_cost:eq('+rowIndex+')')) || 0;
          var custom_money = parseFloat(get_number('.invoice_buy_item_custom_cost_money:eq('+rowIndex+')')) || 0;
          var vat = parseFloat(get_number('.invoice_buy_item_tax_vat_percent:eq('+rowIndex+')')) || 0;
          var imp = parseFloat(get_number('.invoice_buy_item_tax_import_percent:eq('+rowIndex+')')) || 0;
          var cost = parseFloat(get_number('.invoice_buy_item_other_cost:eq('+rowIndex+')')) || 0;
          var custom_rate = parseFloat(get_number('.invoice_buy_item_custom_rate:eq('+rowIndex+')')) || 0;
          var rate = parseFloat(get_number('#invoice_buy_money_rate')) || 0;
          
          var tien = roundDecimal(sl*price*rate,2);
          var nk = roundDecimal((price+custom)*custom_rate*sl*imp/100,0);
          var gtgt = roundDecimal((custom_rate*sl*(price+custom)+nk)*vat/100,0);

          var gt = sl*(roundDecimal(rate*price,2)+cost+custom_money)+nk;
          
          $('.invoice_buy_item_money:eq('+rowIndex+')').val(tien);
          $('.invoice_buy_item_tax_import:eq('+rowIndex+')').val(nk);
          $('.invoice_buy_item_tax_vat:eq('+rowIndex+')').val(gtgt);
          $('.invoice_buy_item_tax_total:eq('+rowIndex+')').val(nk+gtgt);

          $('.invoice_buy_item_total:eq('+rowIndex+')').val(roundDecimal(gt/sl,2));

          var tongtienhangnt = 0;
          $('.invoice_buy_item_price').each(function(){
            var rowIndex=$(this).closest('tr').index();
            var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
            tongtienhangnt += roundDecimal(parseFloat(get_number(this))*sl,2) || 0;
          });

          var tongtienhang = 0;
          $('.invoice_buy_item_money').each(function(){
            tongtienhang += parseFloat(get_number(this)) || 0;
          });

          var tongtienthuenhap = 0;
          $('.invoice_buy_item_tax_import').each(function(){
            tongtienthuenhap += parseFloat(get_number(this)) || 0;
          });

          var tongtienthuevat = 0;
          $('.invoice_buy_item_tax_vat').each(function(){
            tongtienthuevat += parseFloat(get_number(this)) || 0;
          });

          var tongchiphi = 0;
          var tongchiphi2 = 0;
          $('.invoice_buy_item_other_cost').each(function(){
            var rowIndex=$(this).closest('tr').index();
            var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
            tongchiphi2 += parseFloat(get_number(this))*sl || 0;
          });
          $('.invoice_buy_item_custom_cost_money').each(function(){
            var rowIndex=$(this).closest('tr').index();
            var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
            tongchiphi += roundDecimal((parseFloat(get_number(this)) || 0)*sl,2);
          });

          $('#import').html(tongtienthuenhap);
          $('#vat').html(tongtienthuevat);
          $('#cost_custom').html(tongchiphi);
          $('#cost_other').html(tongchiphi2);
          $('#money').html(tongtienhang);
          
          $('#total').html(tongtienthuenhap+tongtienhang+tongchiphi+tongchiphi2);

          $('#price').html(tongtienhangnt);

          $('#price').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });
          $('#total').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });

          $('#money').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });
          
          $('#import').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });

          $('#vat').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });

          $('#cost_custom').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });
          $('#cost_other').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });

          $('.numbers').val(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });
        });
        $(".invoice_buy_item_tax_vat_percent").keyup(function(){
          var rowIndex=$(this).closest('tr').index();
          var price = parseFloat(get_number('.invoice_buy_item_price:eq('+rowIndex+')')) || 0;
          var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
          var vat = parseFloat($(this).val()) || 0;
          var custom = parseFloat(get_number('.invoice_buy_item_custom_cost:eq('+rowIndex+')')) || 0;
          var custom_money = parseFloat(get_number('.invoice_buy_item_custom_cost_money:eq('+rowIndex+')')) || 0;
          var imp = parseFloat(get_number('.invoice_buy_item_tax_import_percent:eq('+rowIndex+')')) || 0;
          var cost = parseFloat(get_number('.invoice_buy_item_other_cost:eq('+rowIndex+')')) || 0;
          var custom_rate = parseFloat(get_number('.invoice_buy_item_custom_rate:eq('+rowIndex+')')) || 0;
          var rate = parseFloat(get_number('#invoice_buy_money_rate')) || 0;

          var nk = roundDecimal((price+custom)*custom_rate*sl*imp/100,0);
          var gtgt = roundDecimal((custom_rate*sl*(price+custom)+nk)*vat/100,0);

          var gt = sl*(roundDecimal(rate*price,2)+cost+custom_money)+nk;
          
          $('.invoice_buy_item_tax_import:eq('+rowIndex+')').val(nk);
          $('.invoice_buy_item_tax_vat:eq('+rowIndex+')').val(gtgt);
          $('.invoice_buy_item_tax_total:eq('+rowIndex+')').val(nk+gtgt);

          $('.invoice_buy_item_total:eq('+rowIndex+')').val(roundDecimal(gt/sl,2));

          var tongtienthuenhap = 0;
          $('.invoice_buy_item_tax_import').each(function(){
            tongtienthuenhap += parseFloat(get_number(this)) || 0;
          });

          var tongtienthuevat = 0;
          $('.invoice_buy_item_tax_vat').each(function(){
            tongtienthuevat += parseFloat(get_number(this)) || 0;
          });

          var tongchiphi = 0;
          var tongchiphi2 = 0;
          $('.invoice_buy_item_other_cost').each(function(){
            var rowIndex=$(this).closest('tr').index();
            var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
            tongchiphi2 += parseFloat(get_number(this))*sl || 0;
          });
          $('.invoice_buy_item_custom_cost_money').each(function(){
            var rowIndex=$(this).closest('tr').index();
            var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
            tongchiphi += roundDecimal((parseFloat(get_number(this)) || 0)*sl,2);
          });

          $('#import').html(tongtienthuenhap);
          $('#vat').html(tongtienthuevat);
          $('#cost_custom').html(tongchiphi);
          $('#cost_other').html(tongchiphi2);

          var tongtienhang = parseFloat($('#money').html().replace(/\,/g,''));

          $('#total').html(tongtienthuenhap+tongtienhang+tongchiphi+tongchiphi2);

          $('#total').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });
          
          $('#import').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });

          $('#vat').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });

          $('#cost_custom').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });
          $('#cost_other').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });

          $('.numbers').val(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });
        });
        $(".invoice_buy_item_tax_import_percent").keyup(function(){
          var rowIndex=$(this).closest('tr').index();
          var price = parseFloat(get_number('.invoice_buy_item_price:eq('+rowIndex+')')) || 0;
          var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
          var imp = parseFloat($(this).val()) || 0;
          var custom = parseFloat(get_number('.invoice_buy_item_custom_cost:eq('+rowIndex+')')) || 0;
          var custom_money = parseFloat(get_number('.invoice_buy_item_custom_cost_money:eq('+rowIndex+')')) || 0;
          var vat = parseFloat(get_number('.invoice_buy_item_tax_vat_percent:eq('+rowIndex+')')) || 0;
          var cost = parseFloat(get_number('.invoice_buy_item_other_cost:eq('+rowIndex+')')) || 0;
          var custom_rate = parseFloat(get_number('.invoice_buy_item_custom_rate:eq('+rowIndex+')')) || 0;
          var rate = parseFloat(get_number('#invoice_buy_money_rate')) || 0;

          var nk = roundDecimal((price+custom)*custom_rate*sl*imp/100,0);
          var gtgt = roundDecimal((custom_rate*sl*(price+custom)+nk)*vat/100,0);

          var gt = sl*(roundDecimal(rate*price,2)+cost+custom_money)+nk;
          
          $('.invoice_buy_item_tax_import:eq('+rowIndex+')').val(nk);
          $('.invoice_buy_item_tax_vat:eq('+rowIndex+')').val(gtgt);
          $('.invoice_buy_item_tax_total:eq('+rowIndex+')').val(nk+gtgt);

          $('.invoice_buy_item_total:eq('+rowIndex+')').val(roundDecimal(gt/sl,2));

          var tongtienthuenhap = 0;
          $('.invoice_buy_item_tax_import').each(function(){
            tongtienthuenhap += parseFloat(get_number(this)) || 0;
          });

          var tongtienthuevat = 0;
          $('.invoice_buy_item_tax_vat').each(function(){
            tongtienthuevat += parseFloat(get_number(this)) || 0;
          });

          var tongchiphi = 0;
          var tongchiphi2 = 0;
          $('.invoice_buy_item_other_cost').each(function(){
            var rowIndex=$(this).closest('tr').index();
            var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
            tongchiphi2 += parseFloat(get_number(this))*sl || 0;
          });
          $('.invoice_buy_item_custom_cost_money').each(function(){
            var rowIndex=$(this).closest('tr').index();
            var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
            tongchiphi += roundDecimal((parseFloat(get_number(this)) || 0)*sl,2);
          });

          $('#import').html(tongtienthuenhap);
          $('#vat').html(tongtienthuevat);
          $('#cost_custom').html(tongchiphi);
          $('#cost_other').html(tongchiphi2);

          var tongtienhang = parseFloat($('#money').html().replace(/\,/g,''));

          $('#total').html(tongtienthuenhap+tongtienhang+tongchiphi+tongchiphi2);

          $('#total').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });
          
          $('#import').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });

          $('#vat').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });

          $('#cost_custom').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });
          $('#cost_other').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });

          $('.numbers').val(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });
        });
        $(".invoice_buy_item_custom_rate").keyup(function(){
          var rowIndex=$(this).closest('tr').index();
          var price = parseFloat(get_number('.invoice_buy_item_price:eq('+rowIndex+')')) || 0;
          var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
          var custom_rate = parseFloat(get_number(this)) || 0;
          var custom = parseFloat(get_number('.invoice_buy_item_custom_cost:eq('+rowIndex+')')) || 0;
          var custom_money = parseFloat(get_number('.invoice_buy_item_custom_cost_money:eq('+rowIndex+')')) || 0;
          var vat = parseFloat(get_number('.invoice_buy_item_tax_vat_percent:eq('+rowIndex+')')) || 0;
          var cost = parseFloat(get_number('.invoice_buy_item_other_cost:eq('+rowIndex+')')) || 0;
          var imp = parseFloat(get_number('.invoice_buy_item_tax_import_percent:eq('+rowIndex+')')) || 0;
          var rate = parseFloat(get_number('#invoice_buy_money_rate')) || 0;

          var nk = roundDecimal((price+custom)*custom_rate*sl*imp/100,0);
          var gtgt = roundDecimal((custom_rate*sl*(price+custom)+nk)*vat/100,0);

          var gt = sl*(roundDecimal(rate*price,2)+cost+custom_money)+nk;
          
          $('.invoice_buy_item_tax_import:eq('+rowIndex+')').val(nk);
          $('.invoice_buy_item_tax_vat:eq('+rowIndex+')').val(gtgt);
          $('.invoice_buy_item_tax_total:eq('+rowIndex+')').val(nk+gtgt);

          $('.invoice_buy_item_total:eq('+rowIndex+')').val(roundDecimal(gt/sl,2));

          var tongtienthuenhap = 0;
          $('.invoice_buy_item_tax_import').each(function(){
            tongtienthuenhap += parseFloat(get_number(this)) || 0;
          });

          var tongtienthuevat = 0;
          $('.invoice_buy_item_tax_vat').each(function(){
            tongtienthuevat += parseFloat(get_number(this)) || 0;
          });

          var tongchiphi = 0;
          var tongchiphi2 = 0;
          $('.invoice_buy_item_other_cost').each(function(){
            var rowIndex=$(this).closest('tr').index();
            var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
            tongchiphi2 += parseFloat(get_number(this))*sl || 0;
          });
          $('.invoice_buy_item_custom_cost_money').each(function(){
            var rowIndex=$(this).closest('tr').index();
            var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
            tongchiphi += roundDecimal((parseFloat(get_number(this)) || 0)*sl,2);
          });

          $('#import').html(tongtienthuenhap);
          $('#vat').html(tongtienthuevat);
          $('#cost_custom').html(tongchiphi);
          $('#cost_other').html(tongchiphi2);

          var tongtienhang = parseFloat($('#money').html().replace(/\,/g,''));

          $('#total').html(tongtienthuenhap+tongtienhang+tongchiphi+tongchiphi2);

          $('#total').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });
          
          $('#import').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });

          $('#vat').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });

          $('#cost_custom').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });
          $('#cost_other').html(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });

          $('.numbers').val(function(index, value) {
            return value
              .replace(/[^0-9-.]/g, "")
              .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            ;
          });
        });

        
        $('.invoice_buy_item_house').keyup(function(){
          var row = $(this).parent().parent();
          var rowIndex = (row[0].rowIndex)-1;
          var keyword = $(this).val();
          if(keyword != ""){
            $.ajax({
                url: '<?php echo BASE_URL ?>/invoicebuy/getHouse',
                type: 'POST',
                data: {keyword:keyword, offset:rowIndex},
                success:function(data){
                    $('.name_list_id_4:eq('+rowIndex+')').slideDown(200);
                    $('.name_list_id_4:eq('+rowIndex+')').html(data);
                }
            });
          }

          if ($('.invoice_buy_item_house:eq('+rowIndex+')').val() == "" || $('.invoice_buy_item_house:eq('+rowIndex+')').attr('data') == "") {
            $('.invoice_buy_item_house:eq('+rowIndex+')').attr('data',"");
          }
        });
        $('.invoice_buy_item').keyup(function(){
            var row = $(this).parent().parent();
            var rowIndex = (row[0].rowIndex)-1;
            var keyword = $(this).val();
            if(keyword != ""){
              $.ajax({
                  url: '<?php echo BASE_URL ?>/invoicebuy/getItemName',
                  type: 'POST',
                  data: {keyword:keyword, offset:rowIndex},
                  success:function(data){
                      $('.name_list_id:eq('+rowIndex+')').slideDown(200);
                      $('.name_list_id:eq('+rowIndex+')').html(data);
                  }
              });
            }

            if ($('.invoice_buy_item:eq('+rowIndex+')').val() == "" || $('.invoice_buy_item:eq('+rowIndex+')').attr('data') == "") {
              $('.invoice_buy_item:eq('+rowIndex+')').attr('data',"");
            }
        });
        $('.invoice_buy_item_debit').keyup(function(){
            var row = $(this).parent().parent();
            var rowIndex = (row[0].rowIndex)-1;
            var keyword = $(this).val();
            var name = ".invoice_buy_item_debit";
            if(keyword != ""){
              $.ajax({
                  url: '<?php echo BASE_URL ?>/invoicebuy/getAccount',
                  type: 'POST',
                  data: {keyword:keyword, offset:rowIndex, name:name},
                  success:function(data){
                      $('.name_list_id_2:eq('+rowIndex+')').slideDown(200);
                      $('.name_list_id_2:eq('+rowIndex+')').html(data);
                  }
              });
            }

            if ($('.invoice_buy_item_debit:eq('+rowIndex+')').val() == "" || $('.invoice_buy_item_debit:eq('+rowIndex+')').attr('data') == "") {
              $('.invoice_buy_item_debit:eq('+rowIndex+')').attr('data',"");
            }
        });
        $('.invoice_buy_item_credit').keyup(function(){
            var row = $(this).parent().parent();
            var rowIndex = (row[0].rowIndex)-1;
            var keyword = $(this).val();
            var name = ".invoice_buy_item_credit";
            if(keyword != ""){
              $.ajax({
                url: '<?php echo BASE_URL ?>/invoicebuy/getAccount',
                type: 'POST',
                data: {keyword:keyword, offset:rowIndex, name:name},
                success:function(data){
                    $('.name_list_id_3:eq('+rowIndex+')').slideDown(200);
                    $('.name_list_id_3:eq('+rowIndex+')').html(data);
                }
              });
            }
            

            if ($('.invoice_buy_item_credit:eq('+rowIndex+')').val() == "" || $('.invoice_buy_item_credit:eq('+rowIndex+')').attr('data') == "") {
              $('.invoice_buy_item_credit:eq('+rowIndex+')').attr('data',"");
            }
        });
        $('.invoice_buy_item_tax_import_debit').keyup(function(){
            var row = $(this).parent().parent();
            var rowIndex = (row[0].rowIndex)-1;
            var keyword = $(this).val();
            var name = ".invoice_buy_item_tax_import_debit";
            if(keyword != ""){
              $.ajax({
                  url: '<?php echo BASE_URL ?>/invoicebuy/getAccount',
                  type: 'POST',
                  data: {keyword:keyword, offset:rowIndex, name:name},
                  success:function(data){
                      $('.name_list_id_5:eq('+rowIndex+')').slideDown(200);
                      $('.name_list_id_5:eq('+rowIndex+')').html(data);
                  }
              });
            }

            if ($('.invoice_buy_item_tax_import_debit:eq('+rowIndex+')').val() == "" || $('.invoice_buy_item_tax_import_debit:eq('+rowIndex+')').attr('data') == "") {
              $('.invoice_buy_item_tax_import_debit:eq('+rowIndex+')').attr('data',"");
            }
        });
        $('.invoice_buy_item_tax_vat_debit').keyup(function(){
            var row = $(this).parent().parent();
            var rowIndex = (row[0].rowIndex)-1;
            var keyword = $(this).val();
            var name = ".invoice_buy_item_tax_vat_debit";
            if(keyword != ""){
              $.ajax({
                  url: '<?php echo BASE_URL ?>/invoicebuy/getAccount',
                  type: 'POST',
                  data: {keyword:keyword, offset:rowIndex, name:name},
                  success:function(data){
                      $('.name_list_id_6:eq('+rowIndex+')').slideDown(200);
                      $('.name_list_id_6:eq('+rowIndex+')').html(data);
                  }
              });
            }

            if ($('.invoice_buy_item_tax_vat_debit:eq('+rowIndex+')').val() == "" || $('.invoice_buy_item_tax_vat_debit:eq('+rowIndex+')').attr('data') == "") {
              $('.invoice_buy_item_tax_vat_debit:eq('+rowIndex+')').attr('data',"");
            }
        });
        $('.invoice_buy_item_tax_vat_credit').keyup(function(){
            var row = $(this).parent().parent();
            var rowIndex = (row[0].rowIndex)-1;
            var keyword = $(this).val();
            var name = ".invoice_buy_item_tax_vat_credit";
            if(keyword != ""){
              $.ajax({
                  url: '<?php echo BASE_URL ?>/invoicebuy/getAccount',
                  type: 'POST',
                  data: {keyword:keyword, offset:rowIndex, name:name},
                  success:function(data){
                      $('.name_list_id_7:eq('+rowIndex+')').slideDown(200);
                      $('.name_list_id_7:eq('+rowIndex+')').html(data);
                  }
              });
            }

            if ($('.invoice_buy_item_tax_vat_credit:eq('+rowIndex+')').val() == "" || $('.invoice_buy_item_tax_vat_credit:eq('+rowIndex+')').attr('data') == "") {
              $('.invoice_buy_item_tax_vat_credit:eq('+rowIndex+')').attr('data',"");
            }
        });
        $('.invoice_buy_item_custom_cost_debit').keyup(function(){
            var row = $(this).parent().parent();
            var rowIndex = (row[0].rowIndex)-1;
            var keyword = $(this).val();
            var name = ".invoice_buy_item_custom_cost_debit";
            if(keyword != ""){
              $.ajax({
                  url: '<?php echo BASE_URL ?>/invoicebuy/getAccount',
                  type: 'POST',
                  data: {keyword:keyword, offset:rowIndex, name:name},
                  success:function(data){
                      $('.name_list_id_8:eq('+rowIndex+')').slideDown(200);
                      $('.name_list_id_8:eq('+rowIndex+')').html(data);
                  }
              });
            }

            if ($('.invoice_buy_item_custom_cost_debit:eq('+rowIndex+')').val() == "" || $('.invoice_buy_item_custom_cost_debit:eq('+rowIndex+')').attr('data') == "") {
              $('.invoice_buy_item_custom_cost_debit:eq('+rowIndex+')').attr('data',"");
            }
        });
        function set_item_account(value,code,name,vitri) {
            $(name+':eq('+vitri+')').val(code);
            $(name+':eq('+vitri+')').attr("data",value);
            
            $('.name_list_id_2').hide();
            $('.name_list_id_3').hide();
            $('.name_list_id_5').hide();
            $('.name_list_id_6').hide();
            $('.name_list_id_7').hide();
            $('.name_list_id_8').hide();
            $(name+':eq('+vitri+')').focus();
        }
        function set_item_house(value,code,name,vitri) {
            $('.invoice_buy_item_house:eq('+vitri+')').val(code);
            $('.invoice_buy_item_house:eq('+vitri+')').attr("data",value);
            
            $('.name_list_id_4').hide();
            $('.invoice_buy_item_house:eq('+vitri+')').focus();
        }
        function set_item(value,code,name,unit,tax,stuff,vitri) {
            $('.invoice_buy_item:eq('+vitri+')').val(code);
            $('.invoice_buy_item:eq('+vitri+')').attr("data",value);
            $('.invoice_buy_item_number:eq('+vitri+')').attr("alt",stuff);
            $('.invoice_buy_item_name:eq('+vitri+')').val(name);
            $('.invoice_buy_item_unit:eq('+vitri+')').val(unit);
            $('.invoice_buy_item_tax_vat_percent:eq('+vitri+')').val(tax);
            $('.invoice_buy_item2:eq('+vitri+')').val(code);
            $('.invoice_buy_item_name2:eq('+vitri+')').val(name);
            $('.name_list_id').hide();
            $('.invoice_buy_item:eq('+vitri+')').focus();

            var check = 0;
            var val = value;
            $('.invoice_buy_item').each(function(){
              if (val == $(this).attr('data')) {
                check++
              }
            });

            if (check>=2) {
              alert('Mã đã tồn tại. Vui lòng chọn mã khác!');
              $('.invoice_buy_item:eq('+vitri+')').val("");
              $('.invoice_buy_item:eq('+vitri+')').attr("data","");
              $('.invoice_buy_item:eq('+vitri+')').attr("alt","");
              $('.invoice_buy_item_name:eq('+vitri+')').val("");
              $('.invoice_buy_item_unit:eq('+vitri+')').val("");
              $('.invoice_buy_item_tax_vat_percent:eq('+vitri+')').val("");
              $('.invoice_buy_item2:eq('+vitri+')').val("");
              $('.invoice_buy_item_name2:eq('+vitri+')').val("");
            }
        }


          $(".find_item").click(function(){
            var rowIndex=$(this).closest('tr').index();
            $('#rowIndex_item').val(rowIndex);
              $.ajax({
                  url: '<?php echo BASE_URL ?>/invoicebuy/getItem',
                  type: 'POST',
                  data: {rowIndex:rowIndex},
                  success:function(data){
                    $('#show_item').html(data);
                    $("#show_item" ).dialog( "open" );

                    $('#tblExport2').DataTable({
                        "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Tất cả"]],
                        "order": [[ 1, "asc" ], [ 2, "asc" ]],
                        "columnDefs": [ {
                          "targets": 0,
                          "orderable": false
                        } ],
                        "fnRowCallback": function( nRow, aData, iDisplayIndex, iDisplayIndexFull ) {
                          var index = iDisplayIndex +1;
                            $('.tr td:eq(0)',nRow).html(index);
                            return nRow
                        }
                    });

                    $('.tr').click(function(){
                      $(this).find('input').each(function () {
                        if ($(this).is(':checked')) {
                          $(this).prop('checked',false);
                        }
                        else{
                          $(this).prop('checked',true);
                        }
                      });
                    });
                  }

              });
          });
        }
    });


    $( ".add-field" ).dialog( "open" );
      
});

function add_click(){
    $('#yes').val("");
    $('.add-field').slideDown(500);
     $("html, body").animate({ scrollTop: $('.add-field').offset().top }, 300);   
     
        $('.add-field input[name!="invoice_buy_allocation"][name!="invoice_buy_allocation2"][name!="invoice_buy_item_debit[]"][name!="invoice_buy_item_credit[]"][name!="invoice_buy_item_tax_import_debit[]"][name!="invoice_buy_item_tax_vat_debit[]"][name!="invoice_buy_item_tax_vat_credit[]"]').val("");
        $('.add-field input').attr("data","");
        $('.add-field input').attr("alt","");
        $('#invoice_buy_money_type option[value=2]').attr("selected","selected");
        $('#invoice_buy_money_rate').val(1);
        $('.add-field input[type=date]').val("<?php echo date('Y-m-d') ?>");
        //$('#invoice_buy_number').val('0000000');
        $('#invoice_buy_document_number').val('<?php echo ++$lastID ?>');

        $('#invoice_buy_bill_number').focus();
                
        $('.numbers').focus(function(){
            if ( $(this).val() == '0') {
               $(this).val(""); 
            };
            
        });
        $('.numbers').blur(function(){
            if ( $(this).val() == "") {
                $(this).val(0);
            };
            
        });

    $( ".add-field" ).dialog( "open" );
}

$(document).ready(function(){
  // Validate form
  $("#add_invoice_buy").validate({
      errorElement: "span", // Định dạng cho thẻ HTML hiện thông báo lỗi
      rules: {

      },
      submitHandler: function(form) {
        var invoice_buy_bill_number = $('#invoice_buy_bill_number').val();
        var invoice_buy_contract_number = $('#invoice_buy_contract_number').val();
        var invoice_buy_customer = $('#invoice_buy_customer').attr('data');
        var invoice_buy_comment = $('#invoice_buy_comment').val();
        var invoice_buy_origin_doc = $('#invoice_buy_origin_doc').val();
        var invoice_buy_document_date = $('#invoice_buy_document_date').val();
        var invoice_buy_document_number = $('#invoice_buy_document_number').val();
        var invoice_buy_additional_date = $('#invoice_buy_additional_date').val();
        var invoice_buy_date = $('#invoice_buy_date').val();
        var invoice_buy_number = $('#invoice_buy_number').val();
        var invoice_buy_symbol = $('#invoice_buy_symbol').val();
        var invoice_buy_money_type = $('#invoice_buy_money_type').val();
        var invoice_buy_money_rate = $('#invoice_buy_money_rate').val();

        var invoice_buy_allocation = $('input[name="invoice_buy_allocation"]:checked').val();
        var invoice_buy_allocation2 = $('input[name="invoice_buy_allocation2"]:checked').val();

        if (invoice_buy_customer == "") {
          alert('Vui lòng chọn nhà cung cấp!');
          $('#invoice_buy_customer').focus();
          return false;
        }

        var service_buy = [];
        var service_buy_id = [];
        var service_buy_total = [];

        $('.service_buy').each(function(){
          service_buy_id.push($(this).attr('data'));
        });
        $('.service_buy_total').each(function(){
          service_buy_total.push($(this).attr('value'));
        });

        for (var j = 0; j < service_buy_id.length; j++) {
          service_buy.push({'service_buy_id':service_buy_id[j],'service_buy_total':service_buy_total[j]});
        }

        var service_buy2 = [];
        var service_buy_id2 = [];
        var service_buy_total2 = [];
        var service_buy_total2_foreign = [];

        $('.service_buy2').each(function(){
          service_buy_id2.push($(this).attr('data'));
        });
        $('.service_buy_total2').each(function(){
          service_buy_total2.push($(this).attr('value'));
          service_buy_total2_foreign.push($(this).attr('data'));
        });

        for (var l = 0; l < service_buy_id2.length; l++) {
          service_buy2.push({'service_buy_id':service_buy_id2[l],'service_buy_total':service_buy_total2[l],'service_buy_total_foreign':service_buy_total2_foreign[l]});
        }

        var item = [];
        var invoice_buy_item = [];
        var invoice_buy_item_house = [];
        var invoice_buy_item_debit = [];
        var invoice_buy_item_credit = [];
        var invoice_buy_item_unit = [];
        var invoice_buy_item_number = [];
        var invoice_buy_item_price = [];
        var invoice_buy_item_money = [];
        var invoice_buy_item_custom_cost = [];
        var invoice_buy_item_custom_cost_money = [];
        var invoice_buy_item_other_cost = [];
        var invoice_buy_item_total = [];
        var invoice_buy_item_custom_rate = [];
        var invoice_buy_item_tax_import_percent = [];
        var invoice_buy_item_tax_import = [];
        var invoice_buy_item_tax_import_debit = [];
        var invoice_buy_item_tax_vat_percent = [];
        var invoice_buy_item_tax_vat = [];
        var invoice_buy_item_tax_vat_debit = [];
        var invoice_buy_item_tax_vat_credit = [];
        var invoice_buy_item_tax_total = [];

        $('.invoice_buy_item').each(function(){
          invoice_buy_item.push($(this).attr('data'));
        });
        $('.invoice_buy_item_house').each(function(){
          invoice_buy_item_house.push($(this).attr('value'));
        });
        $('.invoice_buy_item_debit').each(function(){
          invoice_buy_item_debit.push($(this).attr('value'));
        });
        $('.invoice_buy_item_credit').each(function(){
          invoice_buy_item_credit.push($(this).attr('value'));
        });
        $('.invoice_buy_item_unit').each(function(){
          invoice_buy_item_unit.push($(this).attr('value'));
        });
        $('.invoice_buy_item_number').each(function(){
          invoice_buy_item_number.push($(this).attr('value'));
        });
        $('.invoice_buy_item_price').each(function(){
          invoice_buy_item_price.push($(this).attr('value'));
        });
        $('.invoice_buy_item_money').each(function(){
          invoice_buy_item_money.push($(this).attr('value'));
        });
        $('.invoice_buy_item_custom_cost').each(function(){
          invoice_buy_item_custom_cost.push($(this).attr('value'));
        });
        $('.invoice_buy_item_custom_cost_money').each(function(){
          invoice_buy_item_custom_cost_money.push($(this).attr('value'));
        });
        $('.invoice_buy_item_other_cost').each(function(){
          invoice_buy_item_other_cost.push($(this).attr('value'));
        });
        $('.invoice_buy_item_total').each(function(){
          invoice_buy_item_total.push($(this).attr('value'));
        });
        $('.invoice_buy_item_custom_rate').each(function(){
          invoice_buy_item_custom_rate.push($(this).attr('value'));
        });
        $('.invoice_buy_item_tax_import_percent').each(function(){
          invoice_buy_item_tax_import_percent.push($(this).attr('value'));
        });
        $('.invoice_buy_item_tax_import').each(function(){
          invoice_buy_item_tax_import.push($(this).attr('value'));
        });
        $('.invoice_buy_item_tax_import_debit').each(function(){
          invoice_buy_item_tax_import_debit.push($(this).attr('value'));
        });
        $('.invoice_buy_item_tax_vat_percent').each(function(){
          invoice_buy_item_tax_vat_percent.push($(this).attr('value'));
        });
        $('.invoice_buy_item_tax_vat').each(function(){
          invoice_buy_item_tax_vat.push($(this).attr('value'));
        });
        $('.invoice_buy_item_tax_vat_debit').each(function(){
          invoice_buy_item_tax_vat_debit.push($(this).attr('value'));
        });
        $('.invoice_buy_item_tax_vat_credit').each(function(){
          invoice_buy_item_tax_vat_credit.push($(this).attr('value'));
        });
        $('.invoice_buy_item_tax_total').each(function(){
          invoice_buy_item_tax_total.push($(this).attr('value'));
        });

        for (var i = 0; i < invoice_buy_item.length; i++) {
          item.push({'invoice_buy_item':invoice_buy_item[i], 'invoice_buy_item_house':invoice_buy_item_house[i], 'invoice_buy_item_debit':invoice_buy_item_debit[i], 'invoice_buy_item_credit':invoice_buy_item_credit[i], 'invoice_buy_item_unit':invoice_buy_item_unit[i], 'invoice_buy_item_number':invoice_buy_item_number[i], 'invoice_buy_item_price':invoice_buy_item_price[i], 'invoice_buy_item_money':invoice_buy_item_money[i], 'invoice_buy_item_custom_cost':invoice_buy_item_custom_cost[i], 'invoice_buy_item_custom_cost_money':invoice_buy_item_custom_cost_money[i], 'invoice_buy_item_other_cost':invoice_buy_item_other_cost[i], 'invoice_buy_item_total':invoice_buy_item_total[i], 'invoice_buy_item_custom_rate':invoice_buy_item_custom_rate[i], 'invoice_buy_item_tax_import_percent':invoice_buy_item_tax_import_percent[i], 'invoice_buy_item_tax_import':invoice_buy_item_tax_import[i], 'invoice_buy_item_tax_import_debit':invoice_buy_item_tax_import_debit[i], 'invoice_buy_item_tax_vat_percent':invoice_buy_item_tax_vat_percent[i], 'invoice_buy_item_tax_vat':invoice_buy_item_tax_vat[i], 'invoice_buy_item_tax_vat_debit':invoice_buy_item_tax_vat_debit[i], 'invoice_buy_item_tax_vat_credit':invoice_buy_item_tax_vat_credit[i], 'invoice_buy_item_tax_total':invoice_buy_item_tax_total[i]});
                
        };

        var yes = $('#yes').val();

        $.ajax({
          url: '<?php echo BASE_URL ?>/invoicebuy/add',
          type: 'POST',
          data: {
            yes: yes,
            invoice_buy_bill_number: invoice_buy_bill_number,
            invoice_buy_contract_number: invoice_buy_contract_number,
            invoice_buy_customer: invoice_buy_customer,
            invoice_buy_comment: invoice_buy_comment,
            invoice_buy_origin_doc: invoice_buy_origin_doc,
            invoice_buy_document_date: invoice_buy_document_date,
            invoice_buy_document_number: invoice_buy_document_number,
            invoice_buy_additional_date: invoice_buy_additional_date,
            invoice_buy_number: invoice_buy_number,
            invoice_buy_symbol: invoice_buy_symbol,
            invoice_buy_date: invoice_buy_date,
            invoice_buy_money_type: invoice_buy_money_type,
            invoice_buy_money_rate: invoice_buy_money_rate,
            invoice_buy_allocation:invoice_buy_allocation,
            invoice_buy_allocation2:invoice_buy_allocation2,
            item: item,
            service_buy:service_buy,
            service_buy2:service_buy2,
          },
          success:function(answer){
              //alert(answer);
              $('#error').hide();
              $('#error').slideToggle(100); // hiển thị thẻ div success
              $('#error').html('<div class="successbox">'+answer+'</div>'); // đặt kết quả trả về từ test.php vào thẻ div success
              $('#error').fadeOut(10000);

              if (yes != "") {
                  if (answer.trim() == "Cập nhật thành công" ) {
                      setTimeout(function() {
                        sapxep('<?php echo $page ?>','<?php echo $order_by ?>','<?php echo $order ?>');
                      }, 200);
                      
                  }
              }
              else{
                  if (answer.trim() == "Thêm thành công" ) {
                      setTimeout(function() {
                        sapxep('<?php echo $page ?>','<?php echo $order_by ?>','<?php echo $order ?>');
                      }, 200);
                      
                  }
              }
          }
        });

      }
    });
});
</script>

<script type="text/javascript">
function roundDecimal(value, decimals) {
  return Number(Math.round(value+'e'+decimals)+'e-'+decimals);
}
function get_number(id){
  return $(id).val().replace(/\,/g,'');
}

$( ".add-field" ).dialog({
    autoOpen: false,
    modal: true,
    width: "90%",
    title: "Mua hàng nhập khẩu nhập kho",
    hide: 'fold',
    show: 'blind',
    position: ['center',5],
});


$("#import_excel").click(function(){
        $("#winpopup").dialog({
            draggable:true,
            modal: true,
            autoOpen: false,
            height:300,
            width:400,
            resizable: false,
            title:'Import Excel',
            
        });
        $("#winpopup").load($(this).attr('href'));
        $("#winpopup").dialog("open");
         
        return false;
    });


 
var x = "<?php echo $limit ?>";
$('#chonloc option[value='+x+']').attr('selected','selected');

$('.numbers').keyup(function(event) {
      // skip for arrow keys
  if(event.which >= 37 && event.which <= 40) return;
  // format number
  $(this).val(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });
});

/*$('#invoice_buy_number').keyup(function(){
    var val = $(this).val();
    $(this).val(val.substring(1, val.length));

    var val_new = $(this).val();
    if (val_new.length<7) {
        $(this).val("0"+val_new);
    }
});*/
$('input[name="invoice_buy_allocation').change(function(){
  if ($(this).val()==1) {
    var money=0;
    $('.service_buy_total').each(function(){
      money += parseFloat(get_number(this)) || 0;
    });

    var percent=0;
    $('.invoice_buy_item_number').each(function(){
      var s = parseFloat($(this).val()) || 0;
      var st = parseFloat($(this).attr('alt')) || 0;
      percent += s/st;
    });

    $('.invoice_buy_item_number').each(function(){
      var rowIndex=$(this).closest('tr').index();
      var val = parseFloat($(this).val()) || 0;
      var stuff = parseFloat($(this).attr('alt')) || 0;
      if (val > 0) {
        var cost = roundDecimal(money/(stuff*percent),2);
        $('.invoice_buy_item_other_cost:eq('+rowIndex+')').val(cost);

        var price = parseFloat(get_number('.invoice_buy_item_price:eq('+rowIndex+')')) || 0;
        var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
        var vat = parseFloat(get_number('.invoice_buy_item_tax_vat_percent:eq('+rowIndex+')')) || 0;
        var imp = parseFloat(get_number('.invoice_buy_item_tax_import_percent:eq('+rowIndex+')')) || 0;
        var custom = parseFloat(get_number('.invoice_buy_item_custom_cost:eq('+rowIndex+')')) || 0;
        var custom_money = parseFloat(get_number('.invoice_buy_item_custom_cost_money:eq('+rowIndex+')')) || 0;
        var custom_rate = parseFloat(get_number('.invoice_buy_item_custom_rate:eq('+rowIndex+')')) || 0;
        var rate = parseFloat(get_number('#invoice_buy_money_rate')) || 0;
        
        var nk = roundDecimal((price+custom)*custom_rate*sl*imp/100,0);
        var gtgt = roundDecimal((custom_rate*sl*(price+custom)+nk)*vat/100,0);

        var gt = sl*(roundDecimal(rate*price,2)+cost+custom_money)+nk;
        
        $('.invoice_buy_item_tax_import:eq('+rowIndex+')').val(nk);
        $('.invoice_buy_item_tax_vat:eq('+rowIndex+')').val(gtgt);
        $('.invoice_buy_item_tax_total:eq('+rowIndex+')').val(nk+gtgt);

        $('.invoice_buy_item_total:eq('+rowIndex+')').val(roundDecimal(gt/sl,2));

        var tongtienhang = 0;
        $('.invoice_buy_item_money').each(function(){
          tongtienhang += parseFloat(get_number(this)) || 0;
        });

        var tongtienthuenhap = 0;
        $('.invoice_buy_item_tax_import').each(function(){
          tongtienthuenhap += parseFloat(get_number(this)) || 0;
        });

        var tongtienthuevat = 0;
        $('.invoice_buy_item_tax_vat').each(function(){
          tongtienthuevat += parseFloat(get_number(this)) || 0;
        });

        var tongchiphi = 0;
        var tongchiphi2 = 0;
        $('.invoice_buy_item_other_cost').each(function(){
          var rowIndex=$(this).closest('tr').index();
          var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
          tongchiphi2 += parseFloat(get_number(this))*sl || 0;
        });
        $('.invoice_buy_item_custom_cost_money').each(function(){
          var rowIndex=$(this).closest('tr').index();
          var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
          tongchiphi += roundDecimal((parseFloat(get_number(this)) || 0)*sl,2);
        });

        $('#import').html(tongtienthuenhap);
        $('#vat').html(tongtienthuevat);
        $('#cost_custom').html(tongchiphi);
        $('#cost_other').html(tongchiphi2);
        $('#money').html(tongtienhang);
        
        $('#total').html(tongtienthuenhap+tongtienhang+tongchiphi+tongchiphi2);

        $('#total').html(function(index, value) {
          return value
            .replace(/[^0-9-.]/g, "")
            .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
          ;
        });

        $('#money').html(function(index, value) {
          return value
            .replace(/[^0-9-.]/g, "")
            .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
          ;
        });
        
        $('#import').html(function(index, value) {
          return value
            .replace(/[^0-9-.]/g, "")
            .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
          ;
        });

        $('#vat').html(function(index, value) {
          return value
            .replace(/[^0-9-.]/g, "")
            .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
          ;
        });

        $('#cost_custom').html(function(index, value) {
          return value
            .replace(/[^0-9-.]/g, "")
            .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
          ;
        });
        $('#cost_other').html(function(index, value) {
          return value
            .replace(/[^0-9-.]/g, "")
            .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
          ;
        });

        $('.numbers').val(function(index, value) {
          return value
            .replace(/[^0-9-.]/g, "")
            .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
          ;
        });
      }
    });
  }
  else{
    var money=0;
    $('.service_buy_total').each(function(){
      money += parseFloat(get_number(this)) || 0;
    });
    var num=0;
    $('.invoice_buy_item_number').each(function(){
      num += parseFloat($(this).val()) || 0;
    });
    $('.invoice_buy_item_number').each(function(){
      var rowIndex=$(this).closest('tr').index();
      var val = parseFloat($(this).val()) || 0;
      if (val > 0) {
        var cost = roundDecimal(money/num,2);
        $('.invoice_buy_item_other_cost:eq('+rowIndex+')').val(cost);

        var price = parseFloat(get_number('.invoice_buy_item_price:eq('+rowIndex+')')) || 0;
        var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
        var vat = parseFloat(get_number('.invoice_buy_item_tax_vat_percent:eq('+rowIndex+')')) || 0;
        var imp = parseFloat(get_number('.invoice_buy_item_tax_import_percent:eq('+rowIndex+')')) || 0;
        var custom = parseFloat(get_number('.invoice_buy_item_custom_cost:eq('+rowIndex+')')) || 0;
        var custom_money = parseFloat(get_number('.invoice_buy_item_custom_cost_money:eq('+rowIndex+')')) || 0;
        var custom_rate = parseFloat(get_number('.invoice_buy_item_custom_rate:eq('+rowIndex+')')) || 0;
        var rate = parseFloat(get_number('#invoice_buy_money_rate')) || 0;
        
        var nk = roundDecimal((price+custom)*custom_rate*sl*imp/100,0);
        var gtgt = roundDecimal((custom_rate*sl*(price+custom)+nk)*vat/100,0);

        var gt = sl*(roundDecimal(rate*price,2)+cost+custom_money)+nk;
        
        $('.invoice_buy_item_tax_import:eq('+rowIndex+')').val(nk);
        $('.invoice_buy_item_tax_vat:eq('+rowIndex+')').val(gtgt);
        $('.invoice_buy_item_tax_total:eq('+rowIndex+')').val(nk+gtgt);

        $('.invoice_buy_item_total:eq('+rowIndex+')').val(roundDecimal(gt/sl,2));

        var tongtienhang = 0;
        $('.invoice_buy_item_money').each(function(){
          tongtienhang += parseFloat(get_number(this)) || 0;
        });

        var tongtienthuenhap = 0;
        $('.invoice_buy_item_tax_import').each(function(){
          tongtienthuenhap += parseFloat(get_number(this)) || 0;
        });

        var tongtienthuevat = 0;
        $('.invoice_buy_item_tax_vat').each(function(){
          tongtienthuevat += parseFloat(get_number(this)) || 0;
        });

        var tongchiphi = 0;
        var tongchiphi2 = 0;
        $('.invoice_buy_item_other_cost').each(function(){
          var rowIndex=$(this).closest('tr').index();
          var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
          tongchiphi2 += parseFloat(get_number(this))*sl || 0;
        });
        $('.invoice_buy_item_custom_cost_money').each(function(){
          var rowIndex=$(this).closest('tr').index();
          var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
          tongchiphi += roundDecimal((parseFloat(get_number(this)) || 0)*sl,2);
        });

        $('#import').html(tongtienthuenhap);
        $('#vat').html(tongtienthuevat);
        $('#cost_custom').html(tongchiphi);
        $('#cost_other').html(tongchiphi2);
        $('#money').html(tongtienhang);
        
        $('#total').html(tongtienthuenhap+tongtienhang+tongchiphi+tongchiphi2);

        $('#total').html(function(index, value) {
          return value
            .replace(/[^0-9-.]/g, "")
            .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
          ;
        });

        $('#money').html(function(index, value) {
          return value
            .replace(/[^0-9-.]/g, "")
            .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
          ;
        });
        
        $('#import').html(function(index, value) {
          return value
            .replace(/[^0-9-.]/g, "")
            .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
          ;
        });

        $('#vat').html(function(index, value) {
          return value
            .replace(/[^0-9-.]/g, "")
            .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
          ;
        });

        $('#cost_custom').html(function(index, value) {
          return value
            .replace(/[^0-9-.]/g, "")
            .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
          ;
        });
        $('#cost_other').html(function(index, value) {
          return value
            .replace(/[^0-9-.]/g, "")
            .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
          ;
        });

        $('.numbers').val(function(index, value) {
          return value
            .replace(/[^0-9-.]/g, "")
            .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
          ;
        });
      }
    });
  }
});
$('input[name="invoice_buy_allocation2').change(function(){
  if ($(this).val()==1) {
    var money=0;
    var money_foreign=0;
    $('.service_buy_total2').each(function(){
      money += parseFloat(get_number(this)) || 0;
      money_foreign += parseFloat($(this).attr('data').replace(/\,/g,'')) || 0;
    });

    var percent=0;
    $('.invoice_buy_item_number').each(function(){
      var s = parseFloat($(this).val()) || 0;
      var st = parseFloat($(this).attr('alt')) || 0;
      percent += s/st;
    });

    $('.invoice_buy_item_number').each(function(){
      var rowIndex=$(this).closest('tr').index();
      var val = parseFloat($(this).val()) || 0;
      var stuff = parseFloat($(this).attr('alt')) || 0;
      if (val > 0) {
        var cost = roundDecimal(money/(stuff*percent),2);
        var cost_foreign = roundDecimal(money_foreign/(stuff*percent),6);
        $('.invoice_buy_item_custom_cost:eq('+rowIndex+')').val(cost_foreign);
        $('.invoice_buy_item_custom_cost_money:eq('+rowIndex+')').val(cost);

        var price = parseFloat(get_number('.invoice_buy_item_price:eq('+rowIndex+')')) || 0;
        var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
        var vat = parseFloat(get_number('.invoice_buy_item_tax_vat_percent:eq('+rowIndex+')')) || 0;
        var imp = parseFloat(get_number('.invoice_buy_item_tax_import_percent:eq('+rowIndex+')')) || 0;
        var custom = parseFloat(get_number('.invoice_buy_item_custom_cost:eq('+rowIndex+')')) || 0;
        var custom_money = parseFloat(get_number('.invoice_buy_item_custom_cost_money:eq('+rowIndex+')')) || 0;
        var custom_rate = parseFloat(get_number('.invoice_buy_item_custom_rate:eq('+rowIndex+')')) || 0;
        var rate = parseFloat(get_number('#invoice_buy_money_rate')) || 0;
        
        var nk = roundDecimal((price+custom)*custom_rate*sl*imp/100,0);
        var gtgt = roundDecimal((custom_rate*sl*(price+custom)+nk)*vat/100,0);

        var gt = sl*(roundDecimal(rate*price,2)+cost+custom_money)+nk;
        
        $('.invoice_buy_item_tax_import:eq('+rowIndex+')').val(nk);
        $('.invoice_buy_item_tax_vat:eq('+rowIndex+')').val(gtgt);
        $('.invoice_buy_item_tax_total:eq('+rowIndex+')').val(nk+gtgt);

        $('.invoice_buy_item_total:eq('+rowIndex+')').val(roundDecimal(gt/sl,2));

        var tongtienhang = 0;
        $('.invoice_buy_item_money').each(function(){
          tongtienhang += parseFloat(get_number(this)) || 0;
        });

        var tongtienthuenhap = 0;
        $('.invoice_buy_item_tax_import').each(function(){
          tongtienthuenhap += parseFloat(get_number(this)) || 0;
        });

        var tongtienthuevat = 0;
        $('.invoice_buy_item_tax_vat').each(function(){
          tongtienthuevat += parseFloat(get_number(this)) || 0;
        });

        var tongchiphi = 0;
        var tongchiphi2 = 0;
        $('.invoice_buy_item_other_cost').each(function(){
          var rowIndex=$(this).closest('tr').index();
          var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
          tongchiphi2 += parseFloat(get_number(this))*sl || 0;
        });
        $('.invoice_buy_item_custom_cost_money').each(function(){
          var rowIndex=$(this).closest('tr').index();
          var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
          tongchiphi += roundDecimal((parseFloat(get_number(this)) || 0)*sl,2);
        });

        $('#import').html(tongtienthuenhap);
        $('#vat').html(tongtienthuevat);
        $('#cost_custom').html(tongchiphi);
        $('#cost_other').html(tongchiphi2);
        $('#money').html(tongtienhang);
        
        $('#total').html(tongtienthuenhap+tongtienhang+tongchiphi+tongchiphi2);

        $('#total').html(function(index, value) {
          return value
            .replace(/[^0-9-.]/g, "")
            .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
          ;
        });

        $('#money').html(function(index, value) {
          return value
            .replace(/[^0-9-.]/g, "")
            .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
          ;
        });
        
        $('#import').html(function(index, value) {
          return value
            .replace(/[^0-9-.]/g, "")
            .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
          ;
        });

        $('#vat').html(function(index, value) {
          return value
            .replace(/[^0-9-.]/g, "")
            .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
          ;
        });

        $('#cost_custom').html(function(index, value) {
          return value
            .replace(/[^0-9-.]/g, "")
            .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
          ;
        });
        $('#cost_other').html(function(index, value) {
          return value
            .replace(/[^0-9-.]/g, "")
            .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
          ;
        });

        $('.numbers').val(function(index, value) {
          return value
            .replace(/[^0-9-.]/g, "")
            .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
          ;
        });
      }
    });
  }
  else{
    var money=0;
    var money_foreign=0;
    $('.service_buy_total2').each(function(){
      money += parseFloat(get_number(this)) || 0;
      money_foreign += parseFloat($(this).attr('data').replace(/\,/g,'')) || 0;
    });
    var num=0;
    $('.invoice_buy_item_number').each(function(){
      num += parseFloat($(this).val()) || 0;
    });
    $('.invoice_buy_item_number').each(function(){
      var rowIndex=$(this).closest('tr').index();
      var val = parseFloat($(this).val()) || 0;
      if (val > 0) {
        var cost = roundDecimal(money/num,2);
        var cost_foreign = roundDecimal(money_foreign/num,6);
        $('.invoice_buy_item_custom_cost:eq('+rowIndex+')').val(cost_foreign);
        $('.invoice_buy_item_custom_cost_money:eq('+rowIndex+')').val(cost);

        var price = parseFloat(get_number('.invoice_buy_item_price:eq('+rowIndex+')')) || 0;
        var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
        var vat = parseFloat(get_number('.invoice_buy_item_tax_vat_percent:eq('+rowIndex+')')) || 0;
        var imp = parseFloat(get_number('.invoice_buy_item_tax_import_percent:eq('+rowIndex+')')) || 0;
        var custom = parseFloat(get_number('.invoice_buy_item_custom_cost:eq('+rowIndex+')')) || 0;
        var custom_money = parseFloat(get_number('.invoice_buy_item_custom_cost_money:eq('+rowIndex+')')) || 0;
        var custom_rate = parseFloat(get_number('.invoice_buy_item_custom_rate:eq('+rowIndex+')')) || 0;
        var rate = parseFloat(get_number('#invoice_buy_money_rate')) || 0;
        
        var nk = roundDecimal((price+custom)*custom_rate*sl*imp/100,0);
        var gtgt = roundDecimal((custom_rate*sl*(price+custom)+nk)*vat/100,0);

        var gt = sl*(roundDecimal(rate*price,2)+cost+custom_money)+nk;
        
        $('.invoice_buy_item_tax_import:eq('+rowIndex+')').val(nk);
        $('.invoice_buy_item_tax_vat:eq('+rowIndex+')').val(gtgt);
        $('.invoice_buy_item_tax_total:eq('+rowIndex+')').val(nk+gtgt);

        $('.invoice_buy_item_total:eq('+rowIndex+')').val(roundDecimal(gt/sl,2));

        var tongtienhang = 0;
        $('.invoice_buy_item_money').each(function(){
          tongtienhang += parseFloat(get_number(this)) || 0;
        });

        var tongtienthuenhap = 0;
        $('.invoice_buy_item_tax_import').each(function(){
          tongtienthuenhap += parseFloat(get_number(this)) || 0;
        });

        var tongtienthuevat = 0;
        $('.invoice_buy_item_tax_vat').each(function(){
          tongtienthuevat += parseFloat(get_number(this)) || 0;
        });

        var tongchiphi = 0;
        var tongchiphi2 = 0;
        $('.invoice_buy_item_other_cost').each(function(){
          var rowIndex=$(this).closest('tr').index();
          var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
          tongchiphi2 += parseFloat(get_number(this))*sl || 0;
        });
        $('.invoice_buy_item_custom_cost_money').each(function(){
          var rowIndex=$(this).closest('tr').index();
          var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
          tongchiphi += roundDecimal((parseFloat(get_number(this)) || 0)*sl,2);
        });

        $('#import').html(tongtienthuenhap);
        $('#vat').html(tongtienthuevat);
        $('#cost_custom').html(tongchiphi);
        $('#cost_other').html(tongchiphi2);
        $('#money').html(tongtienhang);
        
        $('#total').html(tongtienthuenhap+tongtienhang+tongchiphi+tongchiphi2);

        $('#total').html(function(index, value) {
          return value
            .replace(/[^0-9-.]/g, "")
            .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
          ;
        });

        $('#money').html(function(index, value) {
          return value
            .replace(/[^0-9-.]/g, "")
            .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
          ;
        });
        
        $('#import').html(function(index, value) {
          return value
            .replace(/[^0-9-.]/g, "")
            .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
          ;
        });

        $('#vat').html(function(index, value) {
          return value
            .replace(/[^0-9-.]/g, "")
            .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
          ;
        });

        $('#cost_custom').html(function(index, value) {
          return value
            .replace(/[^0-9-.]/g, "")
            .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
          ;
        });
        $('#cost_other').html(function(index, value) {
          return value
            .replace(/[^0-9-.]/g, "")
            .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
          ;
        });

        $('.numbers').val(function(index, value) {
          return value
            .replace(/[^0-9-.]/g, "")
            .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
          ;
        });
      }
    });
  }
});

$("#invoice_buy_money_rate").keyup(function(){
  var rate = parseFloat(get_number(this)) || 0;
  var tongtienhang = 0;
  var tongtienthuenhap = 0;
  var tongtienthuevat = 0;
  var tongchiphi = 0;
  var tongchiphi2 = 0;

  $('.invoice_buy_item_money').each(function(){
    var rowIndex=$(this).closest('tr').index();

    var price = parseFloat(get_number('.invoice_buy_item_price:eq('+rowIndex+')')) || 0;
    var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
    var custom = parseFloat(get_number('.invoice_buy_item_custom_cost:eq('+rowIndex+')')) || 0;
    var custom_money = parseFloat(get_number('.invoice_buy_item_custom_cost_money:eq('+rowIndex+')')) || 0;
    var vat = parseFloat(get_number('.invoice_buy_item_tax_vat_percent:eq('+rowIndex+')')) || 0;
    var imp = parseFloat(get_number('.invoice_buy_item_tax_import_percent:eq('+rowIndex+')')) || 0;
    var cost = parseFloat(get_number('.invoice_buy_item_other_cost:eq('+rowIndex+')')) || 0;
    var custom_rate = parseFloat(get_number('.invoice_buy_item_custom_rate:eq('+rowIndex+')')) || 0;

    var tien = roundDecimal(sl*price*rate,2);
    var nk = roundDecimal((price+custom)*custom_rate*sl*imp/100,0);
    var gtgt = roundDecimal((custom_rate*sl*(price+custom)+nk)*vat/100,0);

    var gt = sl*(roundDecimal(rate*price,2)+cost+custom_money)+nk;
    
    $('.invoice_buy_item_money:eq('+rowIndex+')').val(tien);
    $('.invoice_buy_item_tax_import:eq('+rowIndex+')').val(nk);
    $('.invoice_buy_item_tax_vat:eq('+rowIndex+')').val(gtgt);
    $('.invoice_buy_item_tax_total:eq('+rowIndex+')').val(nk+gtgt);

    $('.invoice_buy_item_total:eq('+rowIndex+')').val(roundDecimal(gt/sl,2));

    tongtienhang += tien;
    tongtienthuenhap += nk;
    tongtienthuevat += gtgt;
    tongchiphi += custom_money*sl;
    tongchiphi2 += cost*sl;
  });

  $('#import').html(tongtienthuenhap);
  $('#vat').html(tongtienthuevat);
  $('#cost_custom').html(tongchiphi);
  $('#cost_other').html(tongchiphi2);
  $('#money').html(tongtienhang);
  
  $('#total').html(tongtienthuenhap+tongtienhang+tongchiphi);

  $('#total').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });

  $('#money').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });
  
  $('#import').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });

  $('#vat').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });

  $('#cost_custom').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });
  $('#cost_other').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });

  $('.numbers').val(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });
});

$(".invoice_buy_item_custom_cost").keyup(function(){
  var rowIndex=$(this).closest('tr').index();
  var price = parseFloat(get_number('.invoice_buy_item_price:eq('+rowIndex+')')) || 0;
  var custom = parseFloat(get_number(this)) || 0;
  var custom_money = parseFloat(get_number('.invoice_buy_item_custom_cost_money:eq('+rowIndex+')')) || 0;
  var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
  var vat = parseFloat(get_number('.invoice_buy_item_tax_vat_percent:eq('+rowIndex+')')) || 0;
  var imp = parseFloat(get_number('.invoice_buy_item_tax_import_percent:eq('+rowIndex+')')) || 0;
  var cost = parseFloat(get_number('.invoice_buy_item_other_cost:eq('+rowIndex+')')) || 0;
  var custom_rate = parseFloat(get_number('.invoice_buy_item_custom_rate:eq('+rowIndex+')')) || 0;
  var rate = parseFloat(get_number('#invoice_buy_money_rate')) || 0;
  
  var nk = roundDecimal((price+custom)*custom_rate*sl*imp/100,0);
  var gtgt = roundDecimal((custom_rate*sl*(price+custom)+nk)*vat/100,0);

  var gt = sl*(roundDecimal(rate*price,2)+cost+custom_money)+nk;
  
  $('.invoice_buy_item_tax_import:eq('+rowIndex+')').val(nk);
  $('.invoice_buy_item_tax_vat:eq('+rowIndex+')').val(gtgt);
  $('.invoice_buy_item_tax_total:eq('+rowIndex+')').val(nk+gtgt);

  $('.invoice_buy_item_total:eq('+rowIndex+')').val(roundDecimal(gt/sl,2));

  var tongtienhang = 0;
  $('.invoice_buy_item_money').each(function(){
    tongtienhang += parseFloat(get_number(this)) || 0;
  });

  var tongtienthuenhap = 0;
  $('.invoice_buy_item_tax_import').each(function(){
    tongtienthuenhap += parseFloat(get_number(this)) || 0;
  });

  var tongtienthuevat = 0;
  $('.invoice_buy_item_tax_vat').each(function(){
    tongtienthuevat += parseFloat(get_number(this)) || 0;
  });

  var tongchiphi = 0;
  var tongchiphi2 = 0;
  $('.invoice_buy_item_other_cost').each(function(){
    var rowIndex=$(this).closest('tr').index();
    var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
    tongchiphi2 += parseFloat(get_number(this))*sl || 0;
  });
  $('.invoice_buy_item_custom_cost_money').each(function(){
    var rowIndex=$(this).closest('tr').index();
    var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
    tongchiphi += roundDecimal((parseFloat(get_number(this)) || 0)*sl,2);
  });

  $('#import').html(tongtienthuenhap);
  $('#vat').html(tongtienthuevat);
  $('#cost_custom').html(tongchiphi);
  $('#cost_other').html(tongchiphi2);
  $('#money').html(tongtienhang);
  
  $('#total').html(tongtienthuenhap+tongtienhang+tongchiphi+tongchiphi2);

  $('#total').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });

  $('#money').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });
  
  $('#import').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });

  $('#vat').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });

  $('#cost_custom').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });

  $('#cost_other').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });

  $('.numbers').val(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });
});
$(".invoice_buy_item_custom_cost_money").keyup(function(){
  var rowIndex=$(this).closest('tr').index();
  var price = parseFloat(get_number('.invoice_buy_item_price:eq('+rowIndex+')')) || 0;
  var custom_money = parseFloat(get_number(this)) || 0;
  var custom = parseFloat(get_number('.invoice_buy_item_custom_cost:eq('+rowIndex+')')) || 0;
  var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
  var vat = parseFloat(get_number('.invoice_buy_item_tax_vat_percent:eq('+rowIndex+')')) || 0;
  var imp = parseFloat(get_number('.invoice_buy_item_tax_import_percent:eq('+rowIndex+')')) || 0;
  var cost = parseFloat(get_number('.invoice_buy_item_other_cost:eq('+rowIndex+')')) || 0;
  var custom_rate = parseFloat(get_number('.invoice_buy_item_custom_rate:eq('+rowIndex+')')) || 0;
  var rate = parseFloat(get_number('#invoice_buy_money_rate')) || 0;
  
  var nk = roundDecimal((price+custom)*custom_rate*sl*imp/100,0);
  var gtgt = roundDecimal((custom_rate*sl*(price+custom)+nk)*vat/100,0);

  var gt = sl*(roundDecimal(rate*price,2)+cost+custom_money)+nk;
  
  $('.invoice_buy_item_tax_import:eq('+rowIndex+')').val(nk);
  $('.invoice_buy_item_tax_vat:eq('+rowIndex+')').val(gtgt);
  $('.invoice_buy_item_tax_total:eq('+rowIndex+')').val(nk+gtgt);

  $('.invoice_buy_item_total:eq('+rowIndex+')').val(roundDecimal(gt/sl,2));

  var tongtienhang = 0;
  $('.invoice_buy_item_money').each(function(){
    tongtienhang += parseFloat(get_number(this)) || 0;
  });

  var tongtienthuenhap = 0;
  $('.invoice_buy_item_tax_import').each(function(){
    tongtienthuenhap += parseFloat(get_number(this)) || 0;
  });

  var tongtienthuevat = 0;
  $('.invoice_buy_item_tax_vat').each(function(){
    tongtienthuevat += parseFloat(get_number(this)) || 0;
  });

  var tongchiphi = 0;
  var tongchiphi2 = 0;
  $('.invoice_buy_item_other_cost').each(function(){
    var rowIndex=$(this).closest('tr').index();
    var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
    tongchiphi2 += parseFloat(get_number(this))*sl || 0;
  });
  $('.invoice_buy_item_custom_cost_money').each(function(){
    var rowIndex=$(this).closest('tr').index();
    var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
    tongchiphi += roundDecimal((parseFloat(get_number(this)) || 0)*sl,2);
  });

  $('#import').html(tongtienthuenhap);
  $('#vat').html(tongtienthuevat);
  $('#cost_custom').html(tongchiphi);
  $('#cost_other').html(tongchiphi2);
  $('#money').html(tongtienhang);
  
  $('#total').html(tongtienthuenhap+tongtienhang+tongchiphi+tongchiphi2);

  $('#total').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });

  $('#money').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });
  
  $('#import').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });

  $('#vat').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });

  $('#cost_custom').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });
  $('#cost_other').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });

  $('.numbers').val(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });
});

$(".invoice_buy_item_other_cost").keyup(function(){
  var rowIndex=$(this).closest('tr').index();
  var price = parseFloat(get_number('.invoice_buy_item_price:eq('+rowIndex+')')) || 0;
  var cost = parseFloat(get_number(this)) || 0;
  var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
  var vat = parseFloat(get_number('.invoice_buy_item_tax_vat_percent:eq('+rowIndex+')')) || 0;
  var imp = parseFloat(get_number('.invoice_buy_item_tax_import_percent:eq('+rowIndex+')')) || 0;
  var custom = parseFloat(get_number('.invoice_buy_item_custom_cost:eq('+rowIndex+')')) || 0;
  var custom_money = parseFloat(get_number('.invoice_buy_item_custom_cost_money:eq('+rowIndex+')')) || 0;
  var custom_rate = parseFloat(get_number('.invoice_buy_item_custom_rate:eq('+rowIndex+')')) || 0;
  var rate = parseFloat(get_number('#invoice_buy_money_rate')) || 0;
  
  var nk = roundDecimal((price+custom)*custom_rate*sl*imp/100,0);
  var gtgt = roundDecimal((custom_rate*sl*(price+custom)+nk)*vat/100,0);

  var gt = sl*(roundDecimal(rate*price,2)+cost+custom_money)+nk;
  
  $('.invoice_buy_item_tax_import:eq('+rowIndex+')').val(nk);
  $('.invoice_buy_item_tax_vat:eq('+rowIndex+')').val(gtgt);
  $('.invoice_buy_item_tax_total:eq('+rowIndex+')').val(nk+gtgt);

  $('.invoice_buy_item_total:eq('+rowIndex+')').val(roundDecimal(gt/sl,2));

  var tongtienhang = 0;
  $('.invoice_buy_item_money').each(function(){
    tongtienhang += parseFloat(get_number(this)) || 0;
  });

  var tongtienthuenhap = 0;
  $('.invoice_buy_item_tax_import').each(function(){
    tongtienthuenhap += parseFloat(get_number(this)) || 0;
  });

  var tongtienthuevat = 0;
  $('.invoice_buy_item_tax_vat').each(function(){
    tongtienthuevat += parseFloat(get_number(this)) || 0;
  });

  var tongchiphi = 0;
  var tongchiphi2 = 0;
  $('.invoice_buy_item_other_cost').each(function(){
    var rowIndex=$(this).closest('tr').index();
    var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
    tongchiphi2 += parseFloat(get_number(this))*sl || 0;
  });
  $('.invoice_buy_item_custom_cost_money').each(function(){
    var rowIndex=$(this).closest('tr').index();
    var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
    tongchiphi += roundDecimal((parseFloat(get_number(this)) || 0)*sl,2);
  });

  $('#import').html(tongtienthuenhap);
  $('#vat').html(tongtienthuevat);
  $('#cost_custom').html(tongchiphi);
  $('#cost_other').html(tongchiphi2);
  $('#money').html(tongtienhang);
  
  $('#total').html(tongtienthuenhap+tongtienhang+tongchiphi+tongchiphi2);

  $('#total').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });

  $('#money').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });
  
  $('#import').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });

  $('#vat').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });

  $('#cost_custom').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });
  $('#cost_other').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });

  $('.numbers').val(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });
});

$(".invoice_buy_item_number").keyup(function(){
  var rowIndex=$(this).closest('tr').index();
  var price = parseFloat(get_number('.invoice_buy_item_price:eq('+rowIndex+')')) || 0;
  var sl = parseFloat(get_number(this)) || 0;
  var custom = parseFloat(get_number('.invoice_buy_item_custom_cost:eq('+rowIndex+')')) || 0;
  var custom_money = parseFloat(get_number('.invoice_buy_item_custom_cost_money:eq('+rowIndex+')')) || 0;
  var vat = parseFloat(get_number('.invoice_buy_item_tax_vat_percent:eq('+rowIndex+')')) || 0;
  var imp = parseFloat(get_number('.invoice_buy_item_tax_import_percent:eq('+rowIndex+')')) || 0;
  var cost = parseFloat(get_number('.invoice_buy_item_other_cost:eq('+rowIndex+')')) || 0;
  var custom_rate = parseFloat(get_number('.invoice_buy_item_custom_rate:eq('+rowIndex+')')) || 0;
  var rate = parseFloat(get_number('#invoice_buy_money_rate')) || 0;
  
  var tien = roundDecimal(sl*price*rate,2);
  var nk = roundDecimal((price+custom)*custom_rate*sl*imp/100,0);
  var gtgt = roundDecimal((custom_rate*sl*(price+custom)+nk)*vat/100,0);

  var gt = sl*(roundDecimal(rate*price,2)+cost+custom_money)+nk;
  
  $('.invoice_buy_item_money:eq('+rowIndex+')').val(tien);
  $('.invoice_buy_item_tax_import:eq('+rowIndex+')').val(nk);
  $('.invoice_buy_item_tax_vat:eq('+rowIndex+')').val(gtgt);
  $('.invoice_buy_item_tax_total:eq('+rowIndex+')').val(nk+gtgt);

  $('.invoice_buy_item_total:eq('+rowIndex+')').val(roundDecimal(gt/sl,2));

  var tongtienhangnt = 0;
  $('.invoice_buy_item_price').each(function(){
    var rowIndex=$(this).closest('tr').index();
    var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
    tongtienhangnt += roundDecimal(parseFloat(get_number(this))*sl,2) || 0;
  });

  var tongtienhang = 0;
  $('.invoice_buy_item_money').each(function(){
    tongtienhang += parseFloat(get_number(this)) || 0;
  });

  var tongtienthuenhap = 0;
  $('.invoice_buy_item_tax_import').each(function(){
    tongtienthuenhap += parseFloat(get_number(this)) || 0;
  });

  var tongtienthuevat = 0;
  $('.invoice_buy_item_tax_vat').each(function(){
    tongtienthuevat += parseFloat(get_number(this)) || 0;
  });

  var tongchiphi = 0;
  var tongchiphi2 = 0;
  $('.invoice_buy_item_other_cost').each(function(){
    var rowIndex=$(this).closest('tr').index();
    var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
    tongchiphi2 += parseFloat(get_number(this))*sl || 0;
  });
  $('.invoice_buy_item_custom_cost_money').each(function(){
    var rowIndex=$(this).closest('tr').index();
    var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
    tongchiphi += roundDecimal((parseFloat(get_number(this)) || 0)*sl,2);
  });

  $('#import').html(tongtienthuenhap);
  $('#vat').html(tongtienthuevat);
  $('#cost_custom').html(tongchiphi);
  $('#cost_other').html(tongchiphi2);
  $('#money').html(tongtienhang);
  
  $('#total').html(tongtienthuenhap+tongtienhang+tongchiphi+tongchiphi2);

  $('#price').html(tongtienhangnt);

  $('#price').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });
  $('#total').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });

  $('#money').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });
  
  $('#import').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });

  $('#vat').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });

  $('#cost_custom').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });
  $('#cost_other').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });

  $('.numbers').val(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });
});
$(".invoice_buy_item_price").keyup(function(){
  var rowIndex=$(this).closest('tr').index();
  var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
  var price = parseFloat(get_number(this)) || 0;
  var custom = parseFloat(get_number('.invoice_buy_item_custom_cost:eq('+rowIndex+')')) || 0;
  var custom_money = parseFloat(get_number('.invoice_buy_item_custom_cost_money:eq('+rowIndex+')')) || 0;
  var vat = parseFloat(get_number('.invoice_buy_item_tax_vat_percent:eq('+rowIndex+')')) || 0;
  var imp = parseFloat(get_number('.invoice_buy_item_tax_import_percent:eq('+rowIndex+')')) || 0;
  var cost = parseFloat(get_number('.invoice_buy_item_other_cost:eq('+rowIndex+')')) || 0;
  var custom_rate = parseFloat(get_number('.invoice_buy_item_custom_rate:eq('+rowIndex+')')) || 0;
  var rate = parseFloat(get_number('#invoice_buy_money_rate')) || 0;
  
  var tien = roundDecimal(sl*price*rate,2);
  var nk = roundDecimal((price+custom)*custom_rate*sl*imp/100,0);
  var gtgt = roundDecimal((custom_rate*sl*(price+custom)+nk)*vat/100,0);

  var gt = sl*(roundDecimal(rate*price,2)+cost+custom_money)+nk;
  
  $('.invoice_buy_item_money:eq('+rowIndex+')').val(tien);
  $('.invoice_buy_item_tax_import:eq('+rowIndex+')').val(nk);
  $('.invoice_buy_item_tax_vat:eq('+rowIndex+')').val(gtgt);
  $('.invoice_buy_item_tax_total:eq('+rowIndex+')').val(nk+gtgt);

  $('.invoice_buy_item_total:eq('+rowIndex+')').val(roundDecimal(gt/sl,2));

  var tongtienhangnt = 0;
  $('.invoice_buy_item_price').each(function(){
    var rowIndex=$(this).closest('tr').index();
    var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
    tongtienhangnt += roundDecimal(parseFloat(get_number(this))*sl,2) || 0;
  });

  var tongtienhang = 0;
  $('.invoice_buy_item_money').each(function(){
    tongtienhang += parseFloat(get_number(this)) || 0;
  });

  var tongtienthuenhap = 0;
  $('.invoice_buy_item_tax_import').each(function(){
    tongtienthuenhap += parseFloat(get_number(this)) || 0;
  });

  var tongtienthuevat = 0;
  $('.invoice_buy_item_tax_vat').each(function(){
    tongtienthuevat += parseFloat(get_number(this)) || 0;
  });

  var tongchiphi = 0;
  var tongchiphi2 = 0;
  $('.invoice_buy_item_other_cost').each(function(){
    var rowIndex=$(this).closest('tr').index();
    var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
    tongchiphi2 += parseFloat(get_number(this))*sl || 0;
  });
  $('.invoice_buy_item_custom_cost_money').each(function(){
    var rowIndex=$(this).closest('tr').index();
    var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
    tongchiphi += roundDecimal((parseFloat(get_number(this)) || 0)*sl,2);
  });

  $('#import').html(tongtienthuenhap);
  $('#vat').html(tongtienthuevat);
  $('#cost_custom').html(tongchiphi);
  $('#cost_other').html(tongchiphi2);
  $('#money').html(tongtienhang);
  
  $('#total').html(tongtienthuenhap+tongtienhang+tongchiphi+tongchiphi2);

  $('#price').html(tongtienhangnt);

  $('#price').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });
  $('#total').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });

  $('#money').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });
  
  $('#import').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });

  $('#vat').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });

  $('#cost_custom').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });
  $('#cost_other').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });

  $('.numbers').val(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });
});
$(".invoice_buy_item_tax_vat_percent").keyup(function(){
  var rowIndex=$(this).closest('tr').index();
  var price = parseFloat(get_number('.invoice_buy_item_price:eq('+rowIndex+')')) || 0;
  var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
  var vat = parseFloat($(this).val()) || 0;
  var custom = parseFloat(get_number('.invoice_buy_item_custom_cost:eq('+rowIndex+')')) || 0;
  var custom_money = parseFloat(get_number('.invoice_buy_item_custom_cost_money:eq('+rowIndex+')')) || 0;
  var imp = parseFloat(get_number('.invoice_buy_item_tax_import_percent:eq('+rowIndex+')')) || 0;
  var cost = parseFloat(get_number('.invoice_buy_item_other_cost:eq('+rowIndex+')')) || 0;
  var custom_rate = parseFloat(get_number('.invoice_buy_item_custom_rate:eq('+rowIndex+')')) || 0;
  var rate = parseFloat(get_number('#invoice_buy_money_rate')) || 0;

  var nk = roundDecimal((price+custom)*custom_rate*sl*imp/100,0);
  var gtgt = roundDecimal((custom_rate*sl*(price+custom)+nk)*vat/100,0);

  var gt = sl*(roundDecimal(rate*price,2)+cost+custom_money)+nk;
  
  $('.invoice_buy_item_tax_import:eq('+rowIndex+')').val(nk);
  $('.invoice_buy_item_tax_vat:eq('+rowIndex+')').val(gtgt);
  $('.invoice_buy_item_tax_total:eq('+rowIndex+')').val(nk+gtgt);

  $('.invoice_buy_item_total:eq('+rowIndex+')').val(roundDecimal(gt/sl,2));

  var tongtienthuenhap = 0;
  $('.invoice_buy_item_tax_import').each(function(){
    tongtienthuenhap += parseFloat(get_number(this)) || 0;
  });

  var tongtienthuevat = 0;
  $('.invoice_buy_item_tax_vat').each(function(){
    tongtienthuevat += parseFloat(get_number(this)) || 0;
  });

  var tongchiphi = 0;
  var tongchiphi2 = 0;
  $('.invoice_buy_item_other_cost').each(function(){
    var rowIndex=$(this).closest('tr').index();
    var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
    tongchiphi2 += parseFloat(get_number(this))*sl || 0;
  });
  $('.invoice_buy_item_custom_cost_money').each(function(){
    var rowIndex=$(this).closest('tr').index();
    var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
    tongchiphi += roundDecimal((parseFloat(get_number(this)) || 0)*sl,2);
  });

  $('#import').html(tongtienthuenhap);
  $('#vat').html(tongtienthuevat);
  $('#cost_custom').html(tongchiphi);
  $('#cost_other').html(tongchiphi2);

  var tongtienhang = parseFloat($('#money').html().replace(/\,/g,''));

  $('#total').html(tongtienthuenhap+tongtienhang+tongchiphi+tongchiphi2);

  $('#total').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });
  
  $('#import').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });

  $('#vat').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });

  $('#cost_custom').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });
  $('#cost_other').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });

  $('.numbers').val(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });
});
$(".invoice_buy_item_tax_import_percent").keyup(function(){
  var rowIndex=$(this).closest('tr').index();
  var price = parseFloat(get_number('.invoice_buy_item_price:eq('+rowIndex+')')) || 0;
  var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
  var imp = parseFloat($(this).val()) || 0;
  var custom = parseFloat(get_number('.invoice_buy_item_custom_cost:eq('+rowIndex+')')) || 0;
  var custom_money = parseFloat(get_number('.invoice_buy_item_custom_cost_money:eq('+rowIndex+')')) || 0;
  var vat = parseFloat(get_number('.invoice_buy_item_tax_vat_percent:eq('+rowIndex+')')) || 0;
  var cost = parseFloat(get_number('.invoice_buy_item_other_cost:eq('+rowIndex+')')) || 0;
  var custom_rate = parseFloat(get_number('.invoice_buy_item_custom_rate:eq('+rowIndex+')')) || 0;
  var rate = parseFloat(get_number('#invoice_buy_money_rate')) || 0;

  var nk = roundDecimal((price+custom)*custom_rate*sl*imp/100,0);
  var gtgt = roundDecimal((custom_rate*sl*(price+custom)+nk)*vat/100,0);

  var gt = sl*(roundDecimal(rate*price,2)+cost+custom_money)+nk;
  
  $('.invoice_buy_item_tax_import:eq('+rowIndex+')').val(nk);
  $('.invoice_buy_item_tax_vat:eq('+rowIndex+')').val(gtgt);
  $('.invoice_buy_item_tax_total:eq('+rowIndex+')').val(nk+gtgt);

  $('.invoice_buy_item_total:eq('+rowIndex+')').val(roundDecimal(gt/sl,2));

  var tongtienthuenhap = 0;
  $('.invoice_buy_item_tax_import').each(function(){
    tongtienthuenhap += parseFloat(get_number(this)) || 0;
  });

  var tongtienthuevat = 0;
  $('.invoice_buy_item_tax_vat').each(function(){
    tongtienthuevat += parseFloat(get_number(this)) || 0;
  });

  var tongchiphi = 0;
  var tongchiphi2 = 0;
  $('.invoice_buy_item_other_cost').each(function(){
    var rowIndex=$(this).closest('tr').index();
    var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
    tongchiphi2 += parseFloat(get_number(this))*sl || 0;
  });
  $('.invoice_buy_item_custom_cost_money').each(function(){
    var rowIndex=$(this).closest('tr').index();
    var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
    tongchiphi += roundDecimal((parseFloat(get_number(this)) || 0)*sl,2);
  });

  $('#import').html(tongtienthuenhap);
  $('#vat').html(tongtienthuevat);
  $('#cost_custom').html(tongchiphi);
  $('#cost_other').html(tongchiphi2);

  var tongtienhang = parseFloat($('#money').html().replace(/\,/g,''));

  $('#total').html(tongtienthuenhap+tongtienhang+tongchiphi+tongchiphi2);

  $('#total').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });
  
  $('#import').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });

  $('#vat').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });

  $('#cost_custom').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });
  $('#cost_other').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });

  $('.numbers').val(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });
});
$(".invoice_buy_item_custom_rate").keyup(function(){
  var rowIndex=$(this).closest('tr').index();
  var price = parseFloat(get_number('.invoice_buy_item_price:eq('+rowIndex+')')) || 0;
  var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
  var custom_rate = parseFloat(get_number(this)) || 0;
  var custom = parseFloat(get_number('.invoice_buy_item_custom_cost:eq('+rowIndex+')')) || 0;
  var custom_money = parseFloat(get_number('.invoice_buy_item_custom_cost_money:eq('+rowIndex+')')) || 0;
  var vat = parseFloat(get_number('.invoice_buy_item_tax_vat_percent:eq('+rowIndex+')')) || 0;
  var cost = parseFloat(get_number('.invoice_buy_item_other_cost:eq('+rowIndex+')')) || 0;
  var imp = parseFloat(get_number('.invoice_buy_item_tax_import_percent:eq('+rowIndex+')')) || 0;
  var rate = parseFloat(get_number('#invoice_buy_money_rate')) || 0;

  var nk = roundDecimal((price+custom)*custom_rate*sl*imp/100,0);
  var gtgt = roundDecimal((custom_rate*sl*(price+custom)+nk)*vat/100,0);

  var gt = sl*(roundDecimal(rate*price,2)+cost+custom_money)+nk;
  
  $('.invoice_buy_item_tax_import:eq('+rowIndex+')').val(nk);
  $('.invoice_buy_item_tax_vat:eq('+rowIndex+')').val(gtgt);
  $('.invoice_buy_item_tax_total:eq('+rowIndex+')').val(nk+gtgt);

  $('.invoice_buy_item_total:eq('+rowIndex+')').val(roundDecimal(gt/sl,2));

  var tongtienthuenhap = 0;
  $('.invoice_buy_item_tax_import').each(function(){
    tongtienthuenhap += parseFloat(get_number(this)) || 0;
  });

  var tongtienthuevat = 0;
  $('.invoice_buy_item_tax_vat').each(function(){
    tongtienthuevat += parseFloat(get_number(this)) || 0;
  });

  var tongchiphi = 0;
  var tongchiphi2 = 0;
  $('.invoice_buy_item_other_cost').each(function(){
    var rowIndex=$(this).closest('tr').index();
    var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
    tongchiphi2 += parseFloat(get_number(this))*sl || 0;
  });
  $('.invoice_buy_item_custom_cost_money').each(function(){
    var rowIndex=$(this).closest('tr').index();
    var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
    tongchiphi += roundDecimal((parseFloat(get_number(this)) || 0)*sl,2);
  });

  $('#import').html(tongtienthuenhap);
  $('#vat').html(tongtienthuevat);
  $('#cost_custom').html(tongchiphi);
  $('#cost_other').html(tongchiphi2);

  var tongtienhang = parseFloat($('#money').html().replace(/\,/g,''));

  $('#total').html(tongtienthuenhap+tongtienhang+tongchiphi+tongchiphi2);

  $('#total').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });
  
  $('#import').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });

  $('#vat').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });

  $('#cost_custom').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });
  $('#cost_other').html(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });

  $('.numbers').val(function(index, value) {
    return value
      .replace(/[^0-9-.]/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    ;
  });
});

$('#invoice_buy_customer').keyup(function(){
    var rowIndex = 0;
    var keyword = $(this).val();
    if(keyword != ""){
      $.ajax({
          url: '<?php echo BASE_URL ?>/invoicebuy/getCustomer',
          type: 'POST',
          data: {keyword:keyword, offset:rowIndex},
          success:function(data){
              $('#customer_list_id:eq('+rowIndex+')').slideDown(200);
              $('#customer_list_id:eq('+rowIndex+')').html(data);
          }
      });
    }

    if ($('#invoice_buy_customer:eq('+rowIndex+')').val() == "" || $('#invoice_buy_customer:eq('+rowIndex+')').attr('data') == "") {
      $('#invoice_buy_customer:eq('+rowIndex+')').attr('data',"");
    }
});
$('.invoice_buy_item_house').keyup(function(){
  var row = $(this).parent().parent();
  var rowIndex = (row[0].rowIndex)-1;
  var keyword = $(this).val();
  if(keyword != ""){
    $.ajax({
        url: '<?php echo BASE_URL ?>/invoicebuy/getHouse',
        type: 'POST',
        data: {keyword:keyword, offset:rowIndex},
        success:function(data){
            $('.name_list_id_4:eq('+rowIndex+')').slideDown(200);
            $('.name_list_id_4:eq('+rowIndex+')').html(data);
        }
    });
  }

  if ($('.invoice_buy_item_house:eq('+rowIndex+')').val() == "" || $('.invoice_buy_item_house:eq('+rowIndex+')').attr('data') == "") {
    $('.invoice_buy_item_house:eq('+rowIndex+')').attr('data',"");
  }
});
$('.invoice_buy_item').keyup(function(){
    var row = $(this).parent().parent();
    var rowIndex = (row[0].rowIndex)-1;
    var keyword = $(this).val();
    if(keyword != ""){
      $.ajax({
          url: '<?php echo BASE_URL ?>/invoicebuy/getItemName',
          type: 'POST',
          data: {keyword:keyword, offset:rowIndex},
          success:function(data){
              $('.name_list_id:eq('+rowIndex+')').slideDown(200);
              $('.name_list_id:eq('+rowIndex+')').html(data);
          }
      });
    }

    if ($('.invoice_buy_item:eq('+rowIndex+')').val() == "" || $('.invoice_buy_item:eq('+rowIndex+')').attr('data') == "") {
      $('.invoice_buy_item:eq('+rowIndex+')').attr('data',"");
    }
});
$('.invoice_buy_item_debit').keyup(function(){
    var row = $(this).parent().parent();
    var rowIndex = (row[0].rowIndex)-1;
    var keyword = $(this).val();
    var name = ".invoice_buy_item_debit";
    if(keyword != ""){
      $.ajax({
          url: '<?php echo BASE_URL ?>/invoicebuy/getAccount',
          type: 'POST',
          data: {keyword:keyword, offset:rowIndex, name:name},
          success:function(data){
              $('.name_list_id_2:eq('+rowIndex+')').slideDown(200);
              $('.name_list_id_2:eq('+rowIndex+')').html(data);
          }
      });
    }

    if ($('.invoice_buy_item_debit:eq('+rowIndex+')').val() == "" || $('.invoice_buy_item_debit:eq('+rowIndex+')').attr('data') == "") {
      $('.invoice_buy_item_debit:eq('+rowIndex+')').attr('data',"");
    }
});
$('.invoice_buy_item_credit').keyup(function(){
    var row = $(this).parent().parent();
    var rowIndex = (row[0].rowIndex)-1;
    var keyword = $(this).val();
    var name = ".invoice_buy_item_credit";
    if(keyword != ""){
      $.ajax({
        url: '<?php echo BASE_URL ?>/invoicebuy/getAccount',
        type: 'POST',
        data: {keyword:keyword, offset:rowIndex, name:name},
        success:function(data){
            $('.name_list_id_3:eq('+rowIndex+')').slideDown(200);
            $('.name_list_id_3:eq('+rowIndex+')').html(data);
        }
      });
    }
    

    if ($('.invoice_buy_item_credit:eq('+rowIndex+')').val() == "" || $('.invoice_buy_item_credit:eq('+rowIndex+')').attr('data') == "") {
      $('.invoice_buy_item_credit:eq('+rowIndex+')').attr('data',"");
    }
});
$('.invoice_buy_item_tax_import_debit').keyup(function(){
    var row = $(this).parent().parent();
    var rowIndex = (row[0].rowIndex)-1;
    var keyword = $(this).val();
    var name = ".invoice_buy_item_tax_import_debit";
    if(keyword != ""){
      $.ajax({
          url: '<?php echo BASE_URL ?>/invoicebuy/getAccount',
          type: 'POST',
          data: {keyword:keyword, offset:rowIndex, name:name},
          success:function(data){
              $('.name_list_id_5:eq('+rowIndex+')').slideDown(200);
              $('.name_list_id_5:eq('+rowIndex+')').html(data);
          }
      });
    }

    if ($('.invoice_buy_item_tax_import_debit:eq('+rowIndex+')').val() == "" || $('.invoice_buy_item_tax_import_debit:eq('+rowIndex+')').attr('data') == "") {
      $('.invoice_buy_item_tax_import_debit:eq('+rowIndex+')').attr('data',"");
    }
});
$('.invoice_buy_item_tax_vat_debit').keyup(function(){
    var row = $(this).parent().parent();
    var rowIndex = (row[0].rowIndex)-1;
    var keyword = $(this).val();
    var name = ".invoice_buy_item_tax_vat_debit";
    if(keyword != ""){
      $.ajax({
          url: '<?php echo BASE_URL ?>/invoicebuy/getAccount',
          type: 'POST',
          data: {keyword:keyword, offset:rowIndex, name:name},
          success:function(data){
              $('.name_list_id_6:eq('+rowIndex+')').slideDown(200);
              $('.name_list_id_6:eq('+rowIndex+')').html(data);
          }
      });
    }

    if ($('.invoice_buy_item_tax_vat_debit:eq('+rowIndex+')').val() == "" || $('.invoice_buy_item_tax_vat_debit:eq('+rowIndex+')').attr('data') == "") {
      $('.invoice_buy_item_tax_vat_debit:eq('+rowIndex+')').attr('data',"");
    }
});
$('.invoice_buy_item_tax_vat_credit').keyup(function(){
    var row = $(this).parent().parent();
    var rowIndex = (row[0].rowIndex)-1;
    var keyword = $(this).val();
    var name = ".invoice_buy_item_tax_vat_credit";
    if(keyword != ""){
      $.ajax({
          url: '<?php echo BASE_URL ?>/invoicebuy/getAccount',
          type: 'POST',
          data: {keyword:keyword, offset:rowIndex, name:name},
          success:function(data){
              $('.name_list_id_7:eq('+rowIndex+')').slideDown(200);
              $('.name_list_id_7:eq('+rowIndex+')').html(data);
          }
      });
    }

    if ($('.invoice_buy_item_tax_vat_credit:eq('+rowIndex+')').val() == "" || $('.invoice_buy_item_tax_vat_credit:eq('+rowIndex+')').attr('data') == "") {
      $('.invoice_buy_item_tax_vat_credit:eq('+rowIndex+')').attr('data',"");
    }
});
$('.invoice_buy_item_custom_cost_debit').keyup(function(){
    var row = $(this).parent().parent();
    var rowIndex = (row[0].rowIndex)-1;
    var keyword = $(this).val();
    var name = ".invoice_buy_item_custom_cost_debit";
    if(keyword != ""){
      $.ajax({
          url: '<?php echo BASE_URL ?>/invoicebuy/getAccount',
          type: 'POST',
          data: {keyword:keyword, offset:rowIndex, name:name},
          success:function(data){
              $('.name_list_id_8:eq('+rowIndex+')').slideDown(200);
              $('.name_list_id_8:eq('+rowIndex+')').html(data);
          }
      });
    }

    if ($('.invoice_buy_item_custom_cost_debit:eq('+rowIndex+')').val() == "" || $('.invoice_buy_item_custom_cost_debit:eq('+rowIndex+')').attr('data') == "") {
      $('.invoice_buy_item_custom_cost_debit:eq('+rowIndex+')').attr('data',"");
    }
});
function set_item_account(value,code,name,vitri) {
    $(name+':eq('+vitri+')').val(code);
    $(name+':eq('+vitri+')').attr("data",value);
    
    $('.name_list_id_2').hide();
    $('.name_list_id_3').hide();
    $('.name_list_id_5').hide();
    $('.name_list_id_6').hide();
    $('.name_list_id_7').hide();
    $('.name_list_id_8').hide();
    $(name+':eq('+vitri+')').focus();
}
function set_item_house(value,code,name,vitri) {
    $('.invoice_buy_item_house:eq('+vitri+')').val(code);
    $('.invoice_buy_item_house:eq('+vitri+')').attr("data",value);
    
    $('.name_list_id_4').hide();
    $('.invoice_buy_item_house:eq('+vitri+')').focus();
}
function set_item(value,code,name,unit,tax,stuff,vitri) {
    $('.invoice_buy_item:eq('+vitri+')').val(code);
    $('.invoice_buy_item:eq('+vitri+')').attr("data",value);
    $('.invoice_buy_item_number:eq('+vitri+')').attr("alt",stuff);
    $('.invoice_buy_item_name:eq('+vitri+')').val(name);
    $('.invoice_buy_item_unit:eq('+vitri+')').val(unit);
    $('.invoice_buy_item_tax_vat_percent:eq('+vitri+')').val(tax);
    $('.invoice_buy_item2:eq('+vitri+')').val(code);
    $('.invoice_buy_item_name2:eq('+vitri+')').val(name);
    $('.name_list_id').hide();
    $('.invoice_buy_item:eq('+vitri+')').focus();

    var check = 0;
    var val = value;
    $('.invoice_buy_item').each(function(){
      if (val == $(this).attr('data')) {
        check++
      }
    });

    if (check>=2) {
      alert('Mã đã tồn tại. Vui lòng chọn mã khác!');
      $('.invoice_buy_item:eq('+vitri+')').val("");
      $('.invoice_buy_item:eq('+vitri+')').attr("data","");
      $('.invoice_buy_item:eq('+vitri+')').attr("alt","");
      $('.invoice_buy_item_name:eq('+vitri+')').val("");
      $('.invoice_buy_item_unit:eq('+vitri+')').val("");
      $('.invoice_buy_item_tax_vat_percent:eq('+vitri+')').val("");
      $('.invoice_buy_item2:eq('+vitri+')').val("");
      $('.invoice_buy_item_name2:eq('+vitri+')').val("");
    }
}
function set_item_customer(value,code,name,company,mst,address,vitri) {
    $('#invoice_buy_customer:eq('+vitri+')').val(code);
    $('#invoice_buy_customer:eq('+vitri+')').attr("data",value);
    $('#customer_company:eq('+vitri+')').val(company);
    $('#customer_mst:eq('+vitri+')').val(mst);
    $('#customer_address:eq('+vitri+')').val(address);
    $('#customer_list_id').hide();
    $('#invoice_buy_customer:eq('+vitri+')').focus();
}


$(".find_item").click(function(){
  var rowIndex=$(this).closest('tr').index();
  $('#rowIndex_item').val(rowIndex);
    $.ajax({
        url: '<?php echo BASE_URL ?>/invoicebuy/getItem',
        type: 'POST',
        data: {rowIndex:rowIndex},
        success:function(data){
          $('#show_item').html(data);
          $("#show_item" ).dialog( "open" );

          $('#tblExport2').DataTable({
              "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Tất cả"]],
              "order": [[ 1, "asc" ], [ 2, "asc" ]],
              "columnDefs": [ {
                "targets": 0,
                "orderable": false
              } ],
              "fnRowCallback": function( nRow, aData, iDisplayIndex, iDisplayIndexFull ) {
                var index = iDisplayIndex +1;
                  $('.tr td:eq(0)',nRow).html(index);
                  return nRow
              }
          });

          $('.tr').click(function(){
            $(this).find('input').each(function () {
              if ($(this).is(':checked')) {
                $(this).prop('checked',false);
              }
              else{
                $(this).prop('checked',true);
              }
            });
          });
        }

    });
});

$( "#show_item" ).dialog({
    autoOpen: false,
    modal: true,
    width: "50%",
    maxHeight: $(window).height()-50,
    title: "Danh mục hàng hóa, dịch vụ",
    hide: 'fold',
    show: 'blind',
    position: ['center',5],
    buttons: 
    [
      {
        text: "Chọn",
        icons: { primary: "ui-icon-check" },
        click: function(){
          var i=1;
          var rowIndex = -1;
          $('input[name="check_i[]"]:checked').each(function () {
            var index = $('.nav-tabs li.active').index();
            if (rowIndex == -1) {
              rowIndex = $(this).attr('data');
            }
            console.log(rowIndex);
            
            var check = 0;
            $('.invoice_buy_item[data='+$(this).attr('value')+']').each(function(){
              check ++;
            });

            if (check==0) {
              if(i>1){
                $('.dataTable').each(function(){
                  addRow($(this).attr('id'));
                });
              }

              $('.invoice_buy_item:eq('+rowIndex+')').val($(this).attr('data-code'));
              $('.invoice_buy_item:eq('+rowIndex+')').attr('data',$(this).attr('value'));
              $('.invoice_buy_item_number:eq('+rowIndex+')').attr('alt',$(this).attr('data-stuff'));
              $('.invoice_buy_item_name:eq('+rowIndex+')').val($(this).attr('data-name'));
              $('.invoice_buy_item_unit:eq('+rowIndex+')').val($(this).attr('data-unit'));
              $('.invoice_buy_item_tax_vat_percent:eq('+rowIndex+')').val($(this).attr('data-tax'));
              $('.invoice_buy_item2:eq('+rowIndex+')').val($(this).attr('data-code'));
              $('.invoice_buy_item_name2:eq('+rowIndex+')').val($(this).attr('data-name'));

              i++;
              rowIndex++;
            }
            
          });
          $( "#show_item" ).dialog( "close" );
        }
      },
      {
        text: "Thêm",
        icons: { primary: "ui-icon-plus" },
        click: function(){
          $( "#add_new_item" ).dialog( "open" );
        }
      },
      {
        text: "Đóng",
        icons: { primary: "ui-icon-close" },
        click: function(){
          $( "#show_item" ).dialog( "close" );
        }
      },

    ]
});

$( "#add_new_item" ).dialog({
    autoOpen: false,
    modal: true,
    width: "auto",
    maxHeight: $(window).height()-50,
    title: "Thêm hàng hóa, dịch vụ",
    hide: 'fold',
    show: 'blind',
    position: ['center',5],
    buttons: 
    [
      {
        text: "Hoàn tất",
        icons: { primary: "ui-icon-check" },
        click: function(){
          var items_code = $('#items_code').attr('value');
          var items_name = $('#items_name').attr('value');
          var items_unit = $('#items_unit').attr('value');
          var items_type = $('#items_type').attr('value');
          var items_tax = $('#items_tax').attr('value');
          var items_stuff = $('#items_stuff').attr('value');

          var rowIndex = $('#rowIndex_item').attr('value');

          if (items_code == "" || items_name == "") {
            alert('Vui lòng điền vào thông tin!');
            return false;
          }
          
          var yes = "";
       
          $.ajax({
              type: "POST", // phương thức gởi đi
              url: "<?php echo BASE_URL ?>/items/add", // nơi mà dữ liệu sẽ chuyển đến khi submit
              data: {
                  
                  items_code: items_code,
                  items_name: items_name,
                  items_unit: items_unit,
                  items_type: items_type,
                  items_tax: items_tax,
                  items_stuff: items_stuff,
                  yes: yes,

                  }, // giá trị post
              success: function(answer){
                $( "#add_new_item" ).dialog( "close" );
                $( "#show_item" ).dialog( "close" );
                
                var rowIndex=$('#rowIndex_item').val();
                
                  $.ajax({
                      url: '<?php echo BASE_URL ?>/invoicebuy/getItem',
                      type: 'POST',
                      data: {rowIndex:rowIndex},
                      success:function(data){
                        $('#show_item').html(data);
                        $("#show_item" ).dialog( "open" );

                        $('#tblExport2').DataTable({
                            "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Tất cả"]],
                            "order": [[ 1, "asc" ], [ 2, "asc" ]],
                            "columnDefs": [ {
                              "targets": 0,
                              "orderable": false
                            } ],
                            "fnRowCallback": function( nRow, aData, iDisplayIndex, iDisplayIndexFull ) {
                              var index = iDisplayIndex +1;
                                $('.tr td:eq(0)',nRow).html(index);
                                return nRow
                            }
                        });

                        $('.tr').click(function(){
                          $(this).find('input').each(function () {
                            if ($(this).is(':checked')) {
                              $(this).prop('checked',false);
                            }
                            else{
                              $(this).prop('checked',true);
                            }
                          });
                        });
                      }

                  });
              }
            });
        }
      },
      {
        text: "Đóng",
        icons: { primary: "ui-icon-close" },
        click: function(){
          $( "#add_new_item" ).dialog( "close" );
        }
      },

    ]
});

$("#find_service_buy").click(function(){
    $.ajax({
        url: '<?php echo BASE_URL ?>/invoicebuy/getServicebuy',
        type: 'POST',
        data: {},
        success:function(data){
          $('#show_service_buy').html(data);
          $("#show_service_buy" ).dialog( "open" );

          $('#tblExport3').DataTable({
              "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Tất cả"]],
              "order": [[ 1, "asc" ], [ 2, "asc" ]],
              "columnDefs": [ {
                "targets": 0,
                "orderable": false
              } ],
              "fnRowCallback": function( nRow, aData, iDisplayIndex, iDisplayIndexFull ) {
                var index = iDisplayIndex +1;
                  $('.tr2 td:eq(0)',nRow).html(index);
                  return nRow
              }
          });

          $('.tr2').click(function(){
            $(this).find('input').each(function () {
              if ($(this).is(':checked')) {
                $(this).prop('checked',false);
              }
              else{
                $(this).prop('checked',true);
              }
            });
          });

          $('.numbers').keyup(function(event) {
                // skip for arrow keys
            if(event.which >= 37 && event.which <= 40) return;
            // format number
            $(this).val(function(index, value) {
              return value
                .replace(/[^0-9-.]/g, "")
                .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
              ;
            });
          });

          $('.money_add').keyup(function(){
            var rowIndex=$(this).closest('tr').index();
            var max = parseFloat($(this).attr('max')) || 0;
            var val_new = parseFloat(get_number(this)) || 0;
            if (val_new>max) {
              $(this).val(max);
              $(this).val(function(index, value) {
                return value
                  .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                ;
              });
            }
            var val = $(this).val() || 0;
            $('input[name="check_i2[]"]:eq('+rowIndex+')').attr('data-money',val);

          });

        }

    });
});
$("#find_service_buy2").click(function(){
    $.ajax({
        url: '<?php echo BASE_URL ?>/invoicebuy/getServicebuy2',
        type: 'POST',
        data: {},
        success:function(data){
          $('#show_service_buy2').html(data);
          $("#show_service_buy2" ).dialog( "open" );

          $('#tblExport4').DataTable({
              "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Tất cả"]],
              "order": [[ 1, "asc" ], [ 2, "asc" ]],
              "columnDefs": [ {
                "targets": 0,
                "orderable": false
              } ],
              "fnRowCallback": function( nRow, aData, iDisplayIndex, iDisplayIndexFull ) {
                var index = iDisplayIndex +1;
                  $('.tr2 td:eq(0)',nRow).html(index);
                  return nRow
              }
          });

          $('.tr3').click(function(){
            $(this).find('input').each(function () {
              if ($(this).is(':checked')) {
                $(this).prop('checked',false);
              }
              else{
                $(this).prop('checked',true);
              }
            });
          });

          $('.numbers').keyup(function(event) {
                // skip for arrow keys
            if(event.which >= 37 && event.which <= 40) return;
            // format number
            $(this).val(function(index, value) {
              return value
                .replace(/[^0-9-.]/g, "")
                .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
              ;
            });
          });

          $('.money_add2').keyup(function(){
            var rowIndex=$(this).closest('tr').index();
            var max = parseFloat($(this).attr('max')) || 0;
            var val_new = parseFloat(get_number(this)) || 0;
            if (val_new>max) {
              $(this).val(max);
              $(this).val(function(index, value) {
                return value
                  .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                ;
              });
            }
            var val = $(this).val() || 0;
            $('input[name="check_i3[]"]:eq('+rowIndex+')').attr('data-money',val);

          });

        }

    });
});

$( "#show_service_buy" ).dialog({
    autoOpen: false,
    modal: true,
    width: "70%",
    maxHeight: $(window).height()-50,
    title: "Hóa đơn dịch vụ",
    hide: 'fold',
    show: 'blind',
    position: ['center',5],
    buttons: 
    [
      {
        text: "Phân bổ theo hệ số",
        icons: { primary: "ui-icon-check" },
        click: function(){
          $('input[name="invoice_buy_allocation"][value=1]').attr('checked',true);

          var rowIndex=0;
          var money=0;
          $('input[name="check_i2[]"]:checked').each(function () {
            if (rowIndex>0) {
              addRow('dataTable2');
            }
            $('.service_buy:eq('+rowIndex+')').attr('data',$(this).attr('value'));
            $('.service_buy:eq('+rowIndex+')').val($(this).attr('data-doc'));
            $('.service_buy_total:eq('+rowIndex+')').val($(this).attr('data-money'));
            $('.service_buy_comment:eq('+rowIndex+')').val($(this).attr('data-com'));
            rowIndex++;
            money += parseFloat($(this).attr('data-money').replace(/\,/g,'')) || 0;
          });
          
          var percent=0;
          $('.invoice_buy_item_number').each(function(){
            var s = parseFloat($(this).val()) || 0;
            var st = parseFloat($(this).attr('alt')) || 0;
            percent += s/st;
          });

          $('.invoice_buy_item_number').each(function(){
            var rowIndex=$(this).closest('tr').index();
            var val = parseFloat($(this).val()) || 0;
            var stuff = parseFloat($(this).attr('alt')) || 0;
            if (val > 0) {
              var cost = roundDecimal(money/(stuff*percent),2);
              $('.invoice_buy_item_other_cost:eq('+rowIndex+')').val(cost);

              var price = parseFloat(get_number('.invoice_buy_item_price:eq('+rowIndex+')')) || 0;
              var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
              var vat = parseFloat(get_number('.invoice_buy_item_tax_vat_percent:eq('+rowIndex+')')) || 0;
              var imp = parseFloat(get_number('.invoice_buy_item_tax_import_percent:eq('+rowIndex+')')) || 0;
              var custom = parseFloat(get_number('.invoice_buy_item_custom_cost:eq('+rowIndex+')')) || 0;
              var custom_rate = parseFloat(get_number('.invoice_buy_item_custom_rate:eq('+rowIndex+')')) || 0;
              var rate = parseFloat(get_number('#invoice_buy_money_rate')) || 0;
              
              var nk = roundDecimal((price+custom)*custom_rate*sl*imp/100,0);
              var gtgt = roundDecimal((custom_rate*sl*(price+custom)+nk)*vat/100,0);

              var gt = sl*(roundDecimal(rate*(custom+price),2)+cost)+nk;
              
              $('.invoice_buy_item_tax_import:eq('+rowIndex+')').val(nk);
              $('.invoice_buy_item_tax_vat:eq('+rowIndex+')').val(gtgt);
              $('.invoice_buy_item_tax_total:eq('+rowIndex+')').val(nk+gtgt);

              $('.invoice_buy_item_total:eq('+rowIndex+')').val(roundDecimal(gt/sl,2));

              var tongtienhang = 0;
              $('.invoice_buy_item_money').each(function(){
                tongtienhang += parseFloat(get_number(this)) || 0;
              });

              var tongtienthuenhap = 0;
              $('.invoice_buy_item_tax_import').each(function(){
                tongtienthuenhap += parseFloat(get_number(this)) || 0;
              });

              var tongtienthuevat = 0;
              $('.invoice_buy_item_tax_vat').each(function(){
                tongtienthuevat += parseFloat(get_number(this)) || 0;
              });

              var tongchiphi = 0;
              var tongchiphi2 = 0;
              $('.invoice_buy_item_other_cost').each(function(){
                var rowIndex=$(this).closest('tr').index();
                var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
                tongchiphi2 += parseFloat(get_number(this))*sl || 0;
              });
              $('.invoice_buy_item_custom_cost_money').each(function(){
                var rowIndex=$(this).closest('tr').index();
                var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
                tongchiphi += roundDecimal((parseFloat(get_number(this)) || 0)*sl,2);
              });

              $('#import').html(tongtienthuenhap);
              $('#vat').html(tongtienthuevat);
              $('#cost_custom').html(tongchiphi);
              $('#cost_other').html(tongchiphi2);
              $('#money').html(tongtienhang);
              
              $('#total').html(tongtienthuenhap+tongtienhang+tongchiphi+tongchiphi2);

              $('#total').html(function(index, value) {
                return value
                  .replace(/[^0-9-.]/g, "")
                  .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                ;
              });

              $('#money').html(function(index, value) {
                return value
                  .replace(/[^0-9-.]/g, "")
                  .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                ;
              });
              
              $('#import').html(function(index, value) {
                return value
                  .replace(/[^0-9-.]/g, "")
                  .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                ;
              });

              $('#vat').html(function(index, value) {
                return value
                  .replace(/[^0-9-.]/g, "")
                  .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                ;
              });

              $('#cost_custom').html(function(index, value) {
                return value
                  .replace(/[^0-9-.]/g, "")
                  .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                ;
              });
              $('#cost_other').html(function(index, value) {
                return value
                  .replace(/[^0-9-.]/g, "")
                  .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                ;
              });

              $('.numbers').val(function(index, value) {
                return value
                  .replace(/[^0-9-.]/g, "")
                  .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                ;
              });
            }
          });


          $( "#show_service_buy" ).dialog( "close" );
        }
      },
      {
        text: "Phân bổ theo số lượng",
        icons: { primary: "ui-icon-check" },
        click: function(){
          $('input[name="invoice_buy_allocation"][value=2]').attr('checked',true);

          var rowIndex=0;
          var money=0;
          $('input[name="check_i2[]"]:checked').each(function () {
            if (rowIndex>0) {
              addRow('dataTable2');
            }
            $('.service_buy:eq('+rowIndex+')').attr('data',$(this).attr('value'));
            $('.service_buy:eq('+rowIndex+')').val($(this).attr('data-doc'));
            $('.service_buy_total:eq('+rowIndex+')').val($(this).attr('data-money'));
            $('.service_buy_comment:eq('+rowIndex+')').val($(this).attr('data-com'));
            rowIndex++;
            money += parseFloat($(this).attr('data-money').replace(/\,/g,'')) || 0;
          });
          var num=0;
          $('.invoice_buy_item_number').each(function(){
            num += parseFloat($(this).val()) || 0;
          });
          $('.invoice_buy_item_number').each(function(){
            var rowIndex=$(this).closest('tr').index();
            var val = parseFloat($(this).val()) || 0;
            if (val > 0) {
              var cost = roundDecimal(money/num,2);
              $('.invoice_buy_item_other_cost:eq('+rowIndex+')').val(cost);

              var price = parseFloat(get_number('.invoice_buy_item_price:eq('+rowIndex+')')) || 0;
              var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
              var vat = parseFloat(get_number('.invoice_buy_item_tax_vat_percent:eq('+rowIndex+')')) || 0;
              var imp = parseFloat(get_number('.invoice_buy_item_tax_import_percent:eq('+rowIndex+')')) || 0;
              var custom = parseFloat(get_number('.invoice_buy_item_custom_cost:eq('+rowIndex+')')) || 0;
              var custom_rate = parseFloat(get_number('.invoice_buy_item_custom_rate:eq('+rowIndex+')')) || 0;
              var rate = parseFloat(get_number('#invoice_buy_money_rate')) || 0;
              
              var nk = roundDecimal((price+custom)*custom_rate*sl*imp/100,0);
              var gtgt = roundDecimal((custom_rate*sl*(price+custom)+nk)*vat/100,0);

              var gt = sl*(roundDecimal(rate*(custom+price),2)+cost)+nk;
              
              $('.invoice_buy_item_tax_import:eq('+rowIndex+')').val(nk);
              $('.invoice_buy_item_tax_vat:eq('+rowIndex+')').val(gtgt);
              $('.invoice_buy_item_tax_total:eq('+rowIndex+')').val(nk+gtgt);

              $('.invoice_buy_item_total:eq('+rowIndex+')').val(roundDecimal(gt/sl,2));

              var tongtienhang = 0;
              $('.invoice_buy_item_money').each(function(){
                tongtienhang += parseFloat(get_number(this)) || 0;
              });

              var tongtienthuenhap = 0;
              $('.invoice_buy_item_tax_import').each(function(){
                tongtienthuenhap += parseFloat(get_number(this)) || 0;
              });

              var tongtienthuevat = 0;
              $('.invoice_buy_item_tax_vat').each(function(){
                tongtienthuevat += parseFloat(get_number(this)) || 0;
              });

              var tongchiphi = 0;
              var tongchiphi2 = 0;
              $('.invoice_buy_item_other_cost').each(function(){
                var rowIndex=$(this).closest('tr').index();
                var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
                tongchiphi2 += parseFloat(get_number(this))*sl || 0;
              });
              $('.invoice_buy_item_custom_cost_money').each(function(){
                var rowIndex=$(this).closest('tr').index();
                var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
                tongchiphi += roundDecimal((parseFloat(get_number(this)) || 0)*sl,2);
              });

              $('#import').html(tongtienthuenhap);
              $('#vat').html(tongtienthuevat);
              $('#cost_custom').html(tongchiphi);
              $('#cost_other').html(tongchiphi2);
              $('#money').html(tongtienhang);
              
              $('#total').html(tongtienthuenhap+tongtienhang+tongchiphi+tongchiphi2);

              $('#total').html(function(index, value) {
                return value
                  .replace(/[^0-9-.]/g, "")
                  .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                ;
              });

              $('#money').html(function(index, value) {
                return value
                  .replace(/[^0-9-.]/g, "")
                  .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                ;
              });
              
              $('#import').html(function(index, value) {
                return value
                  .replace(/[^0-9-.]/g, "")
                  .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                ;
              });

              $('#vat').html(function(index, value) {
                return value
                  .replace(/[^0-9-.]/g, "")
                  .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                ;
              });

              $('#cost_custom').html(function(index, value) {
                return value
                  .replace(/[^0-9-.]/g, "")
                  .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                ;
              });
              $('#cost_other').html(function(index, value) {
                return value
                  .replace(/[^0-9-.]/g, "")
                  .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                ;
              });

              $('.numbers').val(function(index, value) {
                return value
                  .replace(/[^0-9-.]/g, "")
                  .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                ;
              });
            }
          });


          $( "#show_service_buy" ).dialog( "close" );
        }
      },
      
      {
        text: "Đóng",
        icons: { primary: "ui-icon-close" },
        click: function(){
          $( "#show_service_buy" ).dialog( "close" );
        }
      },

    ]
});

$( "#show_service_buy2" ).dialog({
    autoOpen: false,
    modal: true,
    width: "70%",
    maxHeight: $(window).height()-50,
    title: "Hóa đơn dịch vụ",
    hide: 'fold',
    show: 'blind',
    position: ['center',5],
    buttons: 
    [
      {
        text: "Phân bổ theo hệ số",
        icons: { primary: "ui-icon-check" },
        click: function(){
          $('input[name="invoice_buy_allocation2"][value=1]').attr('checked',true);

          var rowIndex=0;
          var money=0;
          var money_foreign=0;
          $('input[name="check_i3[]"]:checked').each(function () {
            if (rowIndex>0) {
              addRow('dataTable3');
            }
            $('.service_buy2:eq('+rowIndex+')').attr('data',$(this).attr('value'));
            $('.service_buy2:eq('+rowIndex+')').val($(this).attr('data-doc'));
            $('.service_buy_total2:eq('+rowIndex+')').val($(this).attr('data-money'));
            $('.service_buy_total2:eq('+rowIndex+')').attr('data',$(this).attr('data-money-foreign'));
            $('.service_buy_comment2:eq('+rowIndex+')').val($(this).attr('data-com'));
            rowIndex++;
            money += parseFloat($(this).attr('data-money').replace(/\,/g,'')) || 0;
            money_foreign += parseFloat($(this).attr('data-money-foreign').replace(/\,/g,'')) || 0;
          });
          
          var percent=0;
          $('.invoice_buy_item_number').each(function(){
            var s = parseFloat($(this).val()) || 0;
            var st = parseFloat($(this).attr('alt')) || 0;
            percent += s/st;
          });

          $('.invoice_buy_item_number').each(function(){
            var rowIndex=$(this).closest('tr').index();
            var val = parseFloat($(this).val()) || 0;
            var stuff = parseFloat($(this).attr('alt')) || 0;
            if (val > 0) {
              var cost = roundDecimal(money/(stuff*percent),2);
              var cost_foreign = roundDecimal(money_foreign/(stuff*percent),6);
              $('.invoice_buy_item_custom_cost:eq('+rowIndex+')').val(cost_foreign);
              $('.invoice_buy_item_custom_cost_money:eq('+rowIndex+')').val(cost);

              var price = parseFloat(get_number('.invoice_buy_item_price:eq('+rowIndex+')')) || 0;
              var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
              var vat = parseFloat(get_number('.invoice_buy_item_tax_vat_percent:eq('+rowIndex+')')) || 0;
              var imp = parseFloat(get_number('.invoice_buy_item_tax_import_percent:eq('+rowIndex+')')) || 0;
              var custom = parseFloat(get_number('.invoice_buy_item_custom_cost:eq('+rowIndex+')')) || 0;
              var custom_money = parseFloat(get_number('.invoice_buy_item_custom_cost_money:eq('+rowIndex+')')) || 0;
              var custom_rate = parseFloat(get_number('.invoice_buy_item_custom_rate:eq('+rowIndex+')')) || 0;
              var rate = parseFloat(get_number('#invoice_buy_money_rate')) || 0;
              
              var nk = roundDecimal((price+custom)*custom_rate*sl*imp/100,0);
              var gtgt = roundDecimal((custom_rate*sl*(price+custom)+nk)*vat/100,0);

              var gt = sl*(roundDecimal(rate*price,2)+cost+custom_money)+nk;
              
              $('.invoice_buy_item_tax_import:eq('+rowIndex+')').val(nk);
              $('.invoice_buy_item_tax_vat:eq('+rowIndex+')').val(gtgt);
              $('.invoice_buy_item_tax_total:eq('+rowIndex+')').val(nk+gtgt);

              $('.invoice_buy_item_total:eq('+rowIndex+')').val(roundDecimal(gt/sl,2));

              var tongtienhang = 0;
              $('.invoice_buy_item_money').each(function(){
                tongtienhang += parseFloat(get_number(this)) || 0;
              });

              var tongtienthuenhap = 0;
              $('.invoice_buy_item_tax_import').each(function(){
                tongtienthuenhap += parseFloat(get_number(this)) || 0;
              });

              var tongtienthuevat = 0;
              $('.invoice_buy_item_tax_vat').each(function(){
                tongtienthuevat += parseFloat(get_number(this)) || 0;
              });

              var tongchiphi = 0;
              var tongchiphi2 = 0;
              $('.invoice_buy_item_other_cost').each(function(){
                var rowIndex=$(this).closest('tr').index();
                var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
                tongchiphi2 += parseFloat(get_number(this))*sl || 0;
              });
              $('.invoice_buy_item_custom_cost_money').each(function(){
                var rowIndex=$(this).closest('tr').index();
                var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
                tongchiphi += roundDecimal((parseFloat(get_number(this)) || 0)*sl,2);
              });

              $('#import').html(tongtienthuenhap);
              $('#vat').html(tongtienthuevat);
              $('#cost_custom').html(tongchiphi);
              $('#cost_other').html(tongchiphi2);
              $('#money').html(tongtienhang);
              
              $('#total').html(tongtienthuenhap+tongtienhang+tongchiphi+tongchiphi2);

              $('#total').html(function(index, value) {
                return value
                  .replace(/[^0-9-.]/g, "")
                  .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                ;
              });

              $('#money').html(function(index, value) {
                return value
                  .replace(/[^0-9-.]/g, "")
                  .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                ;
              });
              
              $('#import').html(function(index, value) {
                return value
                  .replace(/[^0-9-.]/g, "")
                  .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                ;
              });

              $('#vat').html(function(index, value) {
                return value
                  .replace(/[^0-9-.]/g, "")
                  .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                ;
              });

              $('#cost_custom').html(function(index, value) {
                return value
                  .replace(/[^0-9-.]/g, "")
                  .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                ;
              });
              $('#cost_other').html(function(index, value) {
                return value
                  .replace(/[^0-9-.]/g, "")
                  .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                ;
              });

              $('.numbers').val(function(index, value) {
                return value
                  .replace(/[^0-9-.]/g, "")
                  .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                ;
              });
            }
          });


          $( "#show_service_buy2" ).dialog( "close" );
        }
      },
      {
        text: "Phân bổ theo số lượng",
        icons: { primary: "ui-icon-check" },
        click: function(){
          $('input[name="invoice_buy_allocation2"][value=2]').attr('checked',true);

          var rowIndex=0;
          var money=0;
          var money_foreign=0;
          $('input[name="check_i3[]"]:checked').each(function () {
            if (rowIndex>0) {
              addRow('dataTable3');
            }
            $('.service_buy2:eq('+rowIndex+')').attr('data',$(this).attr('value'));
            $('.service_buy2:eq('+rowIndex+')').val($(this).attr('data-doc'));
            $('.service_buy_total2:eq('+rowIndex+')').val($(this).attr('data-money'));
            $('.service_buy_total2:eq('+rowIndex+')').attr('data',$(this).attr('data-money-foreign'));
            $('.service_buy_comment2:eq('+rowIndex+')').val($(this).attr('data-com'));
            rowIndex++;
            money += parseFloat($(this).attr('data-money').replace(/\,/g,'')) || 0;
            money_foreign += parseFloat($(this).attr('data-money-foreign').replace(/\,/g,'')) || 0;
          });
          var num=0;
          $('.invoice_buy_item_number').each(function(){
            num += parseFloat($(this).val()) || 0;
          });
          $('.invoice_buy_item_number').each(function(){
            var rowIndex=$(this).closest('tr').index();
            var val = parseFloat($(this).val()) || 0;
            if (val > 0) {
              var cost = roundDecimal(money/num,2);
              var cost_foreign = roundDecimal(money_foreign/num,6);
              $('.invoice_buy_item_custom_cost:eq('+rowIndex+')').val(cost_foreign);
              $('.invoice_buy_item_custom_cost_money:eq('+rowIndex+')').val(cost);

              var price = parseFloat(get_number('.invoice_buy_item_price:eq('+rowIndex+')')) || 0;
              var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
              var vat = parseFloat(get_number('.invoice_buy_item_tax_vat_percent:eq('+rowIndex+')')) || 0;
              var imp = parseFloat(get_number('.invoice_buy_item_tax_import_percent:eq('+rowIndex+')')) || 0;
              var custom = parseFloat(get_number('.invoice_buy_item_custom_cost:eq('+rowIndex+')')) || 0;
              var custom_money = parseFloat(get_number('.invoice_buy_item_custom_cost_money:eq('+rowIndex+')')) || 0;
              var custom_rate = parseFloat(get_number('.invoice_buy_item_custom_rate:eq('+rowIndex+')')) || 0;
              var rate = parseFloat(get_number('#invoice_buy_money_rate')) || 0;
              
              var nk = roundDecimal((price+custom)*custom_rate*sl*imp/100,0);
              var gtgt = roundDecimal((custom_rate*sl*(price+custom)+nk)*vat/100,0);

              var gt = sl*(roundDecimal(rate*price,2)+cost+custom_money)+nk;
              
              $('.invoice_buy_item_tax_import:eq('+rowIndex+')').val(nk);
              $('.invoice_buy_item_tax_vat:eq('+rowIndex+')').val(gtgt);
              $('.invoice_buy_item_tax_total:eq('+rowIndex+')').val(nk+gtgt);

              $('.invoice_buy_item_total:eq('+rowIndex+')').val(roundDecimal(gt/sl,2));

              var tongtienhang = 0;
              $('.invoice_buy_item_money').each(function(){
                tongtienhang += parseFloat(get_number(this)) || 0;
              });

              var tongtienthuenhap = 0;
              $('.invoice_buy_item_tax_import').each(function(){
                tongtienthuenhap += parseFloat(get_number(this)) || 0;
              });

              var tongtienthuevat = 0;
              $('.invoice_buy_item_tax_vat').each(function(){
                tongtienthuevat += parseFloat(get_number(this)) || 0;
              });

              var tongchiphi = 0;
              var tongchiphi2 = 0;
              $('.invoice_buy_item_other_cost').each(function(){
                var rowIndex=$(this).closest('tr').index();
                var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
                tongchiphi2 += parseFloat(get_number(this))*sl || 0;
              });
              $('.invoice_buy_item_custom_cost_money').each(function(){
                var rowIndex=$(this).closest('tr').index();
                var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
                tongchiphi += roundDecimal((parseFloat(get_number(this)) || 0)*sl,2);
              });

              $('#import').html(tongtienthuenhap);
              $('#vat').html(tongtienthuevat);
              $('#cost_custom').html(tongchiphi);
              $('#cost_other').html(tongchiphi2);
              $('#money').html(tongtienhang);
              
              $('#total').html(tongtienthuenhap+tongtienhang+tongchiphi+tongchiphi2);

              $('#total').html(function(index, value) {
                return value
                  .replace(/[^0-9-.]/g, "")
                  .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                ;
              });

              $('#money').html(function(index, value) {
                return value
                  .replace(/[^0-9-.]/g, "")
                  .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                ;
              });
              
              $('#import').html(function(index, value) {
                return value
                  .replace(/[^0-9-.]/g, "")
                  .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                ;
              });

              $('#vat').html(function(index, value) {
                return value
                  .replace(/[^0-9-.]/g, "")
                  .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                ;
              });

              $('#cost_custom').html(function(index, value) {
                return value
                  .replace(/[^0-9-.]/g, "")
                  .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                ;
              });
              $('#cost_other').html(function(index, value) {
                return value
                  .replace(/[^0-9-.]/g, "")
                  .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                ;
              });

              $('.numbers').val(function(index, value) {
                return value
                  .replace(/[^0-9-.]/g, "")
                  .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                ;
              });
            }
          });


          $( "#show_service_buy2" ).dialog( "close" );
        }
      },
      
      {
        text: "Đóng",
        icons: { primary: "ui-icon-close" },
        click: function(){
          $( "#show_service_buy2" ).dialog( "close" );
        }
      },

    ]
});
</script>
<script type="text/javascript">
    $(document).ready(function () {
 
      $('input').keyup(function (e) {
        if (e.which == 39) { // right arrow
          $(this).closest('td').next().find('input').focus();
 
        } else if (e.which == 37) { // left arrow
          $(this).closest('td').prev().find('input').focus();
 
        } else if (e.which == 40) { // down arrow
          $(this).closest('tr').next().find('td:eq(' + $(this).closest('td').index() + ')').find('input').focus();
 
        } else if (e.which == 38) { // up arrow
          $(this).closest('tr').prev().find('td:eq(' + $(this).closest('td').index() + ')').find('input').focus();
        }
      });
 
    // un-comment to display key code
    // $("input").keydown(function (e) {
    //   console.log(e.which);
    // });
    });

$('#dataTable0 tbody tr td:nth-child(2) input').keyup(function(){
  var val = $(this).val();
  var trIndex = $(this).closest('tr').index();
  $('#dataTable1 tbody tr:eq('+trIndex+') td:nth-child(2) input').val(val);
});
$('#dataTable0 tbody tr td:nth-child(3) input').keyup(function(){
  var val = $(this).val();
  var trIndex = $(this).closest('tr').index();
  $('#dataTable1 tbody tr:eq('+trIndex+') td:nth-child(3) input').val(val);
});

document.addEventListener("keydown", function(event) {
  var index = $('.nav-tabs li.active').index();
  var rowIndex=$('#dataTable'+index+' input:focus').closest('tr').index();
  if ($('#dataTable'+index+' input').is(':focus')) {
    if (event.keyCode == 113) { //F8
      //addRow('dataTable'+index);
      $('.dataTable').each(function(){
        addRow($(this).attr('id'));
      });
    }
    if (event.keyCode == 114) { //F9
      //delRow('dataTable'+index);
      $('.dataTable').each(function(){
        delRow($(this).attr('id'),rowIndex);
      });
    }
    if (event.keyCode == 13) {
        
        event.preventDefault();
        return false;
    }
  }
});

function addRow(id){
  var table=document.getElementById(id);
  var rowCount=table.rows.length;
  var row=table.insertRow(rowCount);
  var colCount=table.rows[1].cells.length;
  for(var i=0;i<colCount;i++){
      var newcell=row.insertCell(i);
      newcell.innerHTML=table.rows[1].cells[i].innerHTML;
      newcell.className=table.rows[1].cells[i].className;
      /*switch(newcell.childNodes[0].type){
          case"text":newcell.childNodes[0].value="";
          break;
          case"checkbox":newcell.childNodes[0].checked=false;
          break;
          case"select-one":newcell.childNodes[0].selectedIndex=0;
          break;
      }*/
  }
  $('#'+id+' tr:last td input').val("");
  $('#'+id+' tr:last td input.keep-val').each(function(){
    $(this).val($(this).closest('tr').prev().find('td:eq(' + $(this).closest('td').index() + ')').find('input').val());
  });
  $('#'+id+' tr:last td input').attr("data","");
  $('#'+id+' tr:last td input').attr("alt","");
  $('#'+id+' tr:last td input:first').focus();
  var i=1;
  $('#'+id+' tbody tr td:first-child').each(function() {
    $(this).text(i);
    i++;
  });
  $('input').keyup(function (e) {
      if (e.which == 39) { // right arrow
        $(this).closest('td').next().find('input').focus();

      } else if (e.which == 37) { // left arrow
        $(this).closest('td').prev().find('input').focus();

      } else if (e.which == 40) { // down arrow
        $(this).closest('tr').next().find('td:eq(' + $(this).closest('td').index() + ')').find('input').focus();

      } else if (e.which == 38) { // up arrow
        $(this).closest('tr').prev().find('td:eq(' + $(this).closest('td').index() + ')').find('input').focus();
      }
    });
  $('#dataTable0 tbody tr td:nth-child(2) input').keyup(function(){
    var val = $(this).val();
    var trIndex = $(this).closest('tr').index();
    $('#dataTable1 tbody tr:eq('+trIndex+') td:nth-child(2) input').val(val);
  });
  $('#dataTable0 tbody tr td:nth-child(3) input').keyup(function(){
    var val = $(this).val();
    var trIndex = $(this).closest('tr').index();
    $('#dataTable1 tbody tr:eq('+trIndex+') td:nth-child(3) input').val(val);
  });

  $('.numbers').keyup(function(event) {
      // skip for arrow keys
    if(event.which >= 37 && event.which <= 40) return;
    // format number
    $(this).val(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });
  });

  $(".invoice_buy_item_custom_cost").keyup(function(){
    var rowIndex=$(this).closest('tr').index();
    var price = parseFloat(get_number('.invoice_buy_item_price:eq('+rowIndex+')')) || 0;
    var custom = parseFloat(get_number(this)) || 0;
    var custom_money = parseFloat(get_number('.invoice_buy_item_custom_cost_money:eq('+rowIndex+')')) || 0;
    var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
    var vat = parseFloat(get_number('.invoice_buy_item_tax_vat_percent:eq('+rowIndex+')')) || 0;
    var imp = parseFloat(get_number('.invoice_buy_item_tax_import_percent:eq('+rowIndex+')')) || 0;
    var cost = parseFloat(get_number('.invoice_buy_item_other_cost:eq('+rowIndex+')')) || 0;
    var custom_rate = parseFloat(get_number('.invoice_buy_item_custom_rate:eq('+rowIndex+')')) || 0;
    var rate = parseFloat(get_number('#invoice_buy_money_rate')) || 0;
    
    var nk = roundDecimal((price+custom)*custom_rate*sl*imp/100,0);
    var gtgt = roundDecimal((custom_rate*sl*(price+custom)+nk)*vat/100,0);

    var gt = sl*(roundDecimal(rate*price,2)+cost+custom_money)+nk;
    
    $('.invoice_buy_item_tax_import:eq('+rowIndex+')').val(nk);
    $('.invoice_buy_item_tax_vat:eq('+rowIndex+')').val(gtgt);
    $('.invoice_buy_item_tax_total:eq('+rowIndex+')').val(nk+gtgt);

    $('.invoice_buy_item_total:eq('+rowIndex+')').val(roundDecimal(gt/sl,2));

    var tongtienhang = 0;
    $('.invoice_buy_item_money').each(function(){
      tongtienhang += parseFloat(get_number(this)) || 0;
    });

    var tongtienthuenhap = 0;
    $('.invoice_buy_item_tax_import').each(function(){
      tongtienthuenhap += parseFloat(get_number(this)) || 0;
    });

    var tongtienthuevat = 0;
    $('.invoice_buy_item_tax_vat').each(function(){
      tongtienthuevat += parseFloat(get_number(this)) || 0;
    });

    var tongchiphi = 0;
    var tongchiphi2 = 0;
    $('.invoice_buy_item_other_cost').each(function(){
      var rowIndex=$(this).closest('tr').index();
      var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
      tongchiphi2 += parseFloat(get_number(this))*sl || 0;
    });
    $('.invoice_buy_item_custom_cost_money').each(function(){
      var rowIndex=$(this).closest('tr').index();
      var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
      tongchiphi += roundDecimal((parseFloat(get_number(this)) || 0)*sl,2);
    });

    $('#import').html(tongtienthuenhap);
    $('#vat').html(tongtienthuevat);
    $('#cost_custom').html(tongchiphi);
    $('#cost_other').html(tongchiphi2);
    $('#money').html(tongtienhang);
    
    $('#total').html(tongtienthuenhap+tongtienhang+tongchiphi+tongchiphi2);

    $('#total').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });

    $('#money').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });
    
    $('#import').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });

    $('#vat').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });

    $('#cost_custom').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });
    $('#cost_other').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });

    $('.numbers').val(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });
  });

  $(".invoice_buy_item_custom_cost_money").keyup(function(){
    var rowIndex=$(this).closest('tr').index();
    var price = parseFloat(get_number('.invoice_buy_item_price:eq('+rowIndex+')')) || 0;
    var custom_money = parseFloat(get_number(this)) || 0;
    var custom = parseFloat(get_number('.invoice_buy_item_custom_cost:eq('+rowIndex+')')) || 0;
    var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
    var vat = parseFloat(get_number('.invoice_buy_item_tax_vat_percent:eq('+rowIndex+')')) || 0;
    var imp = parseFloat(get_number('.invoice_buy_item_tax_import_percent:eq('+rowIndex+')')) || 0;
    var cost = parseFloat(get_number('.invoice_buy_item_other_cost:eq('+rowIndex+')')) || 0;
    var custom_rate = parseFloat(get_number('.invoice_buy_item_custom_rate:eq('+rowIndex+')')) || 0;
    var rate = parseFloat(get_number('#invoice_buy_money_rate')) || 0;
    
    var nk = roundDecimal((price+custom)*custom_rate*sl*imp/100,0);
    var gtgt = roundDecimal((custom_rate*sl*(price+custom)+nk)*vat/100,0);

    var gt = sl*(roundDecimal(rate*price,2)+cost+custom_money)+nk;
    
    $('.invoice_buy_item_tax_import:eq('+rowIndex+')').val(nk);
    $('.invoice_buy_item_tax_vat:eq('+rowIndex+')').val(gtgt);
    $('.invoice_buy_item_tax_total:eq('+rowIndex+')').val(nk+gtgt);

    $('.invoice_buy_item_total:eq('+rowIndex+')').val(roundDecimal(gt/sl,2));

    var tongtienhang = 0;
    $('.invoice_buy_item_money').each(function(){
      tongtienhang += parseFloat(get_number(this)) || 0;
    });

    var tongtienthuenhap = 0;
    $('.invoice_buy_item_tax_import').each(function(){
      tongtienthuenhap += parseFloat(get_number(this)) || 0;
    });

    var tongtienthuevat = 0;
    $('.invoice_buy_item_tax_vat').each(function(){
      tongtienthuevat += parseFloat(get_number(this)) || 0;
    });

    var tongchiphi = 0;
    var tongchiphi2 = 0;
    $('.invoice_buy_item_other_cost').each(function(){
      var rowIndex=$(this).closest('tr').index();
      var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
      tongchiphi2 += parseFloat(get_number(this))*sl || 0;
    });
    $('.invoice_buy_item_custom_cost_money').each(function(){
      var rowIndex=$(this).closest('tr').index();
      var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
      tongchiphi += roundDecimal((parseFloat(get_number(this)) || 0)*sl,2);
    });

    $('#import').html(tongtienthuenhap);
    $('#vat').html(tongtienthuevat);
    $('#cost_custom').html(tongchiphi);
    $('#cost_other').html(tongchiphi2);
    $('#money').html(tongtienhang);
    
    $('#total').html(tongtienthuenhap+tongtienhang+tongchiphi+tongchiphi2);

    $('#total').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });

    $('#money').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });
    
    $('#import').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });

    $('#vat').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });

    $('#cost_custom').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });
    $('#cost_other').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });

    $('.numbers').val(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });
  });

  $(".invoice_buy_item_other_cost").keyup(function(){
    var rowIndex=$(this).closest('tr').index();
    var price = parseFloat(get_number('.invoice_buy_item_price:eq('+rowIndex+')')) || 0;
    var cost = parseFloat(get_number(this)) || 0;
    var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
    var vat = parseFloat(get_number('.invoice_buy_item_tax_vat_percent:eq('+rowIndex+')')) || 0;
    var imp = parseFloat(get_number('.invoice_buy_item_tax_import_percent:eq('+rowIndex+')')) || 0;
    var custom = parseFloat(get_number('.invoice_buy_item_custom_cost:eq('+rowIndex+')')) || 0;
    var custom_money = parseFloat(get_number('.invoice_buy_item_custom_cost_money:eq('+rowIndex+')')) || 0;
    var custom_rate = parseFloat(get_number('.invoice_buy_item_custom_rate:eq('+rowIndex+')')) || 0;
    var rate = parseFloat(get_number('#invoice_buy_money_rate')) || 0;
    
    var nk = roundDecimal((price+custom)*custom_rate*sl*imp/100,0);
    var gtgt = roundDecimal((custom_rate*sl*(price+custom)+nk)*vat/100,0);

    var gt = sl*(roundDecimal(rate*price,2)+cost+custom_money)+nk;
    
    $('.invoice_buy_item_tax_import:eq('+rowIndex+')').val(nk);
    $('.invoice_buy_item_tax_vat:eq('+rowIndex+')').val(gtgt);
    $('.invoice_buy_item_tax_total:eq('+rowIndex+')').val(nk+gtgt);

    $('.invoice_buy_item_total:eq('+rowIndex+')').val(roundDecimal(gt/sl,2));

    var tongtienhang = 0;
    $('.invoice_buy_item_money').each(function(){
      tongtienhang += parseFloat(get_number(this)) || 0;
    });

    var tongtienthuenhap = 0;
    $('.invoice_buy_item_tax_import').each(function(){
      tongtienthuenhap += parseFloat(get_number(this)) || 0;
    });

    var tongtienthuevat = 0;
    $('.invoice_buy_item_tax_vat').each(function(){
      tongtienthuevat += parseFloat(get_number(this)) || 0;
    });

    var tongchiphi = 0;
    var tongchiphi2 = 0;
    $('.invoice_buy_item_other_cost').each(function(){
      var rowIndex=$(this).closest('tr').index();
      var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
      tongchiphi2 += parseFloat(get_number(this))*sl || 0;
    });
    $('.invoice_buy_item_custom_cost_money').each(function(){
      var rowIndex=$(this).closest('tr').index();
      var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
      tongchiphi += roundDecimal((parseFloat(get_number(this)) || 0)*sl,2);
    });

    $('#import').html(tongtienthuenhap);
    $('#vat').html(tongtienthuevat);
    $('#cost_custom').html(tongchiphi);
    $('#cost_other').html(tongchiphi2);
    $('#money').html(tongtienhang);
    
    $('#total').html(tongtienthuenhap+tongtienhang+tongchiphi+tongchiphi2);

    $('#total').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });

    $('#money').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });
    
    $('#import').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });

    $('#vat').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });

    $('#cost_custom').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });
    $('#cost_other').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });

    $('.numbers').val(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });
  });

  $(".invoice_buy_item_number").keyup(function(){
    var rowIndex=$(this).closest('tr').index();
    var price = parseFloat(get_number('.invoice_buy_item_price:eq('+rowIndex+')')) || 0;
    var sl = parseFloat(get_number(this)) || 0;
    var custom = parseFloat(get_number('.invoice_buy_item_custom_cost:eq('+rowIndex+')')) || 0;
    var custom_money = parseFloat(get_number('.invoice_buy_item_custom_cost_money:eq('+rowIndex+')')) || 0;
    var vat = parseFloat(get_number('.invoice_buy_item_tax_vat_percent:eq('+rowIndex+')')) || 0;
    var imp = parseFloat(get_number('.invoice_buy_item_tax_import_percent:eq('+rowIndex+')')) || 0;
    var cost = parseFloat(get_number('.invoice_buy_item_other_cost:eq('+rowIndex+')')) || 0;
    var custom_rate = parseFloat(get_number('.invoice_buy_item_custom_rate:eq('+rowIndex+')')) || 0;
    var rate = parseFloat(get_number('#invoice_buy_money_rate')) || 0;
    
    var tien = roundDecimal(sl*price*rate,2);
    var nk = roundDecimal((price+custom)*custom_rate*sl*imp/100,0);
    var gtgt = roundDecimal((custom_rate*sl*(price+custom)+nk)*vat/100,0);

    var gt = sl*(roundDecimal(rate*price,2)+cost+custom_money)+nk;
    
    $('.invoice_buy_item_money:eq('+rowIndex+')').val(tien);
    $('.invoice_buy_item_tax_import:eq('+rowIndex+')').val(nk);
    $('.invoice_buy_item_tax_vat:eq('+rowIndex+')').val(gtgt);
    $('.invoice_buy_item_tax_total:eq('+rowIndex+')').val(nk+gtgt);

    $('.invoice_buy_item_total:eq('+rowIndex+')').val(roundDecimal(gt/sl,2));

    var tongtienhangnt = 0;
    $('.invoice_buy_item_price').each(function(){
      var rowIndex=$(this).closest('tr').index();
      var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
      tongtienhangnt += roundDecimal(parseFloat(get_number(this))*sl,2) || 0;
    });

    var tongtienhang = 0;
    $('.invoice_buy_item_money').each(function(){
      tongtienhang += parseFloat(get_number(this)) || 0;
    });

    var tongtienthuenhap = 0;
    $('.invoice_buy_item_tax_import').each(function(){
      tongtienthuenhap += parseFloat(get_number(this)) || 0;
    });

    var tongtienthuevat = 0;
    $('.invoice_buy_item_tax_vat').each(function(){
      tongtienthuevat += parseFloat(get_number(this)) || 0;
    });

    var tongchiphi = 0;
    var tongchiphi2 = 0;
    $('.invoice_buy_item_other_cost').each(function(){
      var rowIndex=$(this).closest('tr').index();
      var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
      tongchiphi2 += parseFloat(get_number(this))*sl || 0;
    });
    $('.invoice_buy_item_custom_cost_money').each(function(){
      var rowIndex=$(this).closest('tr').index();
      var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
      tongchiphi += roundDecimal((parseFloat(get_number(this)) || 0)*sl,2);
    });

    $('#import').html(tongtienthuenhap);
    $('#vat').html(tongtienthuevat);
    $('#cost_custom').html(tongchiphi);
    $('#cost_other').html(tongchiphi2);
    $('#money').html(tongtienhang);
    
    $('#total').html(tongtienthuenhap+tongtienhang+tongchiphi+tongchiphi2);

    $('#price').html(tongtienhangnt);

    $('#price').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });

    $('#total').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });

    $('#money').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });
    
    $('#import').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });

    $('#vat').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });

    $('#cost_custom').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });
    $('#cost_other').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });

    $('.numbers').val(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });
  });
  $(".invoice_buy_item_price").keyup(function(){
    var rowIndex=$(this).closest('tr').index();
    var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
    var price = parseFloat(get_number(this)) || 0;
    var custom = parseFloat(get_number('.invoice_buy_item_custom_cost:eq('+rowIndex+')')) || 0;
    var custom_money = parseFloat(get_number('.invoice_buy_item_custom_cost_money:eq('+rowIndex+')')) || 0;
    var vat = parseFloat(get_number('.invoice_buy_item_tax_vat_percent:eq('+rowIndex+')')) || 0;
    var imp = parseFloat(get_number('.invoice_buy_item_tax_import_percent:eq('+rowIndex+')')) || 0;
    var cost = parseFloat(get_number('.invoice_buy_item_other_cost:eq('+rowIndex+')')) || 0;
    var custom_rate = parseFloat(get_number('.invoice_buy_item_custom_rate:eq('+rowIndex+')')) || 0;
    var rate = parseFloat(get_number('#invoice_buy_money_rate')) || 0;
    
    var tien = roundDecimal(sl*price*rate,2);
    var nk = roundDecimal((price+custom)*custom_rate*sl*imp/100,0);
    var gtgt = roundDecimal((custom_rate*sl*(price+custom)+nk)*vat/100,0);

    var gt = sl*(roundDecimal(rate*price,2)+cost+custom_money)+nk;
    
    $('.invoice_buy_item_money:eq('+rowIndex+')').val(tien);
    $('.invoice_buy_item_tax_import:eq('+rowIndex+')').val(nk);
    $('.invoice_buy_item_tax_vat:eq('+rowIndex+')').val(gtgt);
    $('.invoice_buy_item_tax_total:eq('+rowIndex+')').val(nk+gtgt);

    $('.invoice_buy_item_total:eq('+rowIndex+')').val(roundDecimal(gt/sl,2));

    var tongtienhangnt = 0;
    $('.invoice_buy_item_price').each(function(){
      var rowIndex=$(this).closest('tr').index();
      var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
      tongtienhangnt += roundDecimal(parseFloat(get_number(this))*sl,2) || 0;
    });

    var tongtienhang = 0;
    $('.invoice_buy_item_money').each(function(){
      tongtienhang += parseFloat(get_number(this)) || 0;
    });

    var tongtienthuenhap = 0;
    $('.invoice_buy_item_tax_import').each(function(){
      tongtienthuenhap += parseFloat(get_number(this)) || 0;
    });

    var tongtienthuevat = 0;
    $('.invoice_buy_item_tax_vat').each(function(){
      tongtienthuevat += parseFloat(get_number(this)) || 0;
    });

    var tongchiphi = 0;
    var tongchiphi2 = 0;
    $('.invoice_buy_item_other_cost').each(function(){
      var rowIndex=$(this).closest('tr').index();
      var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
      tongchiphi2 += parseFloat(get_number(this))*sl || 0;
    });
    $('.invoice_buy_item_custom_cost_money').each(function(){
      var rowIndex=$(this).closest('tr').index();
      var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
      tongchiphi += roundDecimal((parseFloat(get_number(this)) || 0)*sl,2);
    });

    $('#import').html(tongtienthuenhap);
    $('#vat').html(tongtienthuevat);
    $('#cost_custom').html(tongchiphi);
    $('#cost_other').html(tongchiphi2);
    $('#money').html(tongtienhang);
    
    $('#total').html(tongtienthuenhap+tongtienhang+tongchiphi+tongchiphi2);

    $('#price').html(tongtienhangnt);

    $('#price').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });
    $('#total').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });

    $('#money').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });
    
    $('#import').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });

    $('#vat').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });

    $('#cost_custom').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });
    $('#cost_other').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });

    $('.numbers').val(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });
  });
  $(".invoice_buy_item_tax_vat_percent").keyup(function(){
    var rowIndex=$(this).closest('tr').index();
    var price = parseFloat(get_number('.invoice_buy_item_price:eq('+rowIndex+')')) || 0;
    var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
    var vat = parseFloat($(this).val()) || 0;
    var custom = parseFloat(get_number('.invoice_buy_item_custom_cost:eq('+rowIndex+')')) || 0;
    var custom_money = parseFloat(get_number('.invoice_buy_item_custom_cost_money:eq('+rowIndex+')')) || 0;
    var imp = parseFloat(get_number('.invoice_buy_item_tax_import_percent:eq('+rowIndex+')')) || 0;
    var cost = parseFloat(get_number('.invoice_buy_item_other_cost:eq('+rowIndex+')')) || 0;
    var custom_rate = parseFloat(get_number('.invoice_buy_item_custom_rate:eq('+rowIndex+')')) || 0;
    var rate = parseFloat(get_number('#invoice_buy_money_rate')) || 0;

    var nk = roundDecimal((price+custom)*custom_rate*sl*imp/100,0);
    var gtgt = roundDecimal((custom_rate*sl*(price+custom)+nk)*vat/100,0);

    var gt = sl*(roundDecimal(rate*price,2)+cost+custom_money)+nk;
    
    $('.invoice_buy_item_tax_import:eq('+rowIndex+')').val(nk);
    $('.invoice_buy_item_tax_vat:eq('+rowIndex+')').val(gtgt);
    $('.invoice_buy_item_tax_total:eq('+rowIndex+')').val(nk+gtgt);

    $('.invoice_buy_item_total:eq('+rowIndex+')').val(roundDecimal(gt/sl,2));

    var tongtienthuenhap = 0;
    $('.invoice_buy_item_tax_import').each(function(){
      tongtienthuenhap += parseFloat(get_number(this)) || 0;
    });

    var tongtienthuevat = 0;
    $('.invoice_buy_item_tax_vat').each(function(){
      tongtienthuevat += parseFloat(get_number(this)) || 0;
    });

    var tongchiphi = 0;
    var tongchiphi2 = 0;
    $('.invoice_buy_item_other_cost').each(function(){
      var rowIndex=$(this).closest('tr').index();
      var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
      tongchiphi2 += parseFloat(get_number(this))*sl || 0;
    });
    $('.invoice_buy_item_custom_cost_money').each(function(){
      var rowIndex=$(this).closest('tr').index();
      var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
      tongchiphi += roundDecimal((parseFloat(get_number(this)) || 0)*sl,2);
    });

    $('#import').html(tongtienthuenhap);
    $('#vat').html(tongtienthuevat);
    $('#cost_custom').html(tongchiphi);
    $('#cost_other').html(tongchiphi2);

    var tongtienhang = parseFloat($('#money').html().replace(/\,/g,''));

    $('#total').html(tongtienthuenhap+tongtienhang+tongchiphi+tongchiphi2);

    $('#total').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });
    
    $('#import').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });

    $('#vat').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });

    $('#cost_custom').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });
    $('#cost_other').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });

    $('.numbers').val(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });
  });
  $(".invoice_buy_item_tax_import_percent").keyup(function(){
    var rowIndex=$(this).closest('tr').index();
    var price = parseFloat(get_number('.invoice_buy_item_price:eq('+rowIndex+')')) || 0;
    var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
    var imp = parseFloat($(this).val()) || 0;
    var custom = parseFloat(get_number('.invoice_buy_item_custom_cost:eq('+rowIndex+')')) || 0;
    var custom_money = parseFloat(get_number('.invoice_buy_item_custom_cost_money:eq('+rowIndex+')')) || 0;
    var vat = parseFloat(get_number('.invoice_buy_item_tax_vat_percent:eq('+rowIndex+')')) || 0;
    var cost = parseFloat(get_number('.invoice_buy_item_other_cost:eq('+rowIndex+')')) || 0;
    var custom_rate = parseFloat(get_number('.invoice_buy_item_custom_rate:eq('+rowIndex+')')) || 0;
    var rate = parseFloat(get_number('#invoice_buy_money_rate')) || 0;

    var nk = roundDecimal((price+custom)*custom_rate*sl*imp/100,0);
    var gtgt = roundDecimal((custom_rate*sl*(price+custom)+nk)*vat/100,0);

    var gt = sl*(roundDecimal(rate*price,2)+cost+custom_money)+nk;
    
    $('.invoice_buy_item_tax_import:eq('+rowIndex+')').val(nk);
    $('.invoice_buy_item_tax_vat:eq('+rowIndex+')').val(gtgt);
    $('.invoice_buy_item_tax_total:eq('+rowIndex+')').val(nk+gtgt);

    $('.invoice_buy_item_total:eq('+rowIndex+')').val(roundDecimal(gt/sl,2));

    var tongtienthuenhap = 0;
    $('.invoice_buy_item_tax_import').each(function(){
      tongtienthuenhap += parseFloat(get_number(this)) || 0;
    });

    var tongtienthuevat = 0;
    $('.invoice_buy_item_tax_vat').each(function(){
      tongtienthuevat += parseFloat(get_number(this)) || 0;
    });

    var tongchiphi = 0;
    var tongchiphi2 = 0;
    $('.invoice_buy_item_other_cost').each(function(){
      var rowIndex=$(this).closest('tr').index();
      var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
      tongchiphi2 += parseFloat(get_number(this))*sl || 0;
    });
    $('.invoice_buy_item_custom_cost_money').each(function(){
      var rowIndex=$(this).closest('tr').index();
      var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
      tongchiphi += roundDecimal((parseFloat(get_number(this)) || 0)*sl,2);
    });

    $('#import').html(tongtienthuenhap);
    $('#vat').html(tongtienthuevat);
    $('#cost_custom').html(tongchiphi);
    $('#cost_other').html(tongchiphi2);

    var tongtienhang = parseFloat($('#money').html().replace(/\,/g,''));

    $('#total').html(tongtienthuenhap+tongtienhang+tongchiphi+tongchiphi2);

    $('#total').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });
    
    $('#import').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });

    $('#vat').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });

    $('#cost_custom').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });
    $('#cost_other').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });

    $('.numbers').val(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });
  });
  $(".invoice_buy_item_custom_rate").keyup(function(){
    var rowIndex=$(this).closest('tr').index();
    var price = parseFloat(get_number('.invoice_buy_item_price:eq('+rowIndex+')')) || 0;
    var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
    var custom_rate = parseFloat(get_number(this)) || 0;
    var custom = parseFloat(get_number('.invoice_buy_item_custom_cost:eq('+rowIndex+')')) || 0;
    var custom_money = parseFloat(get_number('.invoice_buy_item_custom_cost_money:eq('+rowIndex+')')) || 0;
    var vat = parseFloat(get_number('.invoice_buy_item_tax_vat_percent:eq('+rowIndex+')')) || 0;
    var cost = parseFloat(get_number('.invoice_buy_item_other_cost:eq('+rowIndex+')')) || 0;
    var imp = parseFloat(get_number('.invoice_buy_item_tax_import_percent:eq('+rowIndex+')')) || 0;
    var rate = parseFloat(get_number('#invoice_buy_money_rate')) || 0;

    var nk = roundDecimal((price+custom)*custom_rate*sl*imp/100,0);
    var gtgt = roundDecimal((custom_rate*sl*(price+custom)+nk)*vat/100,0);

    var gt = sl*(roundDecimal(rate*price,2)+cost+custom_money)+nk;
    
    $('.invoice_buy_item_tax_import:eq('+rowIndex+')').val(nk);
    $('.invoice_buy_item_tax_vat:eq('+rowIndex+')').val(gtgt);
    $('.invoice_buy_item_tax_total:eq('+rowIndex+')').val(nk+gtgt);

    $('.invoice_buy_item_total:eq('+rowIndex+')').val(roundDecimal(gt/sl,2));

    var tongtienthuenhap = 0;
    $('.invoice_buy_item_tax_import').each(function(){
      tongtienthuenhap += parseFloat(get_number(this)) || 0;
    });

    var tongtienthuevat = 0;
    $('.invoice_buy_item_tax_vat').each(function(){
      tongtienthuevat += parseFloat(get_number(this)) || 0;
    });

    var tongchiphi = 0;
    var tongchiphi2 = 0;
    $('.invoice_buy_item_other_cost').each(function(){
      var rowIndex=$(this).closest('tr').index();
      var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
      tongchiphi2 += parseFloat(get_number(this))*sl || 0;
    });
    $('.invoice_buy_item_custom_cost_money').each(function(){
      var rowIndex=$(this).closest('tr').index();
      var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
      tongchiphi += roundDecimal((parseFloat(get_number(this)) || 0)*sl,2);
    });

    $('#import').html(tongtienthuenhap);
    $('#vat').html(tongtienthuevat);
    $('#cost_custom').html(tongchiphi);
    $('#cost_other').html(tongchiphi2);

    var tongtienhang = parseFloat($('#money').html().replace(/\,/g,''));

    $('#total').html(tongtienthuenhap+tongtienhang+tongchiphi+tongchiphi2);

    $('#total').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });
    
    $('#import').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });

    $('#vat').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });

    $('#cost_custom').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });

    $('#cost_other').html(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });

    $('.numbers').val(function(index, value) {
      return value
        .replace(/[^0-9-.]/g, "")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      ;
    });
  });

  
  $('.invoice_buy_item_house').keyup(function(){
    var row = $(this).parent().parent();
    var rowIndex = (row[0].rowIndex)-1;
    var keyword = $(this).val();
    if(keyword != ""){
      $.ajax({
          url: '<?php echo BASE_URL ?>/invoicebuy/getHouse',
          type: 'POST',
          data: {keyword:keyword, offset:rowIndex},
          success:function(data){
              $('.name_list_id_4:eq('+rowIndex+')').slideDown(200);
              $('.name_list_id_4:eq('+rowIndex+')').html(data);
          }
      });
    }

    if ($('.invoice_buy_item_house:eq('+rowIndex+')').val() == "" || $('.invoice_buy_item_house:eq('+rowIndex+')').attr('data') == "") {
      $('.invoice_buy_item_house:eq('+rowIndex+')').attr('data',"");
    }
  });
  $('.invoice_buy_item').keyup(function(){
      var row = $(this).parent().parent();
      var rowIndex = (row[0].rowIndex)-1;
      var keyword = $(this).val();
      if(keyword != ""){
        $.ajax({
            url: '<?php echo BASE_URL ?>/invoicebuy/getItemName',
            type: 'POST',
            data: {keyword:keyword, offset:rowIndex},
            success:function(data){
                $('.name_list_id:eq('+rowIndex+')').slideDown(200);
                $('.name_list_id:eq('+rowIndex+')').html(data);
            }
        });
      }

      if ($('.invoice_buy_item:eq('+rowIndex+')').val() == "" || $('.invoice_buy_item:eq('+rowIndex+')').attr('data') == "") {
        $('.invoice_buy_item:eq('+rowIndex+')').attr('data',"");
      }
  });
  $('.invoice_buy_item_debit').keyup(function(){
      var row = $(this).parent().parent();
      var rowIndex = (row[0].rowIndex)-1;
      var keyword = $(this).val();
      var name = ".invoice_buy_item_debit";
      if(keyword != ""){
        $.ajax({
            url: '<?php echo BASE_URL ?>/invoicebuy/getAccount',
            type: 'POST',
            data: {keyword:keyword, offset:rowIndex, name:name},
            success:function(data){
                $('.name_list_id_2:eq('+rowIndex+')').slideDown(200);
                $('.name_list_id_2:eq('+rowIndex+')').html(data);
            }
        });
      }

      if ($('.invoice_buy_item_debit:eq('+rowIndex+')').val() == "" || $('.invoice_buy_item_debit:eq('+rowIndex+')').attr('data') == "") {
        $('.invoice_buy_item_debit:eq('+rowIndex+')').attr('data',"");
      }
  });
  $('.invoice_buy_item_credit').keyup(function(){
      var row = $(this).parent().parent();
      var rowIndex = (row[0].rowIndex)-1;
      var keyword = $(this).val();
      var name = ".invoice_buy_item_credit";
      if(keyword != ""){
        $.ajax({
          url: '<?php echo BASE_URL ?>/invoicebuy/getAccount',
          type: 'POST',
          data: {keyword:keyword, offset:rowIndex, name:name},
          success:function(data){
              $('.name_list_id_3:eq('+rowIndex+')').slideDown(200);
              $('.name_list_id_3:eq('+rowIndex+')').html(data);
          }
        });
      }
      

      if ($('.invoice_buy_item_credit:eq('+rowIndex+')').val() == "" || $('.invoice_buy_item_credit:eq('+rowIndex+')').attr('data') == "") {
        $('.invoice_buy_item_credit:eq('+rowIndex+')').attr('data',"");
      }
  });
  $('.invoice_buy_item_tax_import_debit').keyup(function(){
      var row = $(this).parent().parent();
      var rowIndex = (row[0].rowIndex)-1;
      var keyword = $(this).val();
      var name = ".invoice_buy_item_tax_import_debit";
      if(keyword != ""){
        $.ajax({
            url: '<?php echo BASE_URL ?>/invoicebuy/getAccount',
            type: 'POST',
            data: {keyword:keyword, offset:rowIndex, name:name},
            success:function(data){
                $('.name_list_id_5:eq('+rowIndex+')').slideDown(200);
                $('.name_list_id_5:eq('+rowIndex+')').html(data);
            }
        });
      }

      if ($('.invoice_buy_item_tax_import_debit:eq('+rowIndex+')').val() == "" || $('.invoice_buy_item_tax_import_debit:eq('+rowIndex+')').attr('data') == "") {
        $('.invoice_buy_item_tax_import_debit:eq('+rowIndex+')').attr('data',"");
      }
  });
  $('.invoice_buy_item_tax_vat_debit').keyup(function(){
      var row = $(this).parent().parent();
      var rowIndex = (row[0].rowIndex)-1;
      var keyword = $(this).val();
      var name = ".invoice_buy_item_tax_vat_debit";
      if(keyword != ""){
        $.ajax({
            url: '<?php echo BASE_URL ?>/invoicebuy/getAccount',
            type: 'POST',
            data: {keyword:keyword, offset:rowIndex, name:name},
            success:function(data){
                $('.name_list_id_6:eq('+rowIndex+')').slideDown(200);
                $('.name_list_id_6:eq('+rowIndex+')').html(data);
            }
        });
      }

      if ($('.invoice_buy_item_tax_vat_debit:eq('+rowIndex+')').val() == "" || $('.invoice_buy_item_tax_vat_debit:eq('+rowIndex+')').attr('data') == "") {
        $('.invoice_buy_item_tax_vat_debit:eq('+rowIndex+')').attr('data',"");
      }
  });
  $('.invoice_buy_item_tax_vat_credit').keyup(function(){
      var row = $(this).parent().parent();
      var rowIndex = (row[0].rowIndex)-1;
      var keyword = $(this).val();
      var name = ".invoice_buy_item_tax_vat_credit";
      if(keyword != ""){
        $.ajax({
            url: '<?php echo BASE_URL ?>/invoicebuy/getAccount',
            type: 'POST',
            data: {keyword:keyword, offset:rowIndex, name:name},
            success:function(data){
                $('.name_list_id_7:eq('+rowIndex+')').slideDown(200);
                $('.name_list_id_7:eq('+rowIndex+')').html(data);
            }
        });
      }

      if ($('.invoice_buy_item_tax_vat_credit:eq('+rowIndex+')').val() == "" || $('.invoice_buy_item_tax_vat_credit:eq('+rowIndex+')').attr('data') == "") {
        $('.invoice_buy_item_tax_vat_credit:eq('+rowIndex+')').attr('data',"");
      }
  });
  $('.invoice_buy_item_custom_cost_debit').keyup(function(){
      var row = $(this).parent().parent();
      var rowIndex = (row[0].rowIndex)-1;
      var keyword = $(this).val();
      var name = ".invoice_buy_item_custom_cost_debit";
      if(keyword != ""){
        $.ajax({
            url: '<?php echo BASE_URL ?>/invoicebuy/getAccount',
            type: 'POST',
            data: {keyword:keyword, offset:rowIndex, name:name},
            success:function(data){
                $('.name_list_id_8:eq('+rowIndex+')').slideDown(200);
                $('.name_list_id_8:eq('+rowIndex+')').html(data);
            }
        });
      }

      if ($('.invoice_buy_item_custom_cost_debit:eq('+rowIndex+')').val() == "" || $('.invoice_buy_item_custom_cost_debit:eq('+rowIndex+')').attr('data') == "") {
        $('.invoice_buy_item_custom_cost_debit:eq('+rowIndex+')').attr('data',"");
      }
  });
  function set_item_account(value,code,name,vitri) {
      $(name+':eq('+vitri+')').val(code);
      $(name+':eq('+vitri+')').attr("data",value);
      
      $('.name_list_id_2').hide();
      $('.name_list_id_3').hide();
      $('.name_list_id_5').hide();
      $('.name_list_id_6').hide();
      $('.name_list_id_7').hide();
      $('name_list_id_8').hide();
      $(name+':eq('+vitri+')').focus();
  }
  function set_item_house(value,code,name,vitri) {
      $('.invoice_buy_item_house:eq('+vitri+')').val(code);
      $('.invoice_buy_item_house:eq('+vitri+')').attr("data",value);
      
      $('.name_list_id_4').hide();
      $('.invoice_buy_item_house:eq('+vitri+')').focus();
  }
  function set_item(value,code,name,unit,tax,stuff,vitri) {
      $('.invoice_buy_item:eq('+vitri+')').val(code);
      $('.invoice_buy_item:eq('+vitri+')').attr("data",value);
      $('.invoice_buy_item_number:eq('+vitri+')').attr("alt",stuff);
      $('.invoice_buy_item_name:eq('+vitri+')').val(name);
      $('.invoice_buy_item_unit:eq('+vitri+')').val(unit);
      $('.invoice_buy_item_tax_vat_percent:eq('+vitri+')').val(tax);
      $('.invoice_buy_item2:eq('+vitri+')').val(code);
      $('.invoice_buy_item_name2:eq('+vitri+')').val(name);
      $('.name_list_id').hide();
      $('.invoice_buy_item:eq('+vitri+')').focus();

      var check = 0;
      var val = value;
      $('.invoice_buy_item').each(function(){
        if (val == $(this).attr('data')) {
          check++
        }
      });

      if (check>=2) {
        alert('Mã đã tồn tại. Vui lòng chọn mã khác!');
        $('.invoice_buy_item:eq('+vitri+')').val("");
        $('.invoice_buy_item:eq('+vitri+')').attr("data","");
        $('.invoice_buy_item:eq('+vitri+')').attr("alt","");
        $('.invoice_buy_item_name:eq('+vitri+')').val("");
        $('.invoice_buy_item_unit:eq('+vitri+')').val("");
        $('.invoice_buy_item_tax_vat_percent:eq('+vitri+')').val("");
        $('.invoice_buy_item2:eq('+vitri+')').val("");
        $('.invoice_buy_item_name2:eq('+vitri+')').val("");
      }
  }


  $(".find_item").click(function(){
    var rowIndex=$(this).closest('tr').index();
    $('#rowIndex_item').val(rowIndex);
      $.ajax({
          url: '<?php echo BASE_URL ?>/invoicebuy/getItem',
          type: 'POST',
          data: {rowIndex:rowIndex},
          success:function(data){
            $('#show_item').html(data);
            $("#show_item" ).dialog( "open" );

            $('#tblExport2').DataTable({
                "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Tất cả"]],
                "order": [[ 1, "asc" ], [ 2, "asc" ]],
                "columnDefs": [ {
                  "targets": 0,
                  "orderable": false
                } ],
                "fnRowCallback": function( nRow, aData, iDisplayIndex, iDisplayIndexFull ) {
                  var index = iDisplayIndex +1;
                    $('.tr td:eq(0)',nRow).html(index);
                    return nRow
                }
            });

            $('.tr').click(function(){
              $(this).find('input').each(function () {
                if ($(this).is(':checked')) {
                  $(this).prop('checked',false);
                }
                else{
                  $(this).prop('checked',true);
                }
              });
            });
          }

      });
  });
}
function delRow(id,rowIndex){
  try{
      var table=document.getElementById(id);
      var rowCount=table.rows.length;
      if(rowCount<=2){
        alert("Cannot delete all the rows.");
      }
      else{
        table.deleteRow(rowIndex+1);
      }
      
      $('#'+id+' tr:last td input:first').focus();
      var i=1;
      $('#'+id+' tbody tr td:first-child').each(function() {
        $(this).text(i);
        i++;
      });

      var rate = parseFloat(get_number('#invoice_buy_money_rate')) || 0;
      var tongtienhang = 0;
      var tongtienthuenhap = 0;
      var tongtienthuevat = 0;
      var tongchiphi = 0;
      var tongchiphi2 = 0;
      $('.invoice_buy_item_money').each(function(){
        var rowIndex=$(this).closest('tr').index();

        var price = parseFloat(get_number('.invoice_buy_item_price:eq('+rowIndex+')')) || 0;
        var sl = parseFloat(get_number('.invoice_buy_item_number:eq('+rowIndex+')')) || 0;
        var custom = parseFloat(get_number('.invoice_buy_item_custom_cost:eq('+rowIndex+')')) || 0;
        var custom_money = parseFloat(get_number('.invoice_buy_item_custom_cost_money:eq('+rowIndex+')')) || 0;
        var vat = parseFloat(get_number('.invoice_buy_item_tax_vat_percent:eq('+rowIndex+')')) || 0;
        var imp = parseFloat(get_number('.invoice_buy_item_tax_import_percent:eq('+rowIndex+')')) || 0;
        var cost = parseFloat(get_number('.invoice_buy_item_other_cost:eq('+rowIndex+')')) || 0;
        var custom_rate = parseFloat(get_number('.invoice_buy_item_custom_rate:eq('+rowIndex+')')) || 0;

        var tien = roundDecimal(sl*price*rate,2);
        var nk = roundDecimal((price+custom)*custom_rate*sl*imp/100,0);
        var gtgt = roundDecimal((custom_rate*sl*(price+custom)+nk)*vat/100,0);

        var gt = sl*(roundDecimal(rate*price,2)+cost+custom_money)+nk;
        
        $('.invoice_buy_item_money:eq('+rowIndex+')').val(tien);
        $('.invoice_buy_item_tax_import:eq('+rowIndex+')').val(nk);
        $('.invoice_buy_item_tax_vat:eq('+rowIndex+')').val(gtgt);
        $('.invoice_buy_item_tax_total:eq('+rowIndex+')').val(nk+gtgt);

        $('.invoice_buy_item_total:eq('+rowIndex+')').val(roundDecimal(gt/sl,2));

        tongtienhang += tien;
        tongtienthuenhap += nk;
        tongtienthuevat += gtgt;
        tongchiphi += custom_money*sl;
        tongchiphi2 += cost*sl;
      });

      $('#import').html(tongtienthuenhap);
      $('#vat').html(tongtienthuevat);
      $('#cost_custom').html(tongchiphi);
      $('#cost_other').html(tongchiphi2);
      $('#money').html(tongtienhang);
      
      $('#total').html(tongtienhang+tongtienthuenhap+tongchiphi+tongchiphi2);

      $('#total').html(function(index, value) {
        return value
          .replace(/[^0-9-.]/g, "")
          .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
        ;
      });

      $('#import').html(function(index, value) {
        return value
          .replace(/[^0-9-.]/g, "")
          .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
        ;
      });

      $('#cost_custom').html(function(index, value) {
        return value
          .replace(/[^0-9-.]/g, "")
          .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
        ;
      });

      $('#cost_other').html(function(index, value) {
        return value
          .replace(/[^0-9-.]/g, "")
          .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
        ;
      });

      $('#vat').html(function(index, value) {
        return value
          .replace(/[^0-9-.]/g, "")
          .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
        ;
      });
      
      $('#money').html(function(index, value) {
        return value
          .replace(/[^0-9-.]/g, "")
          .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
        ;
      });

      $('.numbers').val(function(index, value) {
        return value
          .replace(/[^0-9-.]/g, "")
          .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
        ;
      });
      
  }
  catch(e){
      alert(e);
  }
}
</script>
<style type="text/css">
.table-container {
    min-height: 5em;
    font-size: 11px;
}
.table-container table {
    display: flex;
    flex-flow: column;
    height: 100%;
    width: 100%;
}
.table-container table thead {
    /* head takes the height it requires, 
    and it's not scaled when table is resized */
    flex: 0 0 auto;
    width: calc(100% - 0.9em);
}
.table-container table tbody {
    /* body takes all the remaining available space */
    flex: 1 1 auto;
    display: block;
    overflow-y: scroll;
}
.table-container table tbody tr {
    width: 100%;
}
.table-container table thead,
.table-container table tbody tr {
    display: table;
    table-layout: fixed;
}
/* decorations */

.table-container table {
    border: 1px solid lightgrey;
}
.table-container table td, .table-container table th {
    text-align: center;
    padding: 0;
    border: 1px solid lightgrey;
}
.table-container table th {
    border: 1px solid grey;
}
.width-3 {
    width: 3%;
}
.width-5 {
    width: 5%;
}
.width-7 {
    width: 7%;
}
.width-10 {
    width: 10%;
}
.table-container table td input{
  width: 90%;
  margin: 0;
}

.right {
    margin-left: -50px;
    height: auto;
    width: auto;
    background: rgba(0, 0, 0, 0.08);
    border: 0;
}
</style>